# iPhone実機テスト検証レポート

**日時**: 2026-01-23  
**対象**: Voice KY Assistant (Solar Aldrin)  
**検証端末**: iPhone (Safari)

---

## 🛑 検証結果の要約

**結果**: ❌ テスト失敗（アプリ画面が表示されず）
**現状**: iPhoneのSafariでアクセスしても、白い画面のままアプリが起動しない。デバッグ用の黒いコンソール画面への強制書き換えを行っても表示が変わらないことから、**強力なキャッシュ（Service Worker）による古いコンテンツの表示継続** が根本原因として極めて濃厚である。

---

## 📋 実施した検証プロセス詳細

今回実施した一連のトライアルと、その意図・結果は以下の通りです。

### 1. ローカルLAN直接接続

- **実施内容**: PCのIPアドレス `192.168.3.10:3000` へのアクセス
- **意図**: 最もシンプルで高速な接続方法
- **結果**: ❌ **接続不可** (タイムアウト)
- **原因**: ネットワーク環境（ルーター設定やプライバシーセパレータ）により、デバイス間の通信が遮断されている可能性が高い。

### 2. Localtunnelによる外部公開 (1回目)

- **実施内容**: `localtunnel` を使用してインターネット経由でPCへトンネル接続
- **結果**: ⚠️ **接続成功したが画面が白い**
- **分析**:
  - HTML/CSS/JSのファイル自体は取得できている。
  - しかし、画面描画を行うJavaScriptが途中でエラーを起こして停止している状態。
  - **推定原因**: `api.js` 内で `localhost` かどうか判定するロジックがあり、トンネル経由（`xxxx.loca.lt`）だとAPIの接続先URLが空文字になってしまっていた。

### 3. エラーハンドリング強化と再接続

- **実施内容**: `main.js` に `try-catch` を追加し、初期化エラーでもホーム画面を無理やり表示するよう修正。API接続先判定ロジックも修正。
- **結果**: ❌ **変化なし（白い画面）**
- **分析**: 修正したコードがiPhone側に反映されていない（キャッシュされている）疑いが出始める。

### 4. 画面内デバッグコンソールの埋め込み

- **実施内容**: `index.html` に、エラー内容を画面上に赤文字で表示する簡易コンソール機能を埋め込み。
- **意図**: iPhoneではブラウザの開発者ツールが見れないため、画面上にエラーを出して原因を特定したい。
- **結果**: ❌ **デバッグ画面すら表示されない**
- **分析**: HTMLを書き換えても表示が変わらないということは、**サーバーから新しいHTMLを取得できていない**。

### 5. `index.html` の完全書き換え（強制表示）

- **実施内容**: アプリの機能を全て削除し、「黒背景に文字を表示するだけ」の極めて単純なHTMLに書き換え。
- **意図**: アプリのバグなのか、キャッシュの問題なのかを切り分けるため。
- **結果**: ❌ **変化なし（白い画面のまま）**
- **確定した原因**:
  - サーバー上のファイルは確実に書き換わっている（PCでは確認済み）。
  - それでもiPhoneで表示が変わらない・白いままということは、**iPhone内のService Worker（PWAの機能）が、最初にアクセスした時の「壊れた（白い）HTML」をキャッシュし続け、それを表示し続けている**。
  - サーバーにアクセスすら行っていない状態。

---

## 🔍 技術的な詳細原因：Service Workerの罠

今回のアプリは **PWA (Progressive Web App)** として作られており、オフラインでも動くように設計されています。これが裏目に出ました。

1. **初回アクセス時**: バグのある状態のアプリがダウンロードされ、Service Workerがそれを「完全なアプリ」としてキャッシュ保存した。
2. **2回目以降**: サーバー側でいくらコードを修正しても、Service Workerは「キャッシュにある（壊れた）アプリ」を優先して表示する。
3. **通常の更新**: 通常はブラウザリロードで更新されるが、開発中の署名されていないService Workerや、localtunnelのような特殊な環境下では、更新検知がうまく働かないことが多い。

---

## ✅ 推奨される解決策

今の「白い画面」から脱出するには、以下のいずれかが必要です。

### A. iPhone側のキャッシュ完全クリア（推奨）

1. iPhoneの **設定 > Safari** を開く
2. **「履歴とWebサイトデータを消去」** を実行
   - ※注意: 他のサイトのログイン情報なども消えます
   - これが嫌な場合は、**プライベートブラウズモード** で新しいURLにアクセスしてください。

### B. 本番環境へのデプロイ

localtunnelのような不安定な環境ではなく、正式なサーバー（Cloudflare Pages）にデプロイすることで、HTTPS環境下での正しいService Workerの動作（更新チェック）が期待できます。

### C. Service Workerの無効化

開発中は `main.js` の `registerServiceWorker()` をコメントアウトし、キャッシュ機能を無効にすることで、今回のような「修正が反映されない」地獄を防げます。

---

## 📝 今後のアクションプラン

1. **Service Workerの無効化**: 開発中はキャッシュしないようにコードを修正。
2. **Cloudflareへのデプロイ**: ローカルではなく、実際のサーバー環境でテストを行う。

以上が、今回の検証結果と詳細レポートです。
