# 詳細セキュリティチェックリスト

更新日: 2026-02-07（ファイル整理：配置/ファイル名変更）

## 1. 目的と前提
本チェックリストは、以下の技術スタック一覧および詳細設計資料に基づき、Voice KY Assistant のセキュリティ項目を網羅的に確認できるよう整理したものです。

- 技術スタックとアーキテクチャ: `docs/project/core/architecture-design.md`（旧: `ARCHITECTURE_DESIGN.md`）
- 技術仕様と構成詳細: `apps/v2-modern/docs/00_planning/05_技術仕様書_Technical_Spec.md`
- システム設計（セキュリティ設計、データモデル、API構成）: `apps/v2-modern/docs/00_planning/06_システム設計書_System_Design.md`
- 詳細設計（非機能設計・エラー設計・アクセス制御）: `apps/v1-legacy/docs/01_planning/03_詳細設計書_Detailed_Design.md`

対象スタック（抜粋）: React/Vite/TypeScript、Cloudflare Pages/Workers、Hono、Zod、OpenAI GPT-4o-mini、Web Speech API、@react-pdf/renderer、Dexie.js、Zustand、Tailwind CSS など。これらは上記資料に明記されています。

---

## 2. チェックリスト（詳細）

### 2.1 ネットワーク・通信

- [ ] **HTTPS/TLSの強制**
  - **確認内容**: すべての通信が HTTPS で行われること（Cloudflare Pages/Workers の HTTPS 強制設定を確認）。
  - **想定されるエラー/原因**: HTTP 混在により中間者攻撃のリスクが増大する。設定漏れやリダイレクト未設定が原因。
  - **対策**: Cloudflare 側で HTTPS リダイレクトを必須化し、HTTP アクセスを遮断する。

- [ ] **CORS 設定の最小化**
  - **確認内容**: `hono/cors` で許可オリジンを限定しているか。
  - **想定されるエラー/原因**: 設定が `*` のままだと不要なドメインから API を呼び出される。
  - **対策**: 本番の許可オリジンのみをホワイトリスト化する。

- [ ] **レート制限の適用**
  - **確認内容**: Workers 側で IP またはユーザー単位のレート制限が有効か。
  - **想定されるエラー/原因**: レート制限未設定だと DDoS や API 乱用が可能になる。
  - **対策**: 既存のレート制限（例: 30req/min）を本番値として維持し、ログで監視する。

### 2.2 認証・認可

- [ ] **API トークンの存在と運用**
  - **確認内容**: `Bearer` トークン（環境変数 `API_TOKEN`）が必須であること。
  - **想定されるエラー/原因**: トークンが未設定・漏えいすると未認証アクセスが成立する。
  - **対策**: 本番環境で必須化し、トークンの定期ローテーションを行う。

- [ ] **将来の IDaaS 連携計画の検証**
  - **確認内容**: Auth0 や Supabase Auth 連携の設計が現状の API と衝突しないか。
  - **想定されるエラー/原因**: 認証フローの変更により既存クライアントが動作不能となる。
  - **対策**: トークン方式から移行する場合、移行期間中の二重サポートを用意する。

- [ ] **端末前提のアクセス制御に対する補強**
  - **確認内容**: MVP では端末パスコードロック前提とされているが、業務要件に耐えるか。
  - **想定されるエラー/原因**: 端末紛失時に履歴データが閲覧される。
  - **対策**: 将来のユーザー切替・リモートワイプ・認証導入を計画的に実装する。

### 2.3 秘密情報・設定管理

- [ ] **API キーの秘匿**
  - **確認内容**: OpenAI API キーなどが Git に入っていないか。
  - **想定されるエラー/原因**: `wrangler.toml` や環境変数の漏えいで第三者が API を利用できる。
  - **対策**: Cloudflare Dashboard/Workers Secrets に限定し、コミット前チェックを設ける。

- [ ] **環境変数の最小権限**
  - **確認内容**: 利用しないキー（例: Supabase など）が残っていないか。
  - **想定されるエラー/原因**: 使っていないキーが漏えいし、別システムへの侵害経路になる。
  - **対策**: 環境変数を定期棚卸しし、不要なキーを削除する。

### 2.4 入力検証・データ整合性

- [ ] **Zod によるバリデーション**
  - **確認内容**: API の入り口で Zod バリデーションが必須になっているか。
  - **想定されるエラー/原因**: バリデーション不足で不正な JSON が通過し、処理例外や情報漏えいが起きる。
  - **対策**: すべての API ルートで Zod を使用し、失敗時は統一エラーを返す。

- [ ] **音声入力のサニタイズ**
  - **確認内容**: Web Speech API からの文字起こしを信頼せず、サニタイズすること。
  - **想定されるエラー/原因**: 音声入力に悪意ある文字列が混入し、ログや画面に予期しないデータが出力される。
  - **対策**: サーバー側で入力を正規化し、表示時にエスケープする。

- [ ] **AI 応答の構造化と安全性**
  - **確認内容**: AI 応答がキーワード抽出に依存しているため、誤抽出が発生し得る。
  - **想定されるエラー/原因**: JSON ではない応答を扱うことで意図しない構造破損が起きる。
  - **対策**: JSON モード移行計画を維持し、構造化パース失敗時のフォールバックを実装する。

### 2.5 データ保護・保存

- [ ] **クライアント側永続化（IndexedDB/Dexie.js）の保護**
  - **確認内容**: オフライン保存が前提のため、端末上のデータが無防備になっていないか。
  - **想定されるエラー/原因**: 端末盗難時に IndexedDB の内容がそのまま閲覧される。
  - **対策**: 端末ロック前提を超える場合は暗号化や利用者認証を追加する。

- [ ] **PDF 生成データの扱い**
  - **確認内容**: @react-pdf/renderer によりローカルで PDF 生成されるが、保存先や共有の扱いが未統制。
  - **想定されるエラー/原因**: 端末や共有操作で PDF が無制限に拡散する。
  - **対策**: PDF 共有時の注意喚起表示や、将来の期限付き共有リンクを検討する。

- [ ] **ログや計測データの個人情報混入防止**
  - **確認内容**: 操作ログやエラーに作業者名・現場名が混入しないか。
  - **想定されるエラー/原因**: PII がログに残ると第三者閲覧時に情報漏えいが起きる。
  - **対策**: ログにはマスキングルールを設け、必要最小限のデータのみを記録する。

### 2.6 AI/LLM 利用

- [ ] **OpenAI API のデータ取り扱い方針**
  - **確認内容**: Zero Data Retention などのポリシー適用を確認しているか。
  - **想定されるエラー/原因**: 契約や設定の不備で送信データが学習に利用される。
  - **対策**: OpenAI の契約条件と API 設定を文書化し、変更時に再確認する。

- [ ] **プロンプト注入への対策**
  - **確認内容**: ユーザー入力がシステムプロンプトに干渉しないか。
  - **想定されるエラー/原因**: 指示改ざんにより不正な応答や情報漏えいが起きる。
  - **対策**: システムプロンプトを固定化し、ユーザー入力を明確に分離して送信する。

### 2.7 エラー処理・再試行

- [ ] **エラー分類とユーザー通知の明確化**
  - **確認内容**: 音声認識失敗、ネットワーク切断、AI API エラーなどのエラー分類が設計通りか。
  - **想定されるエラー/原因**: エラーが曖昧だとユーザーが再操作を繰り返し、API 乱用やデータ破損につながる。
  - **対策**: エラーごとに具体的な再試行指示を表示する。

- [ ] **再試行ポリシーの適正化**
  - **確認内容**: 最大 3 回・バックオフ付きの再試行が守られているか。
  - **想定されるエラー/原因**: 再試行無制限だとレート制限超過や二重送信が起きる。
  - **対策**: リトライ回数を固定し、失敗時はオフライン保存などに切り替える。

### 2.8 依存関係・ビルド

- [ ] **依存関係の脆弱性管理**
  - **確認内容**: React/Vite/Tailwind など主要依存関係の脆弱性を定期的に確認しているか。
  - **想定されるエラー/原因**: 既知の脆弱性が残ると外部からの攻撃が成立する。
  - **対策**: Dependabot や npm audit を運用に組み込む。

- [ ] **ビルド成果物の改ざん防止**
  - **確認内容**: Cloudflare Pages のデプロイ経路が権限管理されているか。
  - **想定されるエラー/原因**: デプロイ権限が広すぎると改ざんビルドが公開される。
  - **対策**: CI/CD の権限を最小化し、デプロイ履歴を監査可能にする。

### 2.9 監視・運用

- [ ] **監視とアラートの有効化**
  - **確認内容**: API エラー率、レート制限超過、OpenAI API エラーが監視されているか。
  - **想定されるエラー/原因**: 障害が長時間検知されず、データ欠損が発生する。
  - **対策**: Cloudflare Logs などでアラートを設計し、通知先を明確化する。

- [ ] **監査ログの保全**
  - **確認内容**: だれがいつどの API を利用したか追跡できるか。
  - **想定されるエラー/原因**: 監査ログが不足すると不正アクセスの調査が不可能になる。
  - **対策**: トークン単位でのアクセスログを保持し、保存期間を定義する。

---

## 3. 追加で確認すべき資料

- API 詳細仕様: `apps/v2-modern/docs/30_design/03_API設計_API_Design.md`
- データモデル詳細: `apps/v2-modern/docs/30_design/04_データモデル設計_Data_Model.md`
- システムアーキテクチャ詳細: `apps/v2-modern/docs/30_design/01_システムアーキテクチャ_System_Architecture.md`

上記の資料を確認し、API の認可設計、データ保持方針、運用監視の設計が具体化され次第、チェックリストに追記してください。

