# 最適化施策レポート（UX影響評価付き）

本レポートは、Voice KY Assistantのスケール対応に必要な最適化施策について、**ユーザー体験（UX）への影響**を加味して整理したものです。

更新日: 2026-02-07（ファイル整理：配置/ファイル名変更）

---

## 1. エグゼクティブサマリー

> [!IMPORTANT]
> **最適化の原則**: コスト削減や性能向上だけでなく、**ユーザー体験を向上させる方向**で実施する。

| カテゴリ | 最優先施策 | UX効果 |
|:---|:---|:---|
| **速度体感** | ストリーミング表示 | 待ち時間ゼロ感 |
| **安心感** | IndexedDB活用強化 | データ消失防止（実装済み） |
| **コスト** | 会話履歴の要約 | 速度向上＋節約 |

> [!NOTE]
> **現在の実装状況（Phase 2時点）:**
>
> - **データ保存**: クライアント側の**IndexedDB（Dexie.js）のみ**（実装済み）
> - **サーバー側DB（D1/R2）**: **未実装**（Phase 3以降で導入予定）
> - **レート制限**: Workers側で**実装済み**

---

## 2. 最適化施策一覧表

### 2.1 全施策サマリー

| 優先度 | 施策名 | カテゴリ | 工数 | 実装難度 | コスト効果 | UX影響 | 対象規模 | 採用判断 |
|:---:|:---|:---|:---:|:---:|:---:|:---:|:---:|:---:|
| 🔴 最高 | ストリーミング表示 | AI/UI | 2〜3日 | ★★★☆☆ | - | ⭐⭐⭐⭐⭐ | 全規模 | |
| 🔴 最高 | IndexedDB活用強化 | クライアント | 1〜2日 | ★★☆☆☆ | - | ⭐⭐⭐⭐⭐ | 全規模 | ✅ 実装済 |
| 🟠 高 | 会話履歴の要約 | AI | 2〜3日 | ★★★☆☆ | 30〜50%削減 | ⭐⭐⭐⭐ | 全規模 | |
| 🟠 高 | レート制限 + 予告UI | Workers | 1日 | ★★☆☆☆ | 過負荷防止 | ⭐⭐⭐⭐ | 30人〜 | ✅ 実装済 |
| 🟡 中 | リクエストキュー | Workers | 2〜3日 | ★★★☆☆ | ピーク平準化 | ⭐⭐⭐⭐ | 100人〜 | |
| 🟢 低 | プロンプト圧縮 | AI | 数時間 | ★☆☆☆☆ | 10〜20%削減 | ⭐⭐⭐ | 全規模 | |
| 🟢 低 | レスポンス簡素化 | AI | 数時間 | ★☆☆☆☆ | 20〜30%削減 | ⭐⭐⭐⭐ | 全規模 | |
| 🔵 将来 | D1バッチ化 | البيانات | 1〜2日 | ★★☆☆☆ | 負荷70%削減 | ⭐⭐⭐⭐ | 500人〜 | |

### 2.2 凡例

| 評価 | UX影響 | 実装難度 |
|:---:|:---|:---|
| ⭐⭐⭐⭐⭐ / ★★★★★ | ユーザーが「良くなった」と明確に感じる | 高度な技術知識が必要 |
| ⭐⭐⭐⭐ / ★★★★☆ | 快適性が向上、不満が減少する | やや複雑な実装 |
| ⭐⭐⭐ / ★★★☆☆ | バックエンド改善、ユーザーは気づきにくい | 標準的な難度 |
| - / ★★☆☆☆ | - | 比較的容易 |
| - / ★☆☆☆☆ | - | 簡単 |

---

## 3. 施策詳細（優先度順）

### 3.1 ストリーミング表示【🔴 最高優先】

| 項目 | 内容 |
|:---|:---|
| **概要** | AIの応答を一文字ずつリアルタイム表示する |
| **工数** | 2〜3日 |
| **実装難度** | ★★★☆☆（SSE/ReadableStreamの知識が必要） |
| **コスト効果** | なし（UX施策） |
| **UX影響** | ⭐⭐⭐⭐⭐ 体感待ち時間がゼロになる |

#### UXへの影響

| 観点 | Before | After |
|:---|:---|:---|
| 待機表示 | 「…」が2〜3秒表示 | 即座に文字が流れ始める |
| 体感速度 | 「遅い」と感じる | 「速い」と感じる |
| 離脱リスク | 待ち時間で離脱の可能性 | 最小化 |

#### ネガティブな影響

| 影響 | 内容 | 対策 |
|:---|:---|:---|
| 実装複雑化 | Workers経由のSSE実装が必要 | 段階的に実装、テスト環境で十分検証 |
| 途中切断リスク | ストリーム途中で通信断した場合のハンドリング | 再接続ロジックとフォールバック表示 |

#### 実装ポイント

- OpenAI APIの`stream: true`オプションを使用
- `ReadableStream`でチャンク単位に処理
- Workers経由でプロキシする場合はSSE（Server-Sent Events）を使用

---

### 3.2 IndexedDB活用強化【🔴 最高優先】

| 項目 | 内容 |
|:---|:---|
| **概要** | 既存のIndexedDB保存機能を活用し、通信断対策を強化 |
| **工数** | 1〜2日 |
| **実装難度** | ★★☆☆☆（基盤は実装済み、UI追加のみ） |
| **コスト効果** | なし（UX施策） |
| **UX影響** | ⭐⭐⭐⭐⭐ 現場ユーザーにとって最重要 |

> [!NOTE]
> **現在の実装状況**: IndexedDB（Dexie.js）によるローカル保存は**既に実装済み**です。

#### UXへの影響

| 観点 | Before | After |
|:---|:---|:---|
| 通信断時 | 保存済みだがユーザーに分かりにくい | 明示的に「保存済み」を表示 |
| ユーザー心理 | 不安（消えるかも） | 安心（消えない） |

#### ネガティブな影響

| 影響 | 内容 | 対策 |
|:---|:---|:---|
| ストレージ容量 | 古いデータが蓄積する | 30日以上経過したデータの自動削除（要件に合致） |
| 端末間同期なし | 複数端末でデータ共有不可 | Phase 3以降でD1導入により解決（将来施策） |

#### UX向上のための追加UI

| UI要素 | 説明 |
|:---|:---|
| オフラインバナー | 「オフラインです。入力内容は保存されています」と表示 |
| 未送信カウント | トップ画面に「未送信KY: 1件」と表示 |
| 保存インジケーター | 「自動保存済み（10秒前）」表示で安心感 |

---

### 3.3 会話履歴の要約【🟠 高優先】

| 項目 | 内容 |
|:---|:---|
| **概要** | 古い会話履歴を要約してトークン消費を削減 |
| **工数** | 2〜3日 |
| **実装難度** | ★★★☆☆（要約ロジックの設計が必要） |
| **コスト効果** | 30〜50%削減 |
| **UX影響** | ⭐⭐⭐⭐ 速度向上＋適切なUIで安心感確保 |

#### UXへの影響

| 観点 | Before | After |
|:---|:---|:---|
| 応答速度 | 会話が長くなると遅延 | 一定の速度を維持 |
| 体感 | 後半で「重い」 | 常に軽快 |

#### ネガティブな影響

| 影響 | 内容 | 対策 |
|:---|:---|:---|
| 文脈喪失 | AIが「さっき言ったこと」を忘れたように見える | 確認済み情報カードをUIに表示 |
| 要約精度 | 重要情報が要約から漏れる可能性 | 「作業内容」「危険」「対策」など必須項目を明示的に抽出 |

#### UX向上のための追加UI

| UI要素 | 説明 |
|:---|:---|
| 確認済み情報カード | 画面上に「✓ 作業内容: 足場組立」等を表示 |
| 会話の要約表示 | 「これまでの確認事項」をサイドパネルに |
| AIの前置き | 「〇〇について確認しましたね」と記憶を示す一言 |

---

### 3.4 レート制限 + 予告UI【🟠 高優先】

| 項目 | 内容 |
|:---|:---|
| **概要** | ユーザー単位で1分あたりの利用上限を設定 |
| **工数** | 1日 |
| **実装難度** | ★★☆☆☆（ミドルウェアパターンで実装可能） |
| **コスト効果** | 過負荷防止、不正利用対策 |
| **UX影響** | ⭐⭐⭐⭐ 適切なUIで不満を最小化 |

> [!NOTE]
> **現在の実装状況**: Backend側のレート制限（30回/分）は**実装済み**です。予告UIは未実装です。

#### UXへの影響

| 観点 | Before | After |
|:---|:---|:---|
| 過負荷時 | 全員が遅延/エラー | 制限ユーザーのみ待機 |
| システム安定性 | 不安定になる可能性 | 安定維持 |

#### ネガティブな影響

| 影響 | 内容 | 対策 |
|:---|:---|:---|
| 利用体験中断 | 制限に達すると一時的に使えない | 残回数表示で予告、カウントダウンで復帰タイミング明示 |
| 不公平感 | 「自分だけ制限される」と感じる可能性 | 全員共通のルールであることを説明 |

#### UX向上のための追加UI

| UI要素 | 説明 |
|:---|:---|
| 残回数表示 | 「残り3回の入力で一時停止」と警告 |
| カウントダウン | 制限時「あと30秒でご利用いただけます」 |
| プログレスバー | 復帰までの視覚的進捗 |
| 待機中の誘導 | 「PDFプレビューを確認しませんか？」 |

---

### 3.5 リクエストキュー【🟡 中優先】

| 項目 | 内容 |
|:---|:---|
| **概要** | AI呼び出しをキューで管理し、同時実行数を制御 |
| **工数** | 2〜3日 |
| **実装難度** | ★★★☆☆（キュー管理ロジックの設計が必要） |
| **コスト効果** | ピーク時のAPI呼び出しを平準化 |
| **UX影響** | ⭐⭐⭐⭐ 待ち時間を価値に変える設計で対応 |

#### UXへの影響

| 観点 | Before | After |
|:---|:---|:---|
| ピーク時 | 429エラー多発 | 順番待ちで全員利用可能 |
| エラー体験 | 「エラーです」表示 | 「順番待ち...」表示 |

#### ネガティブな影響

| 影響 | 内容 | 対策 |
|:---|:---|:---|
| 待機時間発生 | キューが長いと待たされる | 待機中のヒント表示で時間を価値に変換 |
| 順番の不透明さ | 「いつ来るか分からない」不安 | 順番表示や推定待ち時間の表示 |

#### UX向上のための追加UI

| UI要素 | 説明 |
|:---|:---|
| 状態表示の分離 | 「順番待ち...」と「考え中...」を区別 |
| 待機中のヒント | 「💡 KYのポイント: 〜かもしれない で考える」 |
| 順番表示 | 「現在2番目です」（オプション） |

---

### 3.6 プロンプト圧縮【🟢 低優先】

| 項目 | 内容 |
|:---|:---|
| **概要** | システムプロンプトを短縮してトークン削減 |
| **工数** | 数時間 |
| **実装難度** | ★☆☆☆☆（テキスト編集のみ） |
| **コスト効果** | 10〜20%削減 |
| **UX影響** | ⭐⭐⭐ 品質低下リスクあり、慎重に |

#### UXへの影響

| 観点 | Before | After |
|:---|:---|:---|
| 初回応答速度 | やや遅い | わずかに向上 |

#### ネガティブな影響

| 影響 | 内容 | 対策 |
|:---|:---|:---|
| 品質低下リスク | 指示が曖昧になりAIの応答品質が低下 | 圧縮前後で比較テスト必須 |
| 予期せぬ挙動 | 削除した指示に依存していた挙動が消える | 段階的に10%ずつ削減してテスト |

> [!WARNING]
> 圧縮しすぎるとAIの応答品質が低下する可能性があります。必ず圧縮前後で品質テストを実施してください。

---

### 3.7 レスポンスフォーマット簡素化【🟢 低優先】

| 項目 | 内容 |
|:---|:---|
| **概要** | AIの返答JSONから不要なフィールドを削減 |
| **工数** | 数時間 |
| **実装難度** | ★☆☆☆☆（プロンプト修正のみ） |
| **コスト効果** | 出力トークン20〜30%削減 |
| **UX影響** | ⭐⭐⭐⭐ ユーザーは気づかない改善 |

#### UXへの影響

| 観点 | Before | After |
|:---|:---|:---|
| 応答速度 | 現状 | わずかに向上 |

#### ネガティブな影響

なし。バックエンドのJSON構造変更であり、ユーザー体験を損なう要素はありません。

---

### 3.8 D1バッチ化【🔵 将来施策（Phase 3以降）】

| 項目 | 内容 |
|:---|:---|
| **概要** | サーバーDB（D1）導入後、複数の書き込みを1トランザクションにまとめる |
| **工数** | 1〜2日 |
| **実装難度** | ★★☆☆☆（D1のbatch APIを使用） |
| **コスト効果** | DB負荷70%削減 |
| **UX影響** | ⭐⭐⭐⭐ 保存高速化＋整合性保証 |
| **前提条件** | **D1（サーバーDB）の導入が必要** |

> [!NOTE]
> **現在の状況**: D1は未実装です。この施策はPhase 3以降でD1を導入した後に適用可能です。

#### UXへの影響（D1導入後）

| 観点 | Before | After |
|:---|:---|:---|
| 保存時間 | 複数回の通信で遅い | 1回で完了、高速 |
| データ整合性 | 途中失敗の可能性 | トランザクションで保証 |

#### ネガティブな影響

なし。バックエンドの最適化であり、ユーザー体験を損なう要素はありません。

---

## 4. 追加UX向上施策

最適化と併せて実装すると効果的なUI/UX改善を挙げます。

| 施策 | 概要 | 工数 | 実装難度 | 効果 | 採用判断 |
|:---|:---|:---:|:---:|:---|:---:|
| スケルトンローディング | 応答待ち中に「灰色の枠」を表示 | 数時間 | ★☆☆☆☆ | 待機感の軽減 | |
| 触覚フィードバック | ボタン操作時に振動 | 数時間 | ★☆☆☆☆ | 操作感向上 | |
| サウンドフィードバック | 保存成功時に「ポン」音 | 数時間 | ★☆☆☆☆ | 完了感の演出 | |
| 確認済み情報カード | 入力内容を画面上に可視化 | 1日 | ★★☆☆☆ | 安心感向上 | |
| マイクアニメーション | 録音中の波形表示を改善 | 1日 | ★★☆☆☆ | 録音感の強化 | |

---

## 5. 実装ロードマップ

### Phase 2完了〜30人（1〜2週間）

| 順序 | 施策 | 効果 | 採用判断 |
|:---:|:---|:---|:---:|
| 1 | ストリーミング表示 | 体感速度の劇的向上 | |
| 2 | IndexedDB活用強化（UI追加） | 保存状態の可視化 | ✅ 実装済 |
| 3 | 会話履歴の要約 | コスト削減＋速度向上 | |

### 30人〜100人（2〜3週間）

| 順序 | 施策 | 効果 | 採用判断 |
|:---:|:---|:---|:---:|
| 1 | レート制限 + UI | 過負荷防止 | ✅ 実装済 |
| 2 | リクエストキュー + 待機UI | ピーク平準化 | |
| 3 | 追加UX施策 | 全体的な体験向上 | |

### 100人〜（Phase 3以降）

| 順序 | 施策 | 効果 | 採用判断 |
|:---:|:---|:---|:---:|
| 1 | D1（サーバーDB）導入 | データ共有・永続化 | |
| 2 | D1バッチ化 | DB負荷削減 | |
| 3 | プロンプト圧縮（慎重に） | さらなるコスト削減 | |

---

## 6. まとめ

### 6.1 最優先で着手すべき施策

1. **ストリーミング表示**: 体感待ち時間をゼロにする最強のUX改善
2. **IndexedDB活用強化**: 既に実装済みの基盤を活かしUIで安心感向上
3. **会話履歴の要約**: コスト削減と速度向上を両立

### 6.2 成功のポイント

| ポイント | 説明 |
|:---|:---|
| UX優先 | 最適化によるUX低下は許容しない |
| 段階的実施 | 一度に全てではなく、効果を確認しながら |
| 可視化 | 待ち時間や状態をUIで明示し、不安を解消 |
| テスト | 品質テストを必ず実施してからリリース |

---

*最終更新: 2026-02-06*

