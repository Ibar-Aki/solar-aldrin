# Phase 2 Improvement Plan : Voice KY Assistant

## 🚀 ビジョン

「Voice KY Assistant」を、単なる記録ツールから**「現場の安全を守るリアルタイムパートナー」**へと進化させます。
より自然な会話体験、堅牢な運用体制、そしてチーム連携機能を強化します。

---

## 🏗️ 1. アーキテクチャ刷新 (Modernization)

現在の「Vanilla JS + 単一ファイルWorkers」構成は、初期開発速度には優れていましたが、機能拡張に伴う複雑化に耐えられません。これをモダンな構成へ移行します。

### 1.1 フロントエンドのモダン化

- **Vite + TypeScript導入**:
  - 型安全性によるバグ削減と開発体験の向上。
  - バンドル最適化によるロード時間短縮。
- **軽量フレームワーク採用 (Preact/SolidJS)**:
  - `innerHTML` 操作によるDOM管理の限界を突破。
  - コンポーネント指向による再利用性の向上。
  - Reactエコシステムの恩恵を受けつつ、軽量さを維持。

### 1.2 バックエンドの構造化 (Hono)

- **Hono (Cloudflare Workers)**:
  - 現在の `index.js` の `if` 文によるルーティングを、Honoのルーターに置き換え。
  - ミドルウェア（認証、ログ、エラーハンドリング）の共通化。
  - 型安全なAPI定義 (RPCモードの検討)。

---

## ⚡ 2. ユーザー体験の革新 (UX Revolution)

「待たされる」「機械的」な体験を排除し、人間と話しているようなスムーズさを実現します。

### 2.1 AI応答のストリーミング (Streaming Response)

- **Server-Sent Events (SSE)**:
  - AIが考えながら文字を出力するように変更。
  - 「待ち時間ゼロ」のような体感速度を実現。
  - **効果**: 現場でのイライラを解消。

### 2.2 リアルタイム音声対話 (Realtime API)

- **OpenAI Realtime API (WebSockets)**:
  - テキスト変換（STT/TTS）を挟まず、音声to音声で直接対話。
  - ユーザーの割り込み（話している途中で遮る）が可能に。
  - 感情やトーンの認識。
  - **効果**: 「トランシーバーで話している」感覚から「隣の人と話している」感覚へ。

---

## 🛡️ 3. 安全性と信頼性 (Enterprise Ready)

個人の実験アプリから、組織が利用できるプロダクトへ。

### 3.1 ユーザー認証と組織管理

- **認証基盤**:
  - Supabase Auth または Cloudflare Access の導入。
  - 「誰が記録したか」の証跡管理。
- **チーム機能**:
  - 現場ごとのメンバー管理。
  - 管理者ダッシュボード（全現場のKY実施状況を一覧表示）。

### 3.2 堅牢なエラー監視

- **Sentry導入**:
  - 現場で起きたクラッシュや通信エラーを即座に検知。
  - ユーザー環境（OS、ブラウザバージョン）の特定。

---

## 📅 ロードマップ案

| Phase | 期間 (目安) | 主な実施内容 |
| :--- | :--- | :--- |
| **Phase 2.0** | 1ヶ月 | **基盤刷新**: Vite + TypeScript + Hono への移行 |
| **Phase 2.1** | 2週間 | **UX改善**: AI応答のストリーミング化 (SSE) |
| **Phase 2.2** | 1ヶ月 | **認証・DB**: ユーザー認証、過去ログ閲覧機能 |
| **Phase 2.3** | 未定 | **Realtime**: OpenAI Realtime API検証・導入 |

---

## 📝 技術的負債の解消 (Refactoring)

Phase 2への移行前に、以下の負債を解消することを推奨します。

1. **グローバル汚染の排除**: `window.API` や `window.AppState` をモジュールインポートへ。
2. **型定義**: `JSDoc` から `.ts` 型定義ファイルへ。
3. **テスト自動化**: PlaywrightによるE2Eテスト導入（「対話→PDF生成」フローの自動テスト）。

---

この計画により、アプリケーションは長期的にメンテナンス可能で、かつユーザーにとって魅力的なプロダクトへと成長します。
