# Phase 2.1 機能判定シート (Decision Matrix)

**目的**: Phase 2.1 で実装する機能の詳細を整理し、要否判定の材料とする。

---

## 📍 Phase 2.1 の位置づけ

ロードマップ (`03_Phase2ロードマップ`) における Phase 2.1 の定義：

> **運用防御とコスト制御**  
> 公開APIの濫用を防ぎ、不正/暴走リクエストを遮断する。

つまり、Phase 2.1 は **セキュリティ・運用安定性** にフォーカスしたフェーズであり、UX機能は Phase 2.2 以降に先送りされています。

---

## 🔐 Phase 2.1 機能一覧（詳細）

### SEC-01: レート制限 (Rate Limiting)

| 項目 | 内容 |
| :--- | :--- |
| **概要** | 同一IP/Originからの過剰なAPIリクエストを遮断する |
| **技術実装** | Cloudflare Workers KV または Durable Objects を使用したカウンター実装 |
| **想定ルール** | 1分あたり30リクエストを上限（超過時は429 Too Many Requests） |
| **実装コスト** | 低（既存ミドルウェア構成に追加） |
| **リスク** | 正規ユーザーが誤ってブロックされる可能性（しきい値調整が必要） |
| **判定案** | ✅ **採用**（必須）- DDoS/コスト暴騰対策として最優先 → **[実装済]** |

---

### SEC-02: Origin Allowlist 強化

| 項目 | 内容 |
| :--- | :--- |
| **概要** | 許可されたOrigin以外からのAPIアクセスを拒否する |
| **現状** | Hono CORS設定で基本的な制限は実装済み |
| **追加対応** | 環境変数による動的Origin管理、エラーログの詳細化 |
| **実装コスト** | 極低（設定変更レベル） |
| **リスク** | 開発環境 (localhost) のアクセスが誤ってブロックされる可能性 |
| **判定案** | ✅ **採用**（必須）- 既存機能の強化であり追加コストはほぼゼロ → **[実装済]** |

---

### SEC-03: 入力検証 (Input Validation)

| 項目 | 内容 |
| :--- | :--- |
| **概要** | APIリクエストの入力値を厳格にチェックし、不正なデータを排除する |
| **現状** | Zodによるスキーマ検証は Phase 2.0 で導入済み |
| **追加対応** | 以下の検証ルールを追加 |
| | - **入力長制限**: メッセージ1件あたり最大1000文字 |
| | - **禁止語フィルター**: 暴力的/差別的な表現のブロック（正規表現） |
| | - **ロール制限**: `system` ロールの直接入力を禁止（プロンプトインジェクション対策） |
| **実装コスト** | 低（Zodスキーマへの条件追加） |
| **リスク** | 過剰なフィルターで正規入力がブロックされる可能性（ホワイトリスト調整必要） |
| **判定案** | ✅ **採用**（必須）- プロンプトインジェクション対策として重要 → **[実装済]** |

---

### SEC-04: APIキー管理の強化

| 項目 | 内容 |
| :--- | :--- |
| **概要** | OpenAI APIキーの安全な管理 |
| **現状** | `wrangler secret` で環境変数として管理（クライアント非露出） |
| **追加対応** | |
| | - **キーローテーション手順書の整備** |
| | - ~~利用量アラートの設定（OpenAIダッシュボードで月額上限設定）~~ (非採用: 効果薄) |
| | - ~~(オプション) Azure OpenAI / Anthropic へのフォールバック準備~~ (非採用: 過剰品質) |
| **実装コスト** | 極低（運用手順書の作成） |
| **リスク** | なし |
| **判定案** | ✅ **採用**（手順書のみ） → **[作成済]** (`docs/10_manuals/03_OPS_GUIDE.md`) |

---

### SEC-05: APIコスト監視・アラート

| 項目 | 内容 |
| :--- | :--- |
| **概要** | OpenAI API利用量を監視し、異常を検知した場合にアラートを発報する |
| **実装案** | |
| | - OpenAI Usage API を定期的にポーリングし、閾値超過時に通知 |
| **実装コスト** | 中（監視インフラの構築が必要） |
| **リスク** | 監視ツールへの依存が増える、構築コスト過大 |
| **判定案** | ❌ **非採用**（2026-01-27 判断）- 手動チェックで十分 |

---

## 📊 判定サマリ (2026-01-27 確定)

| ID | 機能名 | 判定 | 状態 | 理由 |
| :--- | :--- | :--- | :--- | :--- |
| SEC-01 | レート制限 | ✅ 採用 | **実装済** | DDoS/コスト暴騰対策の最優先事項 |
| SEC-02 | Origin Allowlist強化 | ✅ 採用 | **実装済** | 既存機能の強化、追加コストほぼゼロ |
| SEC-03 | 入力検証 | ✅ 採用 | **実装済** | プロンプトインジェクション対策 |
| SEC-04 | 鍵管理強化 | ✅ 採用 | **作成済** | キーローテーション手順のみ採用 |
| SEC-05 | コスト監視 | ❌ 非採用 | - | 実装コストに対し効果が薄い、手動で十分 |

---

## ✅ 結論

Phase 2.1 は以下の **3.5機能** に絞って実装を進める。

1. **SEC-01**: レート制限
2. **SEC-02**: Origin Allowlist
3. **SEC-03**: 入力検証
4. **SEC-04**: キーローテーション手順書（ドキュメントのみ）
