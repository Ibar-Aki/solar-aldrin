# 🔧 詳細設計書

**プロジェクト名**: Voice KY Assistant  
**バージョン**: 1.0（MVP版）  
**作成日**: 2026年1月21日

---

## 1. システムアーキテクチャ

### 1.1 全体構成図

```
┌─────────────────────────────────────────────────────────────────┐
│                        クライアント層                           │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                 iPhone SE (Safari PWA)                    │  │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐  │  │
│  │  │ UI Layer    │ │ Audio Layer │ │ Storage Layer       │  │  │
│  │  │ ・HTML/CSS  │ │ ・Web Speech│ │ ・IndexedDB         │  │  │
│  │  │ ・React/Vue │ │   API       │ │ ・LocalStorage      │  │  │
│  │  │  (Option)   │ │ ・AudioCtx  │ │                     │  │  │
│  │  └─────────────┘ └─────────────┘ └─────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │ HTTPS
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        サーバー層（Edge）                        │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │               Cloudflare Workers / Vercel Edge            │  │
│  │  ┌─────────────────┐ ┌─────────────────┐                  │  │
│  │  │ /api/chat       │ │ /api/weather    │                  │  │
│  │  │ AI対話処理      │ │ 天候取得        │                  │  │
│  │  └────────┬────────┘ └────────┬────────┘                  │  │
│  │           │                    │                          │  │
│  └───────────┼────────────────────┼──────────────────────────┘  │
└──────────────┼────────────────────┼─────────────────────────────┘
               │                    │
               ▼                    ▼
┌──────────────────────┐  ┌──────────────────────┐
│  OpenAI API          │  │  OpenWeatherMap      │
│  GPT-4o-mini         │  │  Free Tier           │
└──────────────────────┘  └──────────────────────┘

               │
               ▼（非同期）
┌─────────────────────────────────────────────────────────────────┐
│                        データ層                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                     Supabase                              │  │
│  │  ┌─────────────────┐ ┌─────────────────┐                  │  │
│  │  │ ky_records      │ │ conversation_    │                  │  │
│  │  │ テーブル        │ │ logs テーブル   │                  │  │
│  │  └─────────────────┘ └─────────────────┘                  │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 技術選定理由

| 要素 | 選定技術 | 理由 |
|------|----------|------|
| フロントエンド | Vanilla JS + PWA | シンプル、軽量、オフライン対応 |
| バックエンド | Cloudflare Workers | 無料枠、低レイテンシ、Edge実行 |
| AI | OpenAI GPT-4o-mini | コスト最適、十分な性能 |
| DB | Supabase | 無料枠、REST API、リアルタイム |
| 天候API | OpenWeatherMap | 無料枠、シンプル |

---

## 2. コンポーネント設計

### 2.1 フロントエンド構成

```
src/
├── index.html              # エントリーポイント
├── manifest.json           # PWA設定
├── sw.js                   # Service Worker
├── css/
│   └── style.css           # 全スタイル
├── js/
│   ├── app.js              # メインアプリケーション
│   ├── speech.js           # 音声認識・合成
│   ├── api.js              # API通信
│   ├── storage.js          # ローカルストレージ
│   ├── pdf.js              # PDF生成
│   └── ui.js               # UI操作
└── assets/
    └── icons/              # PWAアイコン
```

### 2.2 コンポーネント責務

| コンポーネント | 責務 |
|----------------|------|
| `app.js` | 画面遷移制御、状態管理、イベントハンドリング |
| `speech.js` | Web Speech APIのラッパー、音声認識・合成 |
| `api.js` | バックエンドAPI呼び出し、エラーハンドリング |
| `storage.js` | IndexedDB/LocalStorage操作、オフライン対応 |
| `pdf.js` | jsPDFを使用したPDF生成 |
| `ui.js` | DOM操作、アニメーション、フィードバック表示 |

---

## 3. API設計

### 3.1 エンドポイント一覧

| メソッド | パス | 説明 |
|----------|------|------|
| POST | `/api/chat` | AI対話（メッセージ送信・応答取得） |
| POST | `/api/advice` | KYアドバイス生成 |
| GET | `/api/weather` | 天候情報取得 |
| POST | `/api/records` | KY記録保存 |
| GET | `/api/records` | KY記録一覧取得 |
| GET | `/api/records/:id` | KY記録詳細取得 |

### 3.2 API詳細

#### POST /api/chat

AI対話エンジンとのメッセージ交換。

**Request:**

```json
{
  "sessionId": "uuid",
  "message": "落ちるかもしれない",
  "context": {
    "workType": "scaffold_installation",
    "weather": {
      "condition": "晴れ",
      "temperature": 5,
      "windSpeed": 3
    },
    "conversationHistory": [
      {"role": "assistant", "content": "今日は晴れですね..."},
      {"role": "user", "content": "はい"}
    ]
  }
}
```

**Response:**

```json
{
  "message": "どの作業の時に落ちそうですか？もう少し具体的に教えてください",
  "phase": "hazard_detail",
  "isComplete": false,
  "extractedData": {
    "hazards": ["落ちる"],
    "countermeasures": [],
    "actionGoal": null
  }
}
```

**フェーズ定義:**

| phase | 説明 |
|-------|------|
| `greeting` | 挨拶・開始 |
| `hazard_identification` | 危険の洗い出し |
| `hazard_detail` | 危険の具体化 |
| `additional_hazards` | 追加危険確認 |
| `countermeasures` | 対策確認 |
| `action_goal` | 行動目標設定 |
| `complete` | 完了 |

#### POST /api/advice

KY内容を評価しアドバイスを生成。

**Request:**

```json
{
  "workType": "scaffold_installation",
  "weather": {
    "condition": "晴れ",
    "windSpeed": 5
  },
  "hazards": ["布板設置時に落ちる"],
  "countermeasures": ["安全帯をかける"],
  "actionGoal": "安全帯ヨシ！"
}
```

**Response:**

```json
{
  "advices": [
    {
      "type": "improvement",
      "message": "風が強いです。資材の落下リスクも考えてみましょう"
    },
    {
      "type": "praise",
      "message": "具体的な危険が挙げられていてGoodです！"
    }
  ]
}
```

#### GET /api/weather

天候情報を取得。

**Request:**

```
GET /api/weather?lat=35.6762&lon=139.6503
```

**Response:**

```json
{
  "condition": "晴れ",
  "temperature": 5,
  "windSpeed": 3,
  "humidity": 45,
  "description": "快晴"
}
```

---

## 4. データベース設計

### 4.1 テーブル定義

#### ky_records

| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| created_at | TIMESTAMP | 作成日時 |
| work_type | VARCHAR(50) | 作業種別 |
| weather_condition | VARCHAR(20) | 天候 |
| weather_temperature | INTEGER | 気温 |
| weather_wind_speed | INTEGER | 風速 |
| hazards | JSONB | 危険項目配列 |
| countermeasures | JSONB | 対策配列 |
| action_goal | TEXT | 行動目標 |
| duration_seconds | INTEGER | 所要時間 |
| device_id | VARCHAR(100) | 端末識別子（任意） |

#### conversation_logs

| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| ky_record_id | UUID | 外部キー |
| role | VARCHAR(20) | assistant/user |
| content | TEXT | メッセージ内容 |
| created_at | TIMESTAMP | 発言日時 |

### 4.2 インデックス

```sql
CREATE INDEX idx_ky_records_created_at ON ky_records(created_at DESC);
CREATE INDEX idx_conversation_logs_ky_record_id ON conversation_logs(ky_record_id);
```

---

## 5. 画面設計詳細

### 5.1 画面一覧

| 画面ID | 画面名 | パス |
|--------|--------|------|
| SCR-01 | ホーム | `/` |
| SCR-02 | 作業選択 | `/select` |
| SCR-03 | AI対話 | `/chat` |
| SCR-04 | 確認 | `/confirm` |
| SCR-05 | 完了 | `/complete` |
| SCR-06 | 履歴一覧 | `/history` |
| SCR-07 | 履歴詳細 | `/history/:id` |

### 5.2 画面遷移図

```
[SCR-01: ホーム]
       │
       ├──「KY開始」──→ [SCR-02: 作業選択]
       │                      │
       │                      └──「足場設置」──→ [SCR-03: AI対話]
       │                                              │
       │                                              └──（対話完了）──→ [SCR-04: 確認]
       │                                                                    │
       │                                                           ┌────────┴────────┐
       │                                                           │                  │
       │                                                      「修正」           「完了」
       │                                                           │                  │
       │                                                           ▼                  ▼
       │                                              [SCR-03に戻る]     [SCR-05: 完了]
       │
       └──「履歴を見る」──→ [SCR-06: 履歴一覧]
                                │
                                └──（タップ）──→ [SCR-07: 履歴詳細]
```

### 5.3 各画面要素詳細

#### SCR-03: AI対話画面

| 要素 | 仕様 |
|------|------|
| ヘッダー | 作業名表示、戻るボタン（確認付き） |
| 対話ログ | スクロール可能、最新を下部に表示 |
| マイクボタン | 押下でON/OFF切り替え、視覚フィードバック |
| 認識テキスト | リアルタイム表示、確定後に送信 |
| テキスト入力欄 | フォールバック用、常時表示 |
| 進捗インジケータ | 現在のフェーズを視覚的に表示 |

---

## 6. シーケンス図

### 6.1 KY実施フロー

```
User          Browser         Worker         OpenAI        WeatherAPI    Supabase
 │               │               │               │               │           │
 │──(1)アプリ起動──→│               │               │               │           │
 │               │               │               │               │           │
 │──(2)KY開始────→│               │               │               │           │
 │               │──(3)位置情報取得→│              │               │           │
 │               │               │──(4)天候API───→│               │           │
 │               │               │←─天候データ────│               │           │
 │               │←─天候表示─────│               │               │           │
 │               │               │               │               │           │
 │──(5)音声入力──→│               │               │               │           │
 │               │──(6)テキスト変換               │               │           │
 │               │──(7)チャットAPI→│              │               │           │
 │               │               │──(8)GPT呼出──→│               │           │
 │               │               │←─応答─────────│               │           │
 │               │←─AI応答表示───│               │               │           │
 │               │──(9)TTS再生──→│               │               │           │
 │               │               │               │               │           │
 │    ... (対話繰り返し) ...      │               │               │           │
 │               │               │               │               │           │
 │──(10)対話完了──→│              │               │               │           │
 │               │──(11)アドバイスAPI→│           │               │           │
 │               │               │──(12)GPT呼出─→│               │           │
 │               │               │←─アドバイス───│               │           │
 │               │←─確認画面表示─│               │               │           │
 │               │               │               │               │           │
 │──(13)完了────→│               │               │               │           │
 │               │──(14)PDF生成──│               │               │           │
 │               │──(15)記録保存API→│              │               │           │
 │               │               │──(16)INSERT──→│               │           │
 │               │               │←─OK───────────│               │           │
 │               │←─完了画面────│               │               │           │
 │               │               │               │               │           │
```

### 6.2 音声認識フロー

```
User          Browser(Speech)    app.js         ui.js
 │                  │               │              │
 │──(1)マイクボタン押下──────────────→│              │
 │                  │               │──(2)開始表示→│
 │                  │←─(3)startRecognition         │
 │──(4)発話──────────→│              │              │
 │                  │──(5)interim result→│         │
 │                  │               │──(6)仮表示──→│
 │──(7)発話終了──────→│              │              │
 │                  │──(8)final result──→│         │
 │                  │               │──(9)確定表示→│
 │                  │               │──(10)API送信→│
 │                  │               │              │
```

---

## 7. AI対話設計（プロンプト詳細）

### 7.1 システムプロンプト構成

```
┌─────────────────────────────────────────────────────────────────┐
│                     システムプロンプト                          │
├─────────────────────────────────────────────────────────────────┤
│ [1. ペルソナ定義]                                               │
│   - 役割：新人記録係（親方の相棒）                              │
│   - トーン：敬語、ポジティブ、謙虚                              │
│                                                                 │
│ [2. 対話ルール]                                                 │
│   - 1発話50文字以内                                             │
│   - 専門用語を避ける                                            │
│   - 否定しない                                                  │
│                                                                 │
│ [3. 対話フロー]                                                 │
│   - フェーズ定義と遷移条件                                      │
│                                                                 │
│ [4. コンテキスト情報]                                           │
│   - 作業種別                                                    │
│   - 天候情報                                                    │
│   - 時間帯                                                      │
│                                                                 │
│ [5. 参照情報]                                                   │
│   - 足場設置の典型的危険リスト                                  │
│                                                                 │
│ [6. 出力形式]                                                   │
│   - JSON形式での応答                                            │
└─────────────────────────────────────────────────────────────────┘
```

### 7.2 対話プロンプト全文

```text
あなたは「KY記録くん」という名前の建設現場アシスタントです。
親方（作業員）のKY活動を手伝う新人記録係として振る舞います。

【ペルソナ】
- 真面目で勉強熱心な新人
- 「教えてください」「記録しますね」という姿勢
- 決して上から目線にならない
- 良い回答には「さすがです！」と褒める

【対話ルール】
- 1回の発話は50文字以内
- 専門用語は使わない（「墜落」→「落ちる」）
- 否定形は使わない（「〜ではダメ」→「〜の方がいいですね」）
- 相槌を入れる（「なるほど」「そうですね」「いいですね」）

【対話の流れ】
1. 挨拶と天候確認
2. 危険の洗い出し（抽象的なら深掘り）
3. 他の危険確認
4. 対策確認（抽象的なら深掘り）
5. 合言葉設定
6. 完了挨拶

【今日の情報】
- 作業: {{work_type}}
- 天候: {{weather_condition}}、気温{{temperature}}℃、風速{{wind_speed}}m/s
- 時間帯: {{time_of_day}}

【足場設置の典型的危険（参考）】
- 墜落・転落（布板設置時、昇降時）
- 落下物（資材、工具の落下）
- 倒壊（壁つなぎ不足）
- 気象条件（強風、雨で滑る）

【出力形式】
JSON形式で以下を返してください：
{
  "message": "発話内容",
  "phase": "現在のフェーズ",
  "isComplete": false,
  "extractedData": {
    "hazards": ["抽出した危険"],
    "countermeasures": ["抽出した対策"],
    "actionGoal": "合言葉"
  }
}
```

### 7.3 アドバイス生成プロンプト

```text
あなたはKY活動の品質アドバイザーです。
作業員が行ったKYの内容を評価し、より良くするためのヒントを1-2個提供してください。

【評価対象】
- 作業: {{work_type}}
- 天候: {{weather_condition}}、風速{{wind_speed}}m/s
- 危険項目: {{hazards}}
- 対策: {{countermeasures}}
- 合言葉: {{action_goal}}

【評価観点】
1. 具体性：「落ちる」より「布板設置時に足を滑らせて落ちる」
2. 網羅性：複数の視点で危険を考えているか
3. 対策の実行可能性：「気をつける」は曖昧
4. 天候の考慮：今日の天候を踏まえているか

【アドバイスのルール】
- 否定しない、ポジティブな提案
- 1つ30文字以内
- 具体的な改善行動を示す
- 良いKYなら褒める

【出力形式】
[{"type": "improvement"|"praise", "message": "..."}]
```

---

## 8. エラーハンドリング

### 8.1 エラー分類

| カテゴリ | エラー例 | 対応 |
|----------|----------|------|
| 音声認識 | マイク権限拒否、認識失敗 | テキスト入力モードへ誘導 |
| ネットワーク | オフライン、API タイムアウト | ローカルキャッシュ、リトライ |
| AI API | レート制限、サービス障害 | フォールバックメッセージ、リトライ |
| 天候API | 位置情報拒否、API障害 | 天候なしで続行 |

### 8.2 ユーザーへのフィードバック

```javascript
const ERROR_MESSAGES = {
  MICROPHONE_DENIED: "マイクが使えません。文字入力で続けますか？",
  SPEECH_ERROR: "音声を聞き取れませんでした。もう一度お願いします",
  NETWORK_ERROR: "通信できません。電波の良い場所でお試しください",
  AI_ERROR: "AIからの応答がありません。少し待ってから再度お試しください",
  WEATHER_ERROR: "天候情報を取得できませんでした。続行します"
};
```

---

## 9. セキュリティ設計

### 9.1 通信セキュリティ

| 対策 | 実装 |
|------|------|
| HTTPS強制 | Cloudflare自動対応 |
| CORS設定 | 許可オリジン制限 |
| APIキー隠蔽 | バックエンドで管理 |

### 9.2 データ保護

| 対策 | 実装 |
|------|------|
| 位置情報 | 天候取得時のみ使用、保存しない |
| 対話ログ | 暗号化なし（機微情報なし前提） |
| アクセス制御 | 端末パスコードを前提 |

---

## 10. パフォーマンス設計

### 10.1 目標値

| 指標 | 目標 | 測定方法 |
|------|------|----------|
| 初期表示 | 2秒以内 | Lighthouse |
| 音声認識開始 | 1秒以内 | 実測 |
| AI応答 | 3秒以内 | API計測 |
| PDF生成 | 2秒以内 | 実測 |

### 10.2 最適化手法

| 手法 | 適用箇所 |
|------|----------|
| PWA + Service Worker | オフラインキャッシュ |
| ストリーミングレスポンス | AI応答の逐次表示 |
| 遅延読み込み | jsPDFは完了画面で読み込み |
| 非同期保存 | KY記録は完了後にバックグラウンド送信 |

---

## 改訂履歴

| Ver | 日付 | 変更内容 |
|-----|------|----------|
| 1.0 | 2026/01/21 | 初版作成 |

---

**承認欄**

| 役職 | 氏名 | 日付 | 承認 |
|------|------|------|------|
| プロジェクトオーナー | | | |
