# 📐 Voice KY Assistant 詳細設計書 v2

**バージョン**: 2.0  
**作成日**: 2026年1月21日  
**対象**: MVP（足場設置 × 一人KY）

---

## 目次

1. [設計方針](#1-設計方針)
2. [システム構成](#2-システム構成)
3. [フロントエンド設計](#3-フロントエンド設計)
4. [バックエンド設計](#4-バックエンド設計)
5. [データ設計](#5-データ設計)
6. [AI対話エンジン設計](#6-ai対話エンジン設計)
7. [画面仕様](#7-画面仕様)
8. [処理フロー](#8-処理フロー)
9. [エラー設計](#9-エラー設計)
10. [非機能設計](#10-非機能設計)

---

## 1. 設計方針

### 1.1 基本原則

| 原則 | 説明 |
|------|------|
| **シンプルさ優先** | 初回リリースは最小構成。複雑さを避ける |
| **音声 + テキスト** | 音声認識失敗時のフォールバックを常に用意 |
| **オフライン耐性** | ネットワーク断でもデータ消失しない |
| **低コスト** | 無料枠・最安構成を選択 |

### 1.2 技術選定

| 領域 | 技術 | 選定理由 |
|------|------|----------|
| フロントエンド | Vanilla JS + PWA | 軽量、依存なし、オフライン対応 |
| 音声認識 | Web Speech API | ブラウザ標準、追加コストなし |
| バックエンド | Cloudflare Workers | 無料枠10万リクエスト/日、Edge実行 |
| AI | OpenAI GPT-4o-mini | 安価かつ高速 |
| DB | Supabase Free | PostgreSQL、REST API付き |
| 天候 | OpenWeatherMap Free | 1000回/日無料 |

---

## 2. システム構成

### 2.1 全体アーキテクチャ

```
┌────────────────────────────────────────────────────────────┐
│                      iPhone SE (Safari)                    │
│  ┌──────────────────────────────────────────────────────┐  │
│  │                      PWA                              │  │
│  │   ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐    │  │
│  │   │  UI    │  │ Speech │  │Storage │  │  PDF   │    │  │
│  │   │ Module │  │ Module │  │ Module │  │ Module │    │  │
│  │   └────────┘  └────────┘  └────────┘  └────────┘    │  │
│  └──────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────────────┘
                            │
                            │ HTTPS
                            ▼
┌────────────────────────────────────────────────────────────┐
│                  Cloudflare Workers (Edge)                 │
│   ┌────────────┐  ┌────────────┐  ┌────────────┐          │
│   │ /api/chat  │  │/api/advice│  │/api/weather│          │
│   └─────┬──────┘  └─────┬──────┘  └─────┬──────┘          │
│         │             │             │                      │
│   ┌────────────┐                  ┌────────────┐          │
│   │/api/records│                  │ /api/sync  │          │
│   └─────┬──────┘                  └─────┬──────┘          │
└─────────┼─────────────┼─────────────┼──────────────────────┘
          │             │             │
          ▼             ▼             ▼
   ┌────────────┐  ┌────────────┐  ┌────────────┐
   │  OpenAI    │  │OpenWeather │  │  Supabase  │
   │  API       │  │    Map     │  │  (DB)      │
   └────────────┘  └────────────┘  └────────────┘
```

### 2.2 通信フロー

1. **ユーザー → PWA**: 音声入力 or テキスト入力
2. **PWA → Workers**: API呼び出し（HTTPS）
3. **Workers → OpenAI**: AI対話リクエスト
4. **Workers → Supabase**: 記録保存（非同期）
5. **PWA**: PDF生成（クライアントサイド）

---

## 3. フロントエンド設計

### 3.1 ディレクトリ構成

```
public/
├── index.html          # SPA エントリーポイント
├── manifest.json       # PWA マニフェスト
├── sw.js               # Service Worker
├── css/
│   ├── reset.css       # リセットCSS
│   └── app.css         # アプリスタイル
├── js/
│   ├── main.js         # エントリーポイント
│   ├── router.js       # 画面遷移
│   ├── state.js        # 状態管理
│   ├── speech.js       # 音声認識・合成
│   ├── api.js          # API通信
│   ├── storage.js      # ローカル永続化
│   ├── pdf.js          # PDF生成
│   └── screens/
│       ├── home.js     # ホーム画面
│       ├── chat.js     # 対話画面
│       ├── confirm.js  # 確認画面
│       └── history.js  # 履歴画面
└── assets/
    └── icons/          # PWAアイコン (192x192, 512x512)
```

### 3.2 状態管理

```javascript
// state.js
const AppState = {
  // 現在のセッション
  session: {
    id: null,
    workType: null,
    weather: null,
    startTime: null
  },
  
  // 対話データ
  conversation: {
    messages: [],      // [{role, content, timestamp}]
    phase: 'greeting', // 現在のフェーズ
    extractedData: {
      hazards: [],
      countermeasures: [],
      actionGoal: null
    }
  },
  
  // UI状態
  ui: {
    isListening: false,
    isProcessing: false,
    error: null
  }
};
```

### 3.3 Service Worker戦略

| リソース | キャッシュ戦略 |
|----------|----------------|
| HTML/CSS/JS | Cache First（更新時にプリキャッシュ） |
| API応答 | Network First（オフライン時はキャッシュ） |
| 対話データ | IndexedDB保存 → オンライン時に同期 |

---

## 4. バックエンド設計

### 4.1 API一覧

| エンドポイント | メソッド | 説明 |
|----------------|----------|------|
| `/api/chat` | POST | AI対話メッセージ送信 |
| `/api/advice` | POST | KYアドバイス生成 |
| `/api/weather` | GET | 天候情報取得 |
| `/api/records` | POST | KY記録保存 |
| `/api/records` | GET | KY記録一覧 |
| `/api/sync` | POST | オフラインデータ同期 |
| `/api/health` | GET | ヘルスチェック |

### 4.2 POST /api/chat 詳細

**リクエスト**

```json
{
  "sessionId": "550e8400-e29b-41d4-a716-446655440000",
  "message": "落ちるかもしれない",
  "context": {
    "workType": "scaffold",
    "weather": {"condition": "晴れ", "temp": 8, "wind": 5},
    "history": [
      {"role": "assistant", "content": "今日は晴れですね。"},
      {"role": "user", "content": "はい"}
    ]
  }
}
```

**レスポンス**

```json
{
  "reply": "どの作業の時に落ちそうですか？",
  "phase": "hazard_detail",
  "done": false,
  "data": {
    "hazards": ["落ちる"],
    "countermeasures": [],
    "goal": null
  }
}
```

### 4.3 対話フェーズ

| フェーズ | 説明 | 遷移条件 |
|----------|------|----------|
| `greeting` | 挨拶・導入 | 自動遷移 |
| `hazard_main` | 危険の洗い出し | ユーザー回答あり |
| `hazard_detail` | 危険の具体化 | 具体的な危険が抽出できた |
| `hazard_more` | 追加確認 | なければ次へ |
| `counter` | 対策確認 | 対策が抽出できた |
| `goal` | 合言葉設定 | 合言葉が入力された |
| `done` | 完了 | 終了 |

---

## 5. データ設計

### 5.1 KY記録スキーマ

```sql
CREATE TABLE ky_records (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  created_at TIMESTAMPTZ DEFAULT now(),
  
  -- 作業情報
  work_type TEXT NOT NULL,
  
  -- 天候
  weather_condition TEXT,
  weather_temp INTEGER,
  weather_wind INTEGER,
  
  -- KY内容
  hazards JSONB NOT NULL DEFAULT '[]',
  countermeasures JSONB NOT NULL DEFAULT '[]',
  action_goal TEXT,
  
  -- メタ
  duration_sec INTEGER,
  advice JSONB,
  
  -- 監査対応項目（PDF印刷後に追記前提）
  site_name TEXT,                    -- 現場名
  worker_name TEXT,                  -- 作業員名（任意）
  confirmed_by TEXT,                 -- 確認者名（任意）
  device_id TEXT,                    -- 端末識別子
  
  -- 同期状態
  sync_status TEXT DEFAULT 'pending' -- pending / synced / failed
);
```

> ⚠️ **監査要件について**: `worker_name`, `confirmed_by`はMVPでは任意欄。PDF印刷後に手書きで追記する運用を前提とする。

### 5.2 対話ログスキーマ

```sql
CREATE TABLE chat_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  record_id UUID REFERENCES ky_records(id) ON DELETE CASCADE,
  seq INTEGER NOT NULL,
  role TEXT NOT NULL CHECK (role IN ('user', 'assistant')),
  content TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT now()
);
```

### 5.3 ローカルストレージ構造

```javascript
// IndexedDB: ky_draft
{
  "sessionId": "uuid",
  "startTime": "2026-01-21T08:00:00+09:00",
  "workType": "scaffold",
  "siteName": "○○ビル新築工事",
  "weather": {...},
  "messages": [...],
  "extractedData": {...},
  "syncStatus": "pending",  // pending / syncing / synced / failed
  "syncAttempts": 0,
  "lastSyncError": null
}
```

### 5.4 オフライン同期設計

| 項目 | 仕様 |
|------|------|
| **保存タイミング** | KY完了時にIndexedDBに即時保存 |
| **同期タイミング** | オンライン復帰時 + アプリ起動時 |
| **リトライ** | 最大3回、指数バックオフ（1s, 2s, 4s） |
| **競合解決** | クライアント優先（サーバの既存データを上書き） |
| **失敗時** | `syncStatus: failed`にし、次回起動時に再試行 |

```javascript
// sync.js
async function syncPendingRecords() {
  const pending = await db.getAll('ky_draft', { syncStatus: 'pending' });
  for (const record of pending) {
    try {
      await api.post('/api/sync', record);
      await db.update('ky_draft', record.id, { syncStatus: 'synced' });
    } catch (err) {
      await db.update('ky_draft', record.id, {
        syncStatus: 'failed',
        syncAttempts: record.syncAttempts + 1,
        lastSyncError: err.message
      });
    }
  }
}
```

---

## 6. AI対話エンジン設計

### 6.1 プロンプト構成

```
┌─────────────────────────────────────────┐
│           システムプロンプト             │
├─────────────────────────────────────────┤
│ 1. ペルソナ定義                          │
│    - 役割: 新人記録係「KY記録くん」      │
│    - 態度: 謙虚、学び姿勢                │
│                                         │
│ 2. 対話ルール                            │
│    - 50文字以内                          │
│    - 否定しない                          │
│    - 褒める                              │
│                                         │
│ 3. フェーズ別指示                        │
│    - 各フェーズの目的と遷移条件          │
│                                         │
│ 4. コンテキスト（動的注入）              │
│    - 作業種別                            │
│    - 天候情報                            │
│    - 対話履歴                            │
│                                         │
│ 5. 出力形式                              │
│    - JSON形式                            │
└─────────────────────────────────────────┘
```

### 6.2 システムプロンプト全文

```
あなたは「KY記録くん」という建設現場アシスタントです。
親方（作業員）のKY活動を手伝う新人記録係です。

## 性格・話し方
- 真面目で勉強熱心、でも控えめ
- 「教えてください」「記録させていただきます」という姿勢
- 上から目線は絶対にNG
- 良い回答には「さすがです！」「勉強になります！」

## 対話ルール
- 1回の発話は50文字以内
- 専門用語は平易に（「墜落」→「落ちる」）
- 否定形を使わない
- 相槌を入れる（「なるほど」「いいですね」）

## 対話の流れ
Phase 1: greeting → 挨拶、天候に触れる
Phase 2: hazard_main → 「どんな危険がありそうですか？」
Phase 3: hazard_detail → 抽象的なら「具体的に教えてください」
Phase 4: hazard_more → 「他にありますか？」→なければ次へ
Phase 5: counter → 「{{危険}}への対策は？」
Phase 6: goal → 「今日の合言葉を決めてください」
Phase 7: done → 「ありがとうございます！ご安全に！」

## 今日の情報
作業: {{work_type}}
天候: {{weather}}
時刻: {{time}}

## 出力形式（JSON）
{
  "reply": "発話内容",
  "phase": "現在のフェーズID",
  "done": false,
  "data": {
    "hazards": ["抽出した危険"],
    "countermeasures": ["抽出した対策"],
    "goal": "合言葉"
  }
}
```

### 6.3 アドバイス生成プロンプト

```
KYアドバイザーとして、以下のKY内容を評価し、改善ヒントを1-2個提供してください。

## 評価対象
- 作業: {{work_type}}
- 天候: {{weather}}
- 危険: {{hazards}}
- 対策: {{countermeasures}}
- 合言葉: {{goal}}

## 評価観点
1. 具体性（「落ちる」<「布板設置時に足を滑らせて落ちる」）
2. 網羅性（墜落だけでなく落下物も）
3. 対策の実行可能性（「気をつける」は曖昧）
4. 天候の考慮

## 出力（JSON配列）
[{"type": "tip"|"good", "text": "30文字以内のアドバイス"}]
```

---

## 7. 画面仕様

### 7.1 画面一覧

| ID | 名前 | URL | 説明 |
|----|------|-----|------|
| S01 | ホーム | `/` | KY開始ボタン、履歴リンク |
| S02 | 対話 | `/chat` | AI対話、音声入出力 |
| S03 | 確認 | `/confirm` | 内容確認、アドバイス表示 |
| S04 | 完了 | `/done` | PDF表示、共有 |
| S05 | 履歴 | `/history` | 過去記録一覧 |

### 7.2 S02: 対話画面 詳細

```
┌─────────────────────────────────┐
│  🏗️ 足場設置 KY                 │  ← ヘッダー
├─────────────────────────────────┤
│                                 │
│  ┌─────────────────────────┐    │  ← AI発言（左寄せ）
│  │🤖 今日は晴れですね。     │    │
│  │  どんな危険がありそう    │    │
│  │  ですか？                │    │
│  └─────────────────────────┘    │
│                                 │
│        ┌─────────────────────┐  │  ← ユーザー発言（右寄せ）
│        │         落ちるかも 👤│  │
│        └─────────────────────┘  │
│                                 │
│  ┌─────────────────────────┐    │
│  │🤖 どの作業の時ですか？   │    │
│  └─────────────────────────┘    │
│                                 │
├─────────────────────────────────┤
│  ┌───────────────────────────┐  │  ← 入力エリア
│  │ ここに入力...             │  │  ← テキスト入力欄
│  └───────────────────────────┘  │
│                                 │
│        ┌─────────┐              │  ← マイクボタン
│        │   🎙️   │              │
│        │   ●●●  │              │  ← 音声レベル表示
│        └─────────┘              │
│                                 │
│  [キャンセル]                   │  ← フッター
└─────────────────────────────────┘
```

### 7.3 S03: 確認画面 詳細

```
┌─────────────────────────────────┐
│  ✅ KY確認                       │
├─────────────────────────────────┤
│                                 │
│  📅 2026/01/21 08:15            │
│  🌤️ 晴れ 8℃ 風速5m             │
│                                 │
│  ━━━━━━━━━━━━━━━━━━━━           │
│                                 │
│  ⚠️ 危険                        │
│  ・布板設置時にバランスを       │
│    崩して落ちる                 │
│                                 │
│  ✅ 対策                        │
│  ・安全帯を親綱にかけてから     │
│    作業する                     │
│                                 │
│  🎯 合言葉                      │
│  「安全帯ヨシ！」               │
│                                 │
│  ━━━━━━━━━━━━━━━━━━━━           │
│                                 │
│  💡 アドバイス                   │
│  ┌───────────────────────────┐  │
│  │ 風が強めです。資材の       │  │
│  │ 落下も意識してみましょう   │  │
│  └───────────────────────────┘  │
│                                 │
├─────────────────────────────────┤
│  [✏️ 修正]        [✅ 完了]    │
└─────────────────────────────────┘
```

---

## 8. 処理フロー

### 8.1 KY実施シーケンス

```
[User]          [PWA]           [Worker]        [OpenAI]        [Supabase]
  │               │                │               │               │
  │──KY開始──────→│                │               │               │
  │               │──位置情報取得──→               │               │
  │               │               │──天候API──────→               │
  │               │               │←─天候─────────│               │
  │               │←─対話開始────│               │               │
  │               │               │               │               │
  │──音声入力────→│               │               │               │
  │               │──STT変換─────│               │               │
  │               │──POST /chat──→│               │               │
  │               │               │──GPT呼出─────→│               │
  │               │               │←─応答────────│               │
  │               │←─AI応答──────│               │               │
  │←─TTS再生────│               │               │               │
  │               │               │               │               │
  │  (対話ループ)                  │               │               │
  │               │               │               │               │
  │──「終わり」──→│              │               │               │
  │               │──POST /advice→│               │               │
  │               │               │──GPT呼出─────→│               │
  │               │               │←─アドバイス──│               │
  │               │←─確認画面───│               │               │
  │               │               │               │               │
  │──完了────────→│              │               │               │
  │               │──PDF生成────│               │               │
  │               │──POST /records→              │               │
  │               │               │──INSERT──────│               │
  │               │               │←─OK──────────│               │
  │←─完了画面───│               │               │               │
  │               │               │               │               │
```

### 8.2 音声認識フロー

```
[User]          [SpeechModule]      [UI]           [API]
  │                  │                │               │
  │──マイクボタン───→│               │               │
  │                  │──開始通知────→│               │
  │                  │               │──🎙️点灯──────→
  │──発話───────────→│               │               │
  │                  │──interim─────→│               │
  │                  │               │──仮テキスト─→│
  │──発話終了───────→│               │               │
  │                  │──final────────→│              │
  │                  │               │──確定テキスト→│
  │                  │               │               │──API送信
  │                  │               │               │
```

---

## 9. エラー設計

### 9.1 エラー分類と対応

| コード | 状況 | ユーザー表示 | 技術対応 |
|--------|------|--------------|----------|
| E001 | マイク権限拒否 | 「マイクが使えません。文字入力で続けますか？」 | テキストモードに切替 |
| E002 | 音声認識失敗 | 「聞き取れませんでした。もう一度お願いします」 | 再試行UI表示 |
| E003 | ネットワーク切断 | 「通信できません。電波の良い場所へ」 | ローカル保存、後で同期 |
| E004 | AI APIエラー | 「AIが応答しません。少し待ってください」 | 3回リトライ |
| E005 | 天候取得失敗 | （表示なし、天候なしで続行） | デフォルト値使用 |

### 9.2 リトライポリシー

```javascript
const RETRY_CONFIG = {
  maxRetries: 3,
  backoff: [1000, 2000, 4000], // ms
  retryableErrors: ['NETWORK', 'TIMEOUT', 'RATE_LIMIT']
};
```

---

## 10. 非機能設計

### 10.1 パフォーマンス目標

| 指標 | 目標 | 許容 |
|------|------|------|
| 初期表示 | 1.5秒 | 3秒 |
| 音声認識開始 | 0.5秒 | 1秒 |
| AI応答 | 2秒 | 5秒 |
| PDF生成 | 1秒 | 3秒 |

### 10.2 最適化施策

| 施策 | 効果 |
|------|------|
| PWA + プリキャッシュ | 2回目以降の起動高速化 |
| ストリーミング応答 | 体感速度向上（逐次表示） |
| 遅延読み込み | jsPDFは完了画面でロード |
| 非同期保存 | 完了操作をブロックしない |

### 10.3 セキュリティ

| 対策 | 実装 |
|------|------|
| HTTPS強制 | Cloudflare自動 |
| APIキー秘匿 | Workers環境変数 |
| 位置情報 | 天候取得のみ、保存なし |
| CORS | 許可オリジン制限 |

### 10.4 アクセス制御設計

> ⚠️ **MVP前提**: 端末は個人持ちであり、パスコードロックにより保護されていることを前提とする。

| リスク | MVP対応 | 将来拡張 |
|--------|----------|----------|
| 端末紛失 | パスコードロック前提 | リモートワイプ機能 |
| 端末共有 | 非推奨（運用ルール） | ユーザー切替機能 |
| 履歴閲覧 | 本人のみ閘覧可能（端末保護） | 認証機能導入 |
| PDF共有 | 印刷/メールは本人判断 | 共有リンクURL（期限付き） |

---

## 付録A: 環境変数

```
# Cloudflare Workers
OPENAI_API_KEY=sk-xxx
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_KEY=xxx
WEATHER_API_KEY=xxx
```

## 付録B: デプロイ手順

```bash
# 1. Workers デプロイ
cd workers && wrangler publish

# 2. フロントエンド デプロイ
cd public && npx wrangler pages publish .

# 3. Supabase マイグレーション
npx supabase db push
```

---

**改訂履歴**

| Ver | 日付 | 変更 |
|-----|------|------|
| 2.0 | 2026/01/21 | 新規作成（ゼロベース） |
| 2.1 | 2026/01/21 | レビュー反映（監査項目・同期設計・アクセス制御） |
