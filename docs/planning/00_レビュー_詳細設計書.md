# 詳細設計書レビュー（v2採用）

対象:
- 比較: `docs/planning/04_詳細設計書.md` vs `docs/planning/05_詳細設計書_v2.md`
- レビュー対象: `docs/planning/05_詳細設計書_v2.md`
レビュー日: 2026-01-21

---

## 0. どちらが良いか（結論）
**v2（05_詳細設計書_v2.md）の方が良い**。

理由:
- 章立てが明確で、設計方針→構成→詳細→非機能の流れが一貫している。
- 状態管理・Service Worker・エラーコード・デプロイ手順まで含み、実装着手に必要な情報が多い。
- v1は選定が曖昧（React/Vue option 等）で、設計の確度が低い。

---

## 1. 重大/高
- **[高] 監査・実務に必須の識別情報がスキーマから欠落**  
  KY記録に現場ID・作業責任者・確認者・参加者が無く、監査耐性が低い。  
  `docs/planning/05_詳細設計書_v2.md:228-245`

- **[高] 履歴・PDF共有を想定するのにアクセス制御が一切ない**  
  履歴閲覧やPDF共有が設計にあるのに、認証・権限設計が不在。端末共有や紛失時の漏洩リスクが高い。  
  `docs/planning/05_詳細設計書_v2.md:386-390` `docs/planning/05_詳細設計書_v2.md:569-574`

- **[高] オフライン耐性の要件に対して「同期設計」が未定義**  
  「ネットワーク断でも消失しない」としつつ、同期タイミング/競合/失敗時の再送戦略が無い。  
  `docs/planning/05_詳細設計書_v2.md:32` `docs/planning/05_詳細設計書_v2.md:154-158` `docs/planning/05_詳細設計書_v2.md:531`

---

## 2. 中
- **[中] API設計の整合性不足（/api/adviceの位置づけが構成図に反映されていない）**  
  エンドポイント一覧には`/api/advice`があるのに、アーキテクチャ図で明示されていない。  
  `docs/planning/05_詳細設計書_v2.md:69-73` `docs/planning/05_詳細設計書_v2.md:168-173`

- **[中] データ設計とUI要件の乖離**  
  画面では履歴一覧・詳細を表示する設計だが、検索/絞り込み/ページング設計が無く、実装が破綻しやすい。  
  `docs/planning/05_詳細設計書_v2.md:386-390` `docs/planning/05_詳細設計書_v2.md:168-173`

- **[中] 非機能の性能目標が実測根拠なしで過度に楽観的**  
  AI応答2秒/許容5秒はネットワーク・API負荷次第で達成困難。測定条件が未定義。  
  `docs/planning/05_詳細設計書_v2.md:552-556`

- **[中] 位置情報利用のユーザー許諾・失敗時UXが不足**  
  位置情報取得はフローにあるが、拒否時の再入力・手動設定の導線がない。  
  `docs/planning/05_詳細設計書_v2.md:473` `docs/planning/05_詳細設計書_v2.md:533`

---

## 3. 低
- **[低] 命名の揺れ（workType/goal/reply等）で統合時にバグが出やすい**  
  APIの入出力で命名が揺れており、フロントの変換コストが増える。  
  `docs/planning/05_詳細設計書_v2.md:181-206`

- **[低] キャッシュ戦略が“機微データ”に配慮していない**  
  API応答のキャッシュによりKY内容が端末に残る。暗号化/有効期限が未定義。  
  `docs/planning/05_詳細設計書_v2.md:154-158`

- **[低] エラーコードがUI/ログ仕様と分離されている**  
  E001〜E005は定義されているが、ログにどう記録するか不明。監査・分析に使えない。  
  `docs/planning/05_詳細設計書_v2.md:529-533`

---

## 4. 追加で決めるべき事項（修正前に合意）
- **監査要件**: 署名/確認者/参加者の記録要否
- **認証/権限**: 端末共有や紛失時の閲覧制御
- **オフライン同期**: 競合解決・再送ポリシー・送信順序
- **性能目標**: ネットワーク条件の前提と測定手順

---

## 5. 確認したい前提
- 「履歴・PDF共有」は誰に向けた機能ですか？（職長/本社/本人）  
  `docs/planning/05_詳細設計書_v2.md:386-390`
- KY記録は監査提出が目的ですか？（監査なら署名/確認者が必須）  
  `docs/planning/05_詳細設計書_v2.md:228-245`

---

## 6. まとめ（短評）
v2は構造が良く実装に進めるが、**監査・認証・オフライン同期の3点が未定義**。ここを放置すると運用で止まる。まずは「監査に耐える最小項目」と「端末共有時の安全設計」を決めるべき。

