# v2フォルダ詳細レポート

## 目的と対象
本レポートは、`apps/v2-modern` にあるv2アプリのフォルダ構成と中身を、フロントエンド・バックエンドの主要コードを中心に詳しく説明するものです。ディレクトリ構造は `apps/v2-modern/README.md` の記載に基づき、主要な実装は `src` と `workers` を深掘りしています。なお、本レポートは単体で理解できるように記述しています。【F:apps/v2-modern/README.md†L140-L155】

## v2フォルダの全体構成（概要）
`apps/v2-modern` は、フロントエンド（`src`）、バックエンド（`workers`）、テスト（`tests`）、静的ファイル（`public`）などで構成されています。フロントエンドはReact + TypeScript + Vite、バックエンドはHonoを用いたCloudflare Workersで構築されています。【F:apps/v2-modern/README.md†L1-L21】【F:apps/v2-modern/README.md†L140-L155】

- `src/`: 画面・状態管理・APIクライアント・PDF生成・音声機能など、フロントエンド本体。
- `workers/`: `/api` を提供するHono API（Cloudflare Workers）。
- `tests/`: Vitest/Playwrightによるテスト群（このレポートでは実装の説明に焦点を当てるため詳細は割愛）。
- `public/`: 静的ファイル。

【F:apps/v2-modern/README.md†L140-L155】

---

## フロントエンド（src）の詳細

### 1. エントリポイントとルーティング
- `src/main.tsx` でSentryとWeb Vitalsの初期化を行い、`App` を描画しています。これがフロントエンド起動の入口です。【F:apps/v2-modern/src/main.tsx†L1-L15】
- `src/App.tsx` でルーティングを定義し、ホーム、セッション、完了、履歴、PDFデバッグなどの画面へ遷移します。【F:apps/v2-modern/src/App.tsx†L1-L26】

### 2. 主要ページ（pages）
- `HomePage` はトップ画面、`KYSessionPage` はKYセッション進行、`CompletionPage` は完了画面、`HistoryPage` と `HistoryDetailPage` は履歴の一覧と詳細を担当します。これらは `App.tsx` のルーティングで直接参照されています。【F:apps/v2-modern/src/App.tsx†L1-L26】

### 3. 状態管理（Zustand）
- `src/stores/kyStore.ts` はZustandのストアで、セッション情報・メッセージ履歴・作業項目・フィードバックなどを複数のスライスで統合しています。ローカル保存は `persist` で実装され、セッションの再開に対応しています。【F:apps/v2-modern/src/stores/kyStore.ts†L1-L37】

### 4. APIクライアント（lib/api.ts）
- `postChat` は `/api/chat` を呼び出し、レスポンスのZod検証に失敗すると `ApiError` を投げます。HTTPステータスに応じて `auth` / `rate_limit` / `timeout` / `server` などのエラー種別を推定します。【F:apps/v2-modern/src/lib/api.ts†L23-L117】
- `postFeedback` は `/api/feedback` を呼び出し、204を正常扱いで `null` を返します。レスポンスのZod検証に失敗した場合は例外を送出します。【F:apps/v2-modern/src/lib/api.ts†L120-L166】

### 5. チャット制御フック（useChat）
- `useChat` はメッセージ送信、AI応答の取得、エラーの正規化、サイレントリトライ（タイムアウトや混雑時）をまとめた中心ロジックです。エラー内容に応じてユーザーに適切なメッセージを返し、再試行可否を判断します。【F:apps/v2-modern/src/hooks/useChat.ts†L1-L235】
- 送信時には、`sessionContext`（ユーザー名・現場名・天候など）と `contextInjection` をAPIに送ります。セッション情報は `KYStore` の状態から取得されます。【F:apps/v2-modern/src/hooks/useChat.ts†L90-L284】
- 失敗時は `RETRY_ASSISTANT_MESSAGE` を追加し、必要に応じてリトライを有効化します。【F:apps/v2-modern/src/hooks/useChat.ts†L301-L391】

### 6. 音声認識（useVoiceRecognition）
- Web Speech API を利用し、音声入力の開始・停止、無音タイムアウト（10秒）による自動停止、画面非表示時の停止を実装しています。ブラウザ非対応時はエラーを返します。【F:apps/v2-modern/src/hooks/useVoiceRecognition.ts†L1-L183】

### 7. 音声合成（useTTS）
- Web Speech API を使った読み上げ制御で、再生中の識別、フォールバックタイムアウト（30秒）、日本語音声の優先選択などを行います。読み上げ状態はZustandストアで管理します。【F:apps/v2-modern/src/hooks/useTTS.ts†L1-L171】

### 8. PDF生成（usePDFGenerator）
- `@react-pdf/renderer` を使って `KYSheetPDF` を生成し、ダウンロードまたはBlob取得を行います。ファイル名は `KY活動記録_現場名_日付.pdf` 形式でサニタイズされます。【F:apps/v2-modern/src/hooks/usePDFGenerator.tsx†L1-L103】

---

## バックエンド（workers）の詳細

### 1. 入口と共通ミドルウェア（workers/index.ts）
- `workers/index.ts` がHonoアプリの入口です。CORS設定、認証、レート制限、リクエストID付与、Sentry連携などを共通処理として実装しています。【F:apps/v2-modern/workers/index.ts†L1-L199】
- `Origin` 許可は開発用と本番用に分けており、厳格モードでは本番リストのみ許可します。【F:apps/v2-modern/workers/index.ts†L42-L112】

### 2. チャットAPI（workers/routes/chat.ts）
- `/api/chat` はOpenAI APIを呼び出し、返信文と抽出データ（危険要因、対策、次の行動など）を返します。入力文字数制限、禁止語、会話履歴の制限を行います。【F:apps/v2-modern/workers/routes/chat.ts†L1-L151】【F:apps/v2-modern/workers/routes/chat.ts†L200-L284】
- 返却JSONが壊れている場合は、修復プロンプトで再試行し、それでも失敗すると `AI_RESPONSE_INVALID_JSON` として502を返します。【F:apps/v2-modern/workers/routes/chat.ts†L296-L372】
- Zod検証に失敗すると `AI_RESPONSE_INVALID_SCHEMA` で502を返し、OpenAI呼び出し回数や再試行状況をメタ情報として返却します。【F:apps/v2-modern/workers/routes/chat.ts†L372-L433】

### 3. フィードバックAPI（workers/routes/feedback.ts）
- `/api/feedback` はフィードバック生成のAPIで、KVがあればキャッシュ・永続化を使い、なければメモリキャッシュで代替します。【F:apps/v2-modern/workers/routes/feedback.ts†L1-L90】
- OpenAIのJSONパースやスキーマ検証が失敗した場合は、安全なフォールバック応答を返します。【F:apps/v2-modern/workers/routes/feedback.ts†L200-L307】

### 4. メトリクスAPI（workers/routes/metrics.ts）
- `/api/metrics` はイベント記録用で、Analytics Engineがある場合は書き込み、ない場合はログ出力のみ行います。【F:apps/v2-modern/workers/routes/metrics.ts†L1-L64】

---

## 主要なデータフロー（簡易）
1. ユーザーの入力（テキスト/音声） → `useChat` がAPIリクエストを組み立てる。セッション情報と文脈注入を含める。【F:apps/v2-modern/src/hooks/useChat.ts†L90-L284】
2. `postChat` が `/api/chat` を呼び出し、Honoの `chat` ルートでOpenAI APIを呼び出す。【F:apps/v2-modern/src/lib/api.ts†L56-L117】【F:apps/v2-modern/workers/routes/chat.ts†L296-L433】
3. 応答の抽出データは `useChat` がストアへ反映し、作業内容やリスク評価に反映される。【F:apps/v2-modern/src/hooks/useChat.ts†L186-L371】
4. 完了時には `usePDFGenerator` でPDFを出力可能。【F:apps/v2-modern/src/hooks/usePDFGenerator.tsx†L1-L103】

---

## エラーの詳細と原因・対策
本プロジェクトで想定されるエラーは、主にAPI通信と音声機能の2系統です。以下に原因と対策を整理します。

### 1. Chat APIのエラー
- **原因**: 通信エラー、認証エラー、レート制限、タイムアウト、サーバー内部エラーなど。`postChat` と `useChat` で種別ごとに判定しています。【F:apps/v2-modern/src/lib/api.ts†L23-L117】【F:apps/v2-modern/src/hooks/useChat.ts†L34-L178】
- **対策**:
  - レート制限やタイムアウト時は再送可能なメッセージを提示し、サイレントリトライを実行する（`useChat`）。【F:apps/v2-modern/src/hooks/useChat.ts†L148-L291】
  - 認証エラーの場合は管理者にAPIトークン設定を確認してもらう（`useChat`）。【F:apps/v2-modern/src/hooks/useChat.ts†L52-L83】
  - サーバー側ではJSON修復や再生成を行い、失敗時は502とエラーコードを返す（`chat` ルート）。【F:apps/v2-modern/workers/routes/chat.ts†L296-L372】

### 2. Feedback APIのエラー
- **原因**: OpenAI応答のJSONパース失敗、スキーマ検証失敗、タイムアウトなど。【F:apps/v2-modern/workers/routes/feedback.ts†L200-L307】
- **対策**:
  - JSONパース/検証に失敗した場合はフォールバック応答を返し、ユーザー体験の継続を優先する。【F:apps/v2-modern/workers/routes/feedback.ts†L200-L307】
  - タイムアウト時は408を返し、リトライ可能とする。【F:apps/v2-modern/workers/routes/feedback.ts†L318-L345】

### 3. 音声認識（Web Speech API）のエラー
- **原因**: ブラウザ非対応、マイク権限拒否、音声入力が取得できないなど。【F:apps/v2-modern/src/hooks/useVoiceRecognition.ts†L24-L147】
- **対策**:
  - 非対応時は明確なエラーメッセージを表示し、テキスト入力に誘導する。【F:apps/v2-modern/src/hooks/useVoiceRecognition.ts†L61-L84】
  - `not-allowed` や `audio-capture` の場合は自動再開を無効化し、ユーザーに再設定を促す。【F:apps/v2-modern/src/hooks/useVoiceRecognition.ts†L105-L129】

### 4. 音声合成（TTS）のエラー
- **原因**: `speechSynthesis` が利用できない、`onend` が発火しないなどのブラウザ依存挙動。【F:apps/v2-modern/src/hooks/useTTS.ts†L1-L165】
- **対策**:
  - `onend` が発火しない場合に備えてフォールバックタイムアウトを設定し、強制終了する。【F:apps/v2-modern/src/hooks/useTTS.ts†L16-L129】

---

## 補足（セキュリティと運用）
- `workers/index.ts` で `Origin` 制御とCORSを厳密に行い、APIトークン必須化にも対応しています。【F:apps/v2-modern/workers/index.ts†L42-L199】
- `/api/chat` では禁止語フィルタと入力長制限を設け、過剰入力や不適切入力を抑制します。【F:apps/v2-modern/workers/routes/chat.ts†L26-L151】

---

## 最後に
v2は、フロントエンドのチャット体験・音声機能・PDF出力と、バックエンドのAPI/エラー処理/セキュリティが一体化した構成です。本レポートは主要コードを中心に説明しましたが、必要があれば `components` や `tests` のさらに詳細な説明も作成可能です。【F:apps/v2-modern/README.md†L140-L155】
