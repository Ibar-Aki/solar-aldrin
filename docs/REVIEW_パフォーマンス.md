# パフォーマンスレビュー結果

実施日: 2026-01-21
対象: `src/public/js/**`, `src/workers/index.js`
方法: CODEX CLI + 手動レビュー

---

## 対応判定サマリー

| 重要度 | 指摘内容 | 対応 |
|--------|----------|------|
| 中 | handleSyncがダミー実装 | ⏸️ 見送り（即時同期で動作） |
| 中 | getAllRecordsが全件取得→reverse | ⏸️ 見送り（MVP規模で問題なし） |
| 低 | OpenAIレスポンスのキャッシュなし | ⏸️ 見送り（リアルタイム性必要） |
| 低 | 天候APIのキャッシュなし | ⏸️ 見送り（セッション毎1回） |
| 低 | グローバルオブジェクト使用 | ⏸️ 見送り（MVPで問題なし） |

**結論: MVPスケールでは対応不要な指摘のみ。修正は行わない。**

---

## 詳細レビュー結果

### 🔸 中程度の指摘

#### 1. handleSync がダミー実装（index.js:325-336）

```javascript
for (const record of records || []) {
    results.push({ id: record.id, status: 'ok' }); // 保存していない
}
```

- **問題**: バルク同期APIが未実装
- **影響**: オフラインで溜まったデータがバッチ同期で失われる可能性
- **現状**: クライアント側は`Storage.syncPendingRecords()`で個別同期するため実際には使われていない
- **判定**: ⏸️ 見送り（即時同期で動作中）

#### 2. getAllRecords が全件取得→reverse（storage.js:93-106）

```javascript
const request = index.getAll();
const records = request.result.reverse(); // 全件メモリ展開
```

- **問題**: レコード数が増えるとメモリ負荷増
- **影響**: MVP規模（数十～数百件）では問題なし
- **判定**: ⏸️ 見送り（将来ページングを検討）

---

### 🔹 軽微な指摘

#### 3. OpenAI レスポンスのキャッシュなし

- **問題**: 同じ質問でもAPIを毎回呼び出し
- **現状**: 対話はリアルタイム性が必要でキャッシュ不適
- **判定**: ⏸️ 対応不要

#### 4. 天候API のキャッシュなし

- **問題**: 毎回APIを呼び出し
- **現状**: セッション開始時に1回のみ呼び出し
- **判定**: ⏸️ 対応不要

#### 5. グローバルオブジェクト（Speech, UI, Storage等）

- **問題**: 名前空間汚染、テスタビリティ低下
- **現状**: MVPでは問題なし
- **判定**: ⏸️ 将来リファクタリング時に対応

---

## N+1クエリ問題

**該当なし**

IndexedDB操作は`getAll()`で一括取得しており、N+1パターンは検出されず。

---

## メモリリーク

**該当なし**

- DOM要素は画面遷移時に`container.innerHTML`で再設定
- Web Speech APIの`SpeechRecognition`インスタンスは1つのみ再利用
- イベントリスナーは再登録時に重複しない設計

---

## 今後の改善候補（v2以降）

| 項目 | 対応案 | 優先度 |
|------|--------|--------|
| 履歴ページング | IndexedDBカーソル逆順取得、またはAPI側でlimit/offset | 低 |
| 状態管理モジュール化 | ES Modulesへ移行 | 低 |
| バルク同期 | handleSyncの実装 | 中 |
