# スケール課題と対応策レポート

## 1. 目的
本レポートは、Voice KY Assistant（Phase 2 Modern）を利用人数が増加する前提でスケールさせる際の**ボトルネック**と**技術的懸念**を洗い出し、**対応策**と**概算費用**を提示するものです。現行構成（React/Vite、Cloudflare Workers、D1、R2、OpenAI API）を前提にしています。【F:ARCHITECTURE_DESIGN.md†L1-L63】

---

## 2. 前提・スケール想定
### 2.1 想定利用規模
要件定義に基づき、段階的に以下の規模を想定します。【F:REQUIREMENTS_DEFINITION.md†L24-L33】

- **Phase 2**: 1〜10人（ソロKY、PDF生成）
- **Phase 3**: 10〜100人（OCR/画像、エクスポート）
- **Phase 4**: 100〜200人以上（チームKY、分析ダッシュボード）

### 2.2 利用負荷のモデル（概算）
> 正確な費用は契約単価や実運用に依存するため、**代表的な利用量を仮定した概算**として示します。単価は各サービスの契約・地域により変動します。

- **1回のKY作成**を1セッションとする
- **1セッションのAI応答**: 3〜6回の往復
- **PDF生成**: 1回
- **保存**: D1に1件書き込み、R2に添付がある場合は1ファイル

### 2.3 コスト指標（目標）
非機能要件にある**「KY 1回あたり平均5円以下」**をコスト管理の基準とする。【F:REQUIREMENTS_DEFINITION.md†L153-L156】

---

## 3. 主要ボトルネックと技術懸念
以下は、スケール時に顕在化しやすいボトルネックを**層別（クライアント／エッジ／データ／AI／運用）**で整理したものです。

### 3.1 クライアント（PWA・音声・PDF生成）
| ボトルネック | 技術懸念 | 対応策 | 概算費用 |
|---|---|---|---|
| 音声認識の失敗率 | 騒音環境・端末差・ブラウザ差で精度が落ち、再入力が増える | 音声失敗時のテキスト入力導線を強化、音声再入力ボタンを目立たせる | 追加費用なし（UI改善） |
| PDF生成の端末負荷 | 低スペック端末でPDF生成が重くなり操作が止まる | 大きな画像の圧縮、必要最低限のフォント使用、生成中の進捗表示 | 追加費用なし（実装コスト） |
| ネットワーク断 | PWAの通信不安定で入力が消失 | ローカル保存（IndexedDB）と再送キュー | 追加費用なし（実装コスト） |

**補足**: これらはサーバー費用ではなく、**実装工数・UI改善**で対応可能な領域です。【F:REQUIREMENTS_DEFINITION.md†L92-L110】

---

### 3.2 エッジ（Cloudflare Workers / BFF）
| ボトルネック | 技術懸念 | 対応策 | 概算費用 |
|---|---|---|---|
| 同時リクエスト増加 | Workersの実行時間・同時実行数の上限に近づく | リクエストの分割、AI処理の非同期化、レート制限強化 | Workersのプラン増強（数千〜数万円/月の範囲で増加） |
| レイテンシ増加 | AI呼び出し待ちでユーザー体感が悪化 | ストリーミング応答、キャッシュ（定型プロンプト部分） | 追加費用は小（キャッシュ運用分） |
| 認証・権限制御 | フェーズ拡大でロール増加、認可漏れが事故に直結 | JWTなど標準的な認証導入、BFFで権限チェック | 追加費用なし（実装コスト） |

**補足**: Workersはスケールしやすいが、**同時リクエスト数と実行時間**がボトルネックになりやすいです。【F:ARCHITECTURE_DESIGN.md†L7-L33】

---

### 3.3 データ（D1 / R2 / エクスポート）
| ボトルネック | 技術懸念 | 対応策 | 概算費用 |
|---|---|---|---|
| D1の書き込み集中 | SQLite特性上、書き込み集中に弱い | 書き込みバッチ化、レコード分割、書き込み頻度削減 | D1のプラン増強（数千〜数万円/月） |
| エクスポート負荷 | Phase 3で大量CSV/Excel生成が発生 | バックグラウンドジョブ化、ダウンロード用R2に出力 | R2ストレージ・転送分が増加 |
| 監査ログ増加 | Phase 3以降の監査ログ記録量が増える | ログ保持期間の制御、圧縮、古いログのアーカイブ | ストレージ費用の増加 |

**補足**: フェーズ3以降で**データ保全と監査**が要件化しており、保存・ログコストが増えます。【F:REQUIREMENTS_DEFINITION.md†L131-L148】

---

### 3.4 AI（OpenAI API）
| ボトルネック | 技術懸念 | 対応策 | 概算費用 |
|---|---|---|---|
| APIレート制限 | 同時利用増でレート上限に達する | 事前キュー、リトライ戦略、ピーク平準化 | 追加費用なし（設計コスト） |
| コストの急増 | 1回のKYに複数リクエストが発生 | プロンプト圧縮、会話履歴の要約、トークン削減 | 直接費用を抑制（数割削減が狙える） |
| 品質の一貫性 | ユーザー増加でプロンプト逸脱が増える | システムプロンプトの固定化、バリデーション強化 | 追加費用なし（実装コスト） |

**補足**: AIコストは「**1回のKYに何トークン使うか**」で決まるため、**トークン最適化が最重要**です。【F:ARCHITECTURE_DESIGN.md†L33-L45】

---

### 3.5 運用・監視
| ボトルネック | 技術懸念 | 対応策 | 概算費用 |
|---|---|---|---|
| 障害検知の遅れ | RTO 4時間以内目標に未達 | メトリクス/ログ監視、アラート通知 | 監視サービス費用（月数千〜数万円） |
| 不正利用 | APIキー流出・リクエスト爆発 | APIキー管理、レート制限、監査ログ | 運用コスト（人件費） |

**補足**: 監視・運用はフェーズ拡大で必須になります。【F:REQUIREMENTS_DEFINITION.md†L140-L148】

---

## 4. 対応策の優先順位（実装ロードマップ）
### 4.1 優先度 高（Phase 2→3移行前）
1. **AIトークン最適化**（履歴要約・定型文の削減）
2. **D1書き込み集中の回避**（バッチ化・頻度削減）
3. **レート制限と再送キュー**（通信断・API制限に備える）

### 4.2 優先度 中（Phase 3）
1. **エクスポート処理の非同期化**
2. **監査ログの保持ポリシー設計**
3. **メトリクス監視とアラート整備**

### 4.3 優先度 低（Phase 4）
1. **チームKY向けの同時接続最適化**
2. **分析ダッシュボード用の集計基盤**

---

## 5. 概算費用モデル（例）
> 実際の請求額は各サービスの契約単価に依存するため、**費用感を把握するための参考モデル**として示します。

### 5.1 1回のKY作成あたりのコスト構成
| 項目 | 概算構成 | コスト傾向 |
|---|---|---|
| AI API | プロンプト + 応答のトークン量 | **最も大きい** |
| Workers実行 | リクエスト数と実行時間 | 小〜中 |
| D1書き込み | 1件のレコード保存 | 小 |
| R2保存 | PDF/画像を保存する場合のみ | 小 |

**目標コスト**: 1回あたり平均5円以下（要件目標）。【F:REQUIREMENTS_DEFINITION.md†L153-L156】

### 5.2 月間コストの概算モデル
以下の計算式で**概算の月間コスト**を見積もるのが現実的です。

```
月間コスト ≒ (1回あたりAIコスト × 月間KY数)
         + (Workers実行コスト + D1コスト + R2コスト)
         + 監視・運用コスト
```

#### 例（概算シナリオ）
- 1人あたり月20回KY
- 100人利用 → 月2,000回KY
- 1回あたり5円を目標とした場合

```
AI関連費用の目安 ≒ 5円 × 2,000回 = 10,000円/月
```

この「10,000円/月」に加えて、Workers/D1/R2/監視の固定費・従量費が乗る構造です。

---

## 6. まとめ（技術懸念と費用のポイント）
1. **最大のボトルネックはAIコストとレート制限**
   - 対応策: トークン最適化、履歴要約、ピーク平準化
2. **D1は書き込み集中に弱い**
   - 対応策: バッチ化、書き込み頻度削減、データ分割
3. **監査・エクスポート機能でストレージと処理負荷が増える**
   - 対応策: 非同期処理、保持期間設計、アーカイブ
4. **運用監視の不備はRTO未達の原因になる**
   - 対応策: メトリクス監視、アラート、障害対応手順

---

## 7. 次のアクション提案
- **トークン使用量の実測**と**1回あたりの実コスト**を計測し、目標（5円）に対する差分を明確化する
- **負荷試験**（同時利用数50〜100相当）を実施し、Workers/D1のボトルネックを数値で確認する
- **監視設計書**を整備し、RTO 4時間以内を満たすための運用手順を定義する

