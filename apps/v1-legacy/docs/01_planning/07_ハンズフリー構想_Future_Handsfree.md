# 完全ハンズフリー化の技術的検討

## 現状の課題

現在のMVPでは、以下の操作で画面タッチが必要となる。

1. **KY開始ボタン**のタップ（開始時）
2. **マイク許可**のタップ（初回のみだが、ブラウザのポリシーによる）
3. **マイクボタン**のタップ（対話中、スリープ等で切れた場合の再開）

「手袋をしていてスマホを触れない」「高所作業中で手が離せない」といった現場の状況を考慮すると、**「OK Google, KY開始」** のようなウェイクワードで起動し、最後まで一切画面を触らずに完了できるのが理想である。

## 技術的ハードル

Webブラウザ（特にiOS Safari）には強力なセキュリティ制限があり、**「ユーザーの明示的な操作（クリック・タップ）なしに音声入力や音声再生を開始できない」** という原則がある。

### 1. Wake Work (ウェイクワード) の待機

- **課題**: ブラウザがバックグラウンドにある、またはスリープ状態でマイクを常にONにして聞き耳を立てることは、バッテリー消費とプライバシーの観点からOSレベルで制限されている。
- **PWAの限界**: Service Workerはバックグラウンドで動作するが、マイクへのアクセス権限はない。

### 2. 音声自動再生 (Auto Play)

- **課題**: ユーザー操作なしに `speechSynthesis.speak()` や `<audio>.play()` を実行しようとすると、ブラウザがブロックすることがある。

## 解決アプローチ案

### A案: 「常時ON」モードの実装（準ハンズフリー）

アプリを起動し、「開始」ボタンを一度押した後は、画面ロック（スリープ）を無効化して常時待機させるアプローチ。

- **Wake Lock API**: 画面が消えないように制御するAPIを利用。
- **無音音声のループ再生**: 一部のハックとして、無音の音声をループ再生し続けることで、ブラウザのアクティブ状態を維持し、マイク入力を継続させる手法がある（ただしバッテリー消費大）。

### B案: ネイティブアプリ化（Cordova / Capacitor / React Native）

PWAの枠を超え、ネイティブアプリとしてラップする。

- **バックグラウンド処理**: ネイティブプラグインを使えば、バックグラウンドでのマイク入力や音声検知が可能になる場合がある。
- **Siri / Google Assistant ショートカット連携**:
  - iOS: Siri Shortcutsに対応させ、「Hey Siri, KY開始」でアプリを起動し、特定の処理を走らせる。
  - Android: Google AssistantのApp Actions連携。
  - **これが最も現実的かつユーザー体験が良い解法。**

### C案: VAD (Voice Activity Detection) の高度化

音声認識APIの標準機能だけでなく、ブラウザ内で `AudioWorklet` を使い、生の音声ストリームを解析して「人の声がしたときだけサーバーに送る/認識を開始する」仕組みを自作する。

- **TensorFlow.js**: ブラウザ内で軽量な機械学習モデルを動かし、特定のキーワード（Wake Word）を検知する。
- **Picovoice Porcupine**: WebAssemblyベースのWake Wordエンジン。高精度だが商用ライセンスが必要な場合あり。

## 推奨ロードマップ

1. **Phase 1 (現在)**: PWAとしてブラウザの制約内で、`continuous` 擬似実装（自動再開）により、**「アプリ起動中は極力触らなくて良い」** 状態を目指す。
2. **Phase 2 (UX向上)**: Wake Lock APIを導入し、作業中は画面が消えないようにして、対話の中断を防ぐ。
3. **Phase 3 (完全ハンズフリー)**:
   - **Siriショートカット対応**: iOSの「ショートカット」アプリ経由で、音声コマンドで指定URLを開く（`solar-aldrin://start` のようなスキーム起動）。
   - または、**Capacitor** 等でラップしてストア公開し、ネイティブの機能を利用する。

## 結論

純粋なWebブラウザ(PWA)だけで「OSスリープ状態からの完全音声起動」は不可能に近い。
現実的な解は、**「アプリ起動 → 開始ボタン」までは手動で行い、そこから完了まではWake Lock + 自動再開ロジックでハンズフリーを維持する** という設計である。
