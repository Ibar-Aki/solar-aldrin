# 応答時間・エラー率 悪化の根本原因調査と修正計画（詳細版）

作成日時: 2026-02-11 23:09:35 +09:00  
作成者: Codex＋GPT-5
更新日: 2026-02-11（P0/P1/P2の優先実装反映）

## 1. 目的

- 2026-02-11 時点で観測されている「応答時間悪化」「エラー率上昇」について、過去ログと実費テスト結果から根本原因を特定する。
- 原因ごとの寄与度を整理し、修正内容（優先順位・対象ファイル・検証KPI）を定義する。

## 2. 調査対象

- 集計対象: `reports/real-cost/LIVE/real-cost-LIVE-*.md`（77件）
- 日次サマリ: `reports/perf/daily-summary-2026-02-07.md` / `reports/perf/daily-summary-2026-02-08.md` / `reports/perf/daily-summary-2026-02-11.md`
- 実装: `workers/routes/chat.ts` / `workers/lib/openai.ts` / `src/hooks/useChat.ts` / `tests/e2e/real-cost-scenario.spec.ts`

## 3. 結論（要約）

根本原因は単一ではなく、以下4系統の複合です。

1. 設定・認証不整合（エラー率を押し上げる）
2. JSON/Schema 破損（遅延と失敗を同時に増やす）
3. 多段リトライ（サーバー＋クライアント）による待ち時間増幅
4. 実行ポリシー不一致（A/B運用のノイズ源）

特に「遅延」への寄与は 2,3 が大きく、「エラー率」への寄与は 1,2 が大きい構造です。

## 4. 事実ベースの観測結果

### 4.1 全期間（LIVE 77件）再集計

- FAIL: 38件
- `Errors > 0`: 30件
- `Parse Retry Used > 0`: 32件
- `Wait > 15s Turns > 0`: 16件
- エラーコード出現（コード行ベース）:
  - `AUTH_INVALID`: 48
  - `AI_RESPONSE_INVALID_JSON`: 20
  - `OPENAI_AUTH_ERROR`: 11
  - `AUTH_REQUIRED`: 6
  - `AI_RESPONSE_INVALID_SCHEMA`: 2
  - `AI_TIMEOUT`: 1

### 4.2 遅延との相関（ファイル群比較）

- `Wait > 15s` 発生群（16件）  
  平均 `Total Duration`: 173.16s  
  平均 `Avg API Response`: 8.29s
- `Wait > 15s` 非発生群（61件）  
  平均 `Total Duration`: 85.54s  
  平均 `Avg API Response`: 3.87s

=> 長時間待機のある回は、全体所要時間が約2倍。

### 4.3 2026-02-11（LIVE 41件）の日内構造

- `Errors > 0`: 17件
- 認証系コードあり: 6件（`AUTH_INVALID`/`OPENAI_AUTH_ERROR`/`AUTH_REQUIRED`）
- 実行時品質系コードあり: 11件（`AI_RESPONSE_INVALID_JSON`/`AI_RESPONSE_INVALID_SCHEMA` 等）
- 平均 `Total Duration`
  - 認証系: 65.45s
  - 品質系: 191.12s
  - 非該当: 96.90s

=> エラー率上昇は認証系が押し上げるが、遅延悪化は品質系が支配的。

## 5. 根本原因の詳細

### 原因A: 設定・認証不整合

証拠:

- `AUTH_INVALID` 連発（同一テスト内で401多発）  
  `reports/real-cost/LIVE/real-cost-LIVE-2026-02-08T12-23-57-539Z.md:59`
- `OpenAI Requests=0 / OpenAI HTTP Attempts=0` で失敗  
  `reports/real-cost/LIVE/real-cost-LIVE-2026-02-08T12-23-57-539Z.md:22`
- 無効OpenAIキー（`OPENAI_AUTH_ERROR`）  
  `reports/real-cost/LIVE/real-cost-LIVE-2026-02-11T12-44-37-568Z.md:42`

解釈:

- AIモデル品質ではなく、トークン/キー/環境値不一致が一次原因。
- この種別は短時間で失敗するため、遅延よりもエラー率に効く。

### 原因B: JSON/Schema破損（回復しきれないケース）

証拠:

- `finishReason=length` を伴う `AI_RESPONSE_INVALID_JSON`  
  `reports/real-cost/LIVE/real-cost-LIVE-2026-02-11T08-48-22-061Z.md:62`
- `AI_RESPONSE_INVALID_SCHEMA` が 35-42秒の重い失敗で発生  
  `reports/real-cost/LIVE/real-cost-LIVE-2026-02-11T11-18-20-959Z.md:58`  
  `reports/real-cost/LIVE/real-cost-LIVE-2026-02-11T11-20-17-549Z.md:61`
- 5回連続 `AI_RESPONSE_INVALID_JSON` で 259.3s まで悪化  
  `reports/real-cost/LIVE/real-cost-LIVE-2026-02-11T06-13-42-104Z.md:15`

実装要因:

- 回復再生成（1500 token）を主に `finish_reason === "length"` で発火  
  `workers/routes/chat.ts:929`
- Schema不一致にも追加回復はあるが、条件が限定的  
  `workers/routes/chat.ts:968`

### 原因C: リトライ構造の増幅

証拠:

- サーバーHTTPリトライ（5xx/429/ネットワーク）  
  `workers/lib/openai.ts:115` / `workers/lib/openai.ts:125`
- 既定リトライ1回  
  `workers/routes/chat.ts:138`
- クライアントのサイレントリトライ1回  
  `src/hooks/useChat.ts:21` / `src/hooks/useChat.ts:662`
- 単一ターン 32.5s + HTTP Attempts=2 の実例  
  `reports/real-cost/LIVE/real-cost-LIVE-2026-02-11T13-15-31-610Z.md:56`

解釈:

- 品質系エラー発生時に再送待機が積み上がり、P95を悪化させる。

### 原因D: 実行ポリシー不一致（設定ドリフト）

証拠:

- `chat meta.server mismatch` による fatal-infra  
  `reports/real-cost/LIVE/real-cost-LIVE-2026-02-11T05-39-08-789Z.md:46`
- `Server Policy Violations = 1`  
  `reports/real-cost/LIVE/real-cost-LIVE-2026-02-11T05-39-08-789Z.md:26`
- preflightガード仕様（LIVE時必須）  
  `tests/e2e/real-cost-scenario.spec.ts:635`

解釈:

- 実装差分またはデプロイ差分がA/B結果にノイズを入れている。

## 6. 修正内容（優先順位つき）

### P0（即時、エラー率抑制）

1. 認証preflightの厳格化（未達時は本試験実行禁止）
- 対象: `tests/e2e/real-cost-scenario.spec.ts`
- 目的: `AUTH_INVALID`/`OPENAI_AUTH_ERROR` の混入防止

2. 設定ドリフト検知の強制停止
- 対象: `tests/e2e/real-cost-scenario.spec.ts`
- 目的: `meta.server` 不一致時にA/B集計対象から除外

3. 失敗分類の集計分離（認証系と品質系）
- 対象: `reports/perf/*` 集計ロジック
- 目的: 指標の誤読防止（改善優先順位の誤りを防ぐ）

### P1（短期、遅延抑制）

1. parse recovery 条件の拡張
- 対象: `workers/routes/chat.ts`
- 変更方針:
  - `length` 以外のJSON/Schema破損にも「1回限定」の回復パスを適用
  - 回復成功率を `meta.parseRetry` で継続監視

2. リトライ予算の一本化
- 対象: `workers/lib/openai.ts`, `src/hooks/useChat.ts`
- 変更方針:
  - 通常時はサーバー側主導（クライアントのサイレントリトライを縮小）
  - 429のみ `Retry-After` 尊重で再送

3. タイムアウト階層の整理
- 対象: `workers/routes/chat.ts`, `workers/lib/openai.ts`
- 変更方針:
  - soft timeout（UX文言返却）と hard timeout（打ち切り）を分離

### P2（中期、安定運用）

1. 会話フェーズ別プロファイル
- quick / standard / recovery で `max_tokens` / `timeout` / `retry` を切替

2. JSON/Schema失敗の構造化ロギング強化
- `finishReason`, `issueCount`, `preview` を日次集計へ反映

## 7. Implementation Plan

推定作業時間: 約11時間

1. preflight/ポリシー不一致ガードの強化（2時間）
2. parse recovery 条件拡張（3時間）
3. リトライ予算一本化（3時間）
4. 日次集計の分類再設計（2時間）
5. 検証・レポート更新（1時間）

## 8. 検証KPI（受け入れ基準）

- 認証系失敗率: 5%未満（LIVE試験）
- `AI_RESPONSE_INVALID_JSON` + `AI_RESPONSE_INVALID_SCHEMA`: 現状比 50%以上削減
- `Wait > 15s` 発生率: 30%台 -> 10%以下
- `Total Duration` P95: 299.9s -> 150s以下
- `Server Policy Violations`: 0件維持

## 9. 主要参照（抜粋）

- `reports/perf/daily-summary-2026-02-11.md:26`
- `reports/perf/daily-summary-2026-02-11.md:53`
- `reports/real-cost/LIVE/real-cost-LIVE-2026-02-08T12-23-57-539Z.md:59`
- `reports/real-cost/LIVE/real-cost-LIVE-2026-02-11T12-44-37-568Z.md:42`
- `reports/real-cost/LIVE/real-cost-LIVE-2026-02-11T06-13-42-104Z.md:58`
- `reports/real-cost/LIVE/real-cost-LIVE-2026-02-11T11-18-20-959Z.md:58`
- `workers/routes/chat.ts:929`
- `workers/routes/chat.ts:968`
- `workers/lib/openai.ts:115`
- `src/hooks/useChat.ts:662`
- `tests/e2e/real-cost-scenario.spec.ts:635`

## 10. 実装反映ログ（2026-02-11）

### 10.1 P0 実装

1. 認証preflightの厳格化
- `tests/e2e/real-cost-scenario.spec.ts`
  - LIVE時に `LIVE_PREFLIGHT_PASSED=1` 未設定なら即停止
  - LIVE時に `VITE_API_TOKEN/API_TOKEN` 未解決なら即停止

2. 設定ドリフト検知の強制停止
- `tests/e2e/real-cost-scenario.spec.ts`
  - `meta.server` mismatch を fatal-infra として扱い、以降のターンを停止

3. 失敗分類の集計分離
- `tests/e2e/real-cost-scenario.spec.ts`
  - API Trace を `auth_config` / `runtime_quality` / `policy_mismatch` / `other` で分類
  - レポート `Failure Summary` と API Trace 表に分類列を追加
- `scripts/generate_perf_summary.mjs`
  - Failure Summary（`auth=, runtime=, policy=, other=`）を優先読み取り
  - 日次サマリに「ポリシー不一致発生率」を追加

### 10.2 P1 実装（対象: 2,3）

2. リトライ予算の一本化
- `src/hooks/useChat.ts`
  - サイレントリトライ既定値を `0` に変更
  - 429(retriable)のみ限定的に自動再送

3. タイムアウト階層の整理
- `workers/routes/chat.ts`
  - soft timeout -> hard timeout の2段階実行
  - hard timeout失敗時は `AI_TIMEOUT` + `details.timeoutTier=hard` を返却
  - 成功/失敗の両方で `meta.server.timeoutTier` 系メタを観測可能化

### 10.3 会話フェーズ別プロファイル実装

- `workers/routes/chat.ts`
  - `quick` / `standard` / `recovery` を導入し、`max_tokens` / timeout / retry / temperature を切替
  - `meta.server.profile*` へ適用プロファイル情報を追加
- `tests/integration/integration.test.ts`
  - quickプロファイルの適用確認
  - soft timeout回復とhard timeout失敗の回帰テストを追加
