# v2-modern リファクタリング計画

作成日: 2026-02-03
作成者: Codex+GPT-5

## 概要
`apps/v2-modern` は React + Zustand + Vite + Cloudflare Workers の構成で全体は整理されていますが、UI・ドメイン・API 呼び出しが同一ファイルに混在している箇所があり、機能追加やバグ修正時の変更影響が広がりやすい状態です。特に `CompletionPage`、`useChat`、`workers/routes` がホットスポットです。

## 必要度評価
- 総合: 中〜高
- 高: ページロジックの肥大、フロント/Workerの共有型の混在
- 中: PDF生成・履歴系ユーティリティの肥大、設定値・フラグの分散
- 低: 小さめのUIコンポーネント群

## 主な観察点
- 画面内に API 呼び出しやサニタイズ、状態遷移が混在
- 1フックが多責務
- Worker 側がフロントの `src` を直接参照
- PDF テンプレートが巨大かつ単一ファイル
- コンテキスト注入と履歴参照ユーティリティが肥大化

## リファクタリング計画（段階的）
1. フェーズ0: 安全網と境界の明確化
   - 目的: リファクタリングの安全性確保
   - 具体: テスト通過の確認、主要フローの簡易ドキュメント化

2. フェーズ1: 共有スキーマ/型の分離
   - 目的: フロントと Worker の依存を分離し、ビルド/変更影響を局所化
   - 具体: `schema` と `types` を共有モジュールへ移動し、参照先を統一

3. フェーズ2: 完了画面の分解（高優先）
   - 目的: `CompletionPage` の多責務を分離して保守性を向上
   - 具体: フィードバック取得・サニタイズ・表示状態管理を `lib` と `hooks` に移管

4. フェーズ3: チャットフローの責務分割
   - 目的: API 呼び出し、コンテキスト注入、状態更新の分離
   - 具体: `useChat` を「通信」「注入構築」「ストア更新」に分割

5. フェーズ4: UIレイアウト共通化
   - 目的: ページごとの重複 UI を削減
   - 具体: ページ枠・ヘッダー・カードレイアウトの共通コンポーネント化

6. フェーズ5: Worker の責務整理
   - 目的: ミドルウェア/ルート/ユーティリティの責務分離
   - 具体: Origin 判定、CORS、エラーハンドリング、サニタイズの分離

7. フェーズ6: PDFテンプレート分割（任意）
   - 目的: テンプレート保守性向上
   - 具体: スタイル・フォーマット・セクション描画の分割

## 本当に実施すべき優先度高いもの
1. 共有スキーマ/型の分離（フェーズ1）
   - Worker がフロント `src` に依存しているため、ビルドや変更の影響が広がります。
   - 依存境界を明確にするのが最優先です。

2. 完了画面の分解（フェーズ2）
   - `CompletionPage` に非同期処理や状態管理が集中しており、変更時のバグ混入リスクが高いです。
   - テストしやすい構造にする価値が大きいです。

3. チャットフローの責務分割（フェーズ3）
   - `useChat` が通信・コンテキスト・ストア更新を一手に担っています。
   - 不具合の切り分けと拡張性のため早期の分離が望ましいです。

## 効果見込み
- 変更の影響範囲が局所化され、バグ混入率が下がる
- API/Worker と UI の責務分離でレビュー効率が上がる
- テストが書きやすくなり、回帰検知が強化される
