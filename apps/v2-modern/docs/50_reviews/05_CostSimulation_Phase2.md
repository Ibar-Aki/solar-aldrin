# KY活動 推定費用試算

直近の実費テストログおよびコードの実装状況に基づき、**「2件の危険予知を行い、かつ会話が長引いた場合」**の1回あたりの費用を試算しました。

## 1. 前提条件

| 項目 | 設定値 | 備考 |
|---|---|---|
| **使用モデル** | **gpt-4o-mini** | コード(`chat.ts`)より確認 |
| **単価 (Input)** | $0.150 / 1M tokens | 公式価格 |
| **単価 (Output)** | $0.600 / 1M tokens | 公式価格 |
| **為替レート** | 155円 / USD | 安全側に設定 |
| **システムプロンプト等** | 約 2,200 tokens | ログより推定 (System + Context) |
| **履歴保持数** | 最大 10ターン | 実装(`MAX_HISTORY_TURNS = 10`) |

## 2. 想定シナリオ（高負荷ケース）

「2件の危険を抽出し、会話のラリーが長くなった」ケースを想定します。

* **構成**:
  * 導入 (2ターン)
  * 危険予知1 (5ターン)
  * 危険予知2 (5ターン)
  * 認識相違などのラリー延長 (+3ターン)
  * 締めくくり (2ターン)
  * **合計: 17ターン**
* **トラブル想定**:
  * システム側のJSONパースエラーによるリトライが **2回** 発生（ログの実績値を採用）

## 3. トークン消費シミュレーション

履歴は最大10ターン（User+AIのペア×10）まで累積します。それ以降は古い履歴が消えるため、1ターンあたりのInput量は一定値（約4,750 tokens）で頭打ちになります。

| ターン | 状況 | Input Tokens (概算) | Output Tokens (概算) | 備考 |
|---|---|---|---|---|
| 1 | 挨拶 | 2,250 | 200 | System + User |
| 2 | 作業入力 | 2,500 | 200 | + History(1) |
| 3 | 危険1-危険 | 2,750 | 200 | + History(2) |
| 4 | 危険1-要因 | 3,000 | 200 | |
| 5 | 危険1-対策 | 3,250 | 200 | |
| 6 | 危険1-確認 | 3,500 | 200 | |
| 7 | 危険1-完了 | 3,750 | 200 | |
| 8 | 危険2-危険 | 4,000 | 200 | |
| 9 | 危険2-要因 | 4,250 | 200 | |
| 10 | 危険2-対策 | 4,500 | 200 | |
| 11 | 危険2-確認 | 4,750 | 200 | **ここ付近で履歴Max到達** |
| 12 | 危険2-完了 | 4,750 | 200 | Input量安定 |
| 13 | 延長ラリー1 | 4,750 | 200 | |
| 14 | 延長ラリー2 | 4,750 | 200 | |
| 15 | 延長ラリー3 | 4,750 | 200 | |
| 16 | 完了確認 | 4,750 | 200 | |
| 17 | ヨシ！ | 4,750 | 300 | 最後は少し長め |
| **Retry** | パース失敗x2 | 9,500 | 400 | Max状態付近での再送(Input x 2) |
| **合計** | | **76,700 tokens** | **3,900 tokens** | |

※ Retry分は、最大コンテキスト量での再送2回分として保守的に加算。

## 4. 費用算出結果

| 項目 | トークン数 | 単価 | 費用 (USD) | 費用 (JPY) |
|---|---|---|---|---|
| **Input** | 76,700 | $0.15 / 1M | $0.011505 | 1.78円 |
| **Output** | 3,900 | $0.60 / 1M | $0.002340 | 0.36円 |
| **TOTAL** | **80,600** | | **$0.013845** | **約 2.15円** |

## 5. 結論

GPT-4o-mini を使用しているため、会話が長引きリトライが発生しても、**1回あたり約 2.15円** 程度に収まります。

* **通常ケース（リトライなし、危険1件）**: 約 1.0円 〜 1.2円
* **高負荷ケース（リトライあり、危険2件）**: 約 2.2円

**参考: GPT-4o (非mini) を使っていた場合**
Input $2.50, Output $10.00 で計算すると…

* Input: $0.19175 (約29.7円)
* Output: $0.03900 (約6.0円)
* **合計: 約35.7円**

GPT-4o-miniの採用により、コストは約 **1/16** に抑えられています。かなり安価です。
