# KYボード「何が原因で」誤混入の原因分析と修正提案

作成日時: 2026-02-14 08:55:15 +09:00
作成者: Codex＋GPT-5
更新日: 2026-02-14

## 1. 背景

現象:
- KYボードの「何をする時」と「何が原因で」に、ほぼ同じ内容が入るケースが多発。
- 特に「何が原因で」に作業内容（例: 「脚立上で配線固定する時」）が入ってしまう。

本資料は、`apps/v2-modern` 現行実装を対象に、原因分析と修正提案をまとめたもの。

## 2. 結論（先出し）

主因は以下の複合です。

1. フロント側の補完ロジックが、`whyDangerous` 欠落時に `workDescription` から原因文を自動生成している。
2. プロンプトに「原因欄へ作業文を入れてはいけない」という禁止ルールが不足している。
3. Workers側での検証が型中心で、意味的な妥当性（作業と原因の混同）を判定していない。
4. KYボード反映前に、AI抽出結果の「項目妥当性チェック」がない。

## 3. 事実ベースの原因分析

### 3.1 原因A（最重要）: `whyDangerous` の自動補完が誤混入を作る

該当:
- `src/lib/chat/mergeExtractedData.ts:42`
- `src/lib/chat/mergeExtractedData.ts:112`
- `src/lib/chat/mergeExtractedData.ts:115`

内容:
- `whyDangerous` が未返却時、`inferWhyDangerousFromContext()` が発火。
- 候補順が `hazardDescription -> current hazard -> workDescription -> current workDescription`。
- 条件に当てはまらない場合は `"{source}ため"` を生成するため、`workDescription` がそのまま原因欄へ流入しうる。

実害:
- 「何をする時」と「何が原因で」が重複し、KY品質が下がる。

### 3.2 原因B: プロンプトの分離指示はあるが、禁止ルールが弱い

該当:
- `workers/prompts/soloKY.ts:28`
- `workers/prompts/soloKY.ts:29`
- `workers/prompts/soloKY.ts:33`

内容:
- 項目分離の説明はあるが、以下が不足。
- NG例（原因欄に作業文を入れる）を明示していない。
- 「作業表現を原因欄に入れない」制約がない。
- 曖昧入力時は `whyDangerous=null` を維持して再質問する厳格ルールがない。

### 3.3 原因C: Workers側は型正規化のみで、意味妥当性の検証がない

該当:
- `workers/lib/chat/normalize.ts:191`
- `workers/lib/chat/normalize.ts:248`
- `workers/lib/chat/normalize.ts:435`
- `workers/lib/chat/config.ts:43`

内容:
- JSON schema と normalize は「形式」を通す役割。
- `workDescription` と `whyDangerous` の重複・混同を弾くロジックがない。

### 3.4 原因D: 仕様として補完ロジックが過去に追加されている

該当:
- `docs/00_overview/00_Master_Technical_Reference.md` 冒頭更新履歴

内容:
- `whyDangerous` 補完ロジック追加が明記されており、今回現象との因果が強い。

## 4. 再現シナリオ（最小）

1. ユーザー入力: `脚立上で天井配線を固定する時`
2. AI抽出（例）: `workDescription` のみ返却、`whyDangerous` は null/欠落
3. `mergeExtractedData` が `workDescription` から `whyDangerous` を補完
4. KYボード:
   - 何をする時: `脚立上で天井配線を固定する時`
   - 何が原因で: `脚立上で天井配線を固定する時ため`

## 5. 修正提案（推奨）

### 5.1 提案1（P0）: 誤補完の停止（最優先）

方針:
- `whyDangerous` 欠落時に `workDescription` から補完しない。
- 原則: `whyDangerous` がなければ空のまま保持し、次ターンで明示質問。

具体:
- `src/lib/chat/mergeExtractedData.ts`
  - `inferWhyDangerousFromContext()` を削除、または hazard限定でも「原因語あり」の場合のみ許可。
  - 少なくとも `workDescription` 起点の補完は禁止。

期待効果:
- 原因欄への作業文流入を即時に大幅抑制。

### 5.2 提案2（P1）: AI抽出の意味検証ガードを Workers 側に追加

方針:
- KYボード反映前に、`extracted` を意味的に検査して補正する。

追加候補ファイル:
- 新規 `workers/lib/chat/fieldGuard.ts`
- 接続先 `workers/lib/chat/execution.ts`（`normalizeModelResponse` 後）

最低限ルール:
- `whyDangerous` 各要素が `workDescription` と高類似なら無効化。
- `whyDangerous` が「〜する時」「作業」「実施」など作業記述優位で、原因語（例: `ため`, `ので`, `不十分`, `滑りやすい`, `見えにくい`）がない場合は無効化。
- `whyDangerous` が空になった場合は `nextAction=ask_why` に寄せる。

期待効果:
- モデルの取り違えがあっても、ボード汚染をサーバーで防止できる。

### 5.3 提案3（P1）: プロンプト強化（NG例を明記）

対象:
- `workers/prompts/soloKY.ts`

追記例:
- 「`whyDangerous` には作業内容を入れない」
- NG例:
  - work: `脚立上で配線固定する時`
  - why(誤): `脚立上で配線固定する時`
- OK例:
  - why(正): `脚立の設置角度が不適切で足元が滑りやすいため`
- 判別不能時は `whyDangerous=null` を維持し、確認質問を返す。

期待効果:
- 生成段階で混同率を減らす。

### 5.4 提案4（P2）: AIによる二段確認（軽量Verifier）

要望対応（「AI側で一度確認」）として有効。

方式:
- 条件付きで追加1コール（混同疑い時のみ）
- 役割: `workDescription/whyDangerous/hazardDescription` の整合判定と修正提案
- 通常時はスキップし、コスト増を最小化

適用条件例:
- `whyDangerous` が `workDescription` と類似率高
- `whyDangerous` が1件のみかつ短文で作業語中心

期待効果:
- 高精度化。特に実費運用での品質安定に効く。

### 5.5 提案5（P2）: 監視指標の追加

追加メトリクス候補:
- `ky_field_contamination_detected`
- `ky_field_guard_corrected`
- `ky_field_guard_escalated_ask_why`

効果:
- どの現場/条件で誤混入が起きるかを可視化し、継続改善できる。

## 6. 推奨実施順序

推定作業時間: 約14時間

1. P0: `workDescription` 起点の `whyDangerous` 補完停止（2h）
2. P1: Workers フィールドガード導入（5h）
3. P1: プロンプト強化（2h）
4. P2: 条件付きVerifier導入（3h）
5. P2: メトリクス追加とテスト整備（2h）

## 7. 受け入れ基準（Done条件）

- 「何をする時」と「何が原因で」の同一文率が大幅低下する。
- `whyDangerous` 欠落時に `workDescription` 由来の自動補完が発生しない。
- 混同疑い入力時、`nextAction=ask_why` へ適切に戻せる。
- 既存会話フロー（危険度・対策・完了）に回帰がない。

## 8. 追加テスト提案

### Unit
- `tests/unit/mergeExtractedData.test.ts`
  - `whyDangerous` 欠落 + `workDescription` のみ -> 原因欄が埋まらないこと
- 新規 `tests/unit/workers/fieldGuard.test.ts`
  - 作業文混入を除外できること
  - 妥当な原因文は保持されること

### Integration
- `tests/integration/integration.test.ts`
  - 混同ケースで `ask_why` に補正されること

### E2E
- 1件目の入力で
  - `何をする時` のみ入力 -> `何が原因で` は空欄維持
  - 原因入力後にのみ `何が原因で` が埋まる

## 9. 補足

今回の現象は、AIモデル単体の精度問題というより、
「抽出欠落時の自動補完ポリシー」と「意味検証の不在」によるシステム設計上の問題が支配的です。

そのため、最短で効く対策は **P0（補完停止）+ P1（ガード導入）** です。

## 10. 実装状況（2026-02-14）

対応済み:
- P0: `src/lib/chat/mergeExtractedData.ts` で `whyDangerous` の推論補完を停止。
- P1: `workers/lib/chat/fieldGuard.ts` を新規追加し、作業文混入の検知/除外を実装。
- P1: `workers/lib/chat/execution.ts` で guard 適用後、必要時に `ask_why` 再質問文へ補正。
- P1: `workers/prompts/soloKY.ts` に混同防止ルール（NG/OK例）を追加。
- テスト: `tests/unit/workers/fieldGuard.test.ts` を追加し、既存テストを更新。
