# Phase 2/3 Roadmap : Voice KY Assistant

**更新日**: 2026-01-27  
**対象**: Phase 2.0-2.10 / Phase 3.0  
**前提**: Phase 2.0 は v2-modern 基盤として実施済み（詳細は後述）。

---

## 0. 参照レビュー/検討事項（要点）

- **R1: Phase 1 総括レビュー**  
  ストリーミング未実装、天候APIキャッシュ未実装、強固な認証の未導入が Phase 2 での課題。  
- **R2: 実装計画レビュー（v2）**  
  API保護・レート制限・鍵管理、iOS音声制約、データモデル必須項目の不整合、JSON回復、PDF方針、テスト不足が指摘。  
- **R3: 品質改善提案**  
  5W1H深掘り、4Rフロー、マンネリ打破（文脈注入）が品質向上の主軸。  
- **R4: 徹底検証レポート**  
  騒音下の音声限界 → **テキスト主導+音声補助**、RAG優先、ペルソナ調整、KPI計測が重要。  
- **R5: レポジトリレビュー**  
  Origin制限のみの認証、入力長/禁止語などサーバー側検証の不足が残課題。
- **R6: Phase 2.x 機能拡張一覧**  
  機能カタログとして、公式ロードマップへの対応フェーズを付与済み。  
  `02_Feature_Expansion_Phase2x.md` を参照。
- **R7: Phase 2.10 検証レポート**  
  実費テストにて `gpt-5.2` の採用とAPIタイムアウト延長(30s)を決定。コスト目標(5円/回)をクリア。

---

## 1. フェーズ方針

- **Phase 2**: 「安全運用 + 対話品質 + 現場適合」を最優先。音声は補助とし、**テキスト主導で成立**させる。  
- **Phase 3**: **大幅機能追加**。リアルタイム音声、組織運用、完全デジタル化、ナレッジ循環を統合。

---

## 2. Phase 2.0 実施済み（1.0からの改善事項）

| 改善テーマ | 1.0 (MVP) | 2.0 (v2-modern) | 効果 |
| :--- | :--- | :--- | :--- |
| フロント基盤 | Vanilla JS中心 | React 19 + Vite + TypeScript + Tailwind | コンポーネント化/型安全/DX向上 |
| 状態管理 | グローバル変数中心 | ZustandによるStore管理 | 状態の見通し・バグ低減 |
| バックエンド構成 | Workers単一ファイル/if分岐 | Honoルーティング + Pages/Workers分離 | ルーティング整理/保守性 |
| PDF生成 | jsPDF系の単体実装 | @react-pdf/renderer + 日本語フォント運用 | レイアウト安定/日本語品質 |
| セキュリティ運用 | ローカル変数管理中心 | Workers secret運用（wrangler secret） | キー露出リスク低減 |
| 品質基盤 | 手動中心 | ESLint/Playwright/Vitestの導入 | 変更検証の土台 |

---

## 3. Phase 2.1-2.10 ロードマップ

**補足**: 詳細な機能候補は `02_Feature_Expansion_Phase2x.md` を参照。  
**Phase 2.1** は運用防御（認証/レート制限/入力検証）に限定し、UX拡張は 2.2/2.5 で扱う。

| Phase | 目的 | 主要機能/変更 | 完了条件（判定しやすい形） | 根拠 |
| :--- | :--- | :--- | :--- | :--- |
| **2.1** | 運用防御とコスト制御 | レート制限/鍵管理/Origin強化<br>入力検証（長さ・禁止語・役割制限）<br>APIコスト監視/アラート | **完了 (Verified)**<br>公開APIの濫用防止、不正リクエスト遮断を確認済み | R1, R2, R5 |
| **2.2** | 会話・データ安定化（テキスト主導） | **[一部保留]** リファクタリング<br>テキスト入力主導 + 音声補助<br>~~タグ選択UI~~（保留）<br>**データモデル optional 化（O-02 実装済）**<br>JSONバリデーション/リトライ/回復<br>~~待機フィラー~~（保留） | **完了 (Implemented)**<br>O-02 実装済み（Partial型対応）<br>F-01/04/07 は保留 | R2, R4 |
| **2.3** | **履歴管理・データ永続化 (History)** | ローカルDB実装(IndexedDB/Dexie.js)<br>履歴一覧・詳細UI<br>引用開始・コピー機能<br>データエクスポート(CSV/JSON) | **完了 (Implemented)**<br>HIS-01〜04 実装済み<br>履歴保存/参照/エクスポート機能実装 | User Req |
| **2.4** | 対話品質の向上 | 5W1H深掘り + 段階的負荷<br>選択式深掘り + 4R/重要危険の選択UI<br>テンプレローテ/逆張り + ペルソナ「新人記録係」<br>短い振り返り（メタ認知） | **完了 (Implemented)**<br>抽象回答が具体化されること<br>重要危険が毎回1つ選ばれること<br>自己決定感の簡易評価が維持/向上 | R3, R4 |
| **2.5** | 体験速度・信頼性・可観測性 | SSEストリーミング表示<br>天候APIキャッシュ<br>Sentry/ログ/KPI収集 | **完了 (Implemented)**<br>体感待ち時間が短縮<br>障害/品質が定量的に追える | R1, R2 |
| **2.6** | 事後フィードバック・補強 | KY品質フィードバック(ポジティブ評価)<br>AI自動補足(抜け漏れカバー)<br>行動目標添削 | **完了 (Implemented)**<br>「褒めて伸ばす」サイクル<br>安全性の最終担保 | User Req |
| **2.7** | **コンテキスト注入/ナレッジ循環** | 過去ヒヤリハット/昨日指摘の参照<br>簡易RAG（履歴検索 + プロンプト注入）<br>天候/曜日の文脈強化 | **完了 (Verified)**<br>「毎回同じ助言」を抑制<br>過去の危険が再利用される | R3, R4 |
| **2.10** | **品質・性能検証 (Validation)** | **実費テストフィールド (VAL-01)**<br>高精度モデル`gpt-5.2`採用 (VAL-02)<br>APIタイムアウト延長 (INF-01) | **完了 (Implemented)**<br>コスト目標内での品質向上達成<br>504エラー解消 | R7 |

---

## 4. Phase 3.0（大幅機能追加）

| テーマ | 主要機能 | 期待価値 | 前提/リスク |
| :--- | :--- | :--- | :--- |
| **リアルタイム音声/ハンズフリー** | Realtime API（音声to音声）<br>割り込み/Push-to-Talk/VAD<br>騒音対策とTTSエコー制御 | “話して終わる”体験へ | 音声成功率の実測が必要（KPI） |
| **組織運用/監査** | SSO/JWT/Access<br>組織・現場単位の権限管理<br>監査ログ/管理ダッシュボード | 複数現場での運用が可能 | 法務/運用要件の整理が必要 |
| **完全デジタルKY** | 電子署名・承認フロー<br>PDF高品質化（日本語フォント）<br>帳票テンプレのカスタム | 紙運用からの脱却 | PDF方式と法的要件が鍵 |
| **ナレッジ循環プラットフォーム** | 現場特化ナレッジDB<br>リスク傾向分析/レコメンド | 「飽きる」を根本解消 | 十分なデータ蓄積が必要 |
| **AI依存リスク低減** | プロバイダ抽象化<br>ローカルLLM検討 | 価格・停止リスクの緩和 | 品質/コスト検証が必要 |

---

## 5. 実装候補の評価表（選定しやすい形式）

**評価軸**  

- 影響度: ユーザー価値の大きさ（1-5）  
- リスク低減: セキュリティ/運用/コストの改善（1-5）  
- 検証価値: 早期に仮説検証できる度合い（1-5）  
- 前提度: 他機能の前提になる度合い（0-2）  
- 実装難易度: 高いほど難しい（1-5）  
- **優先度スコア = 影響度×2 + リスク低減 + 検証価値 + 前提度 - 実装難易度**

**表は優先度の高い順**

| 候補機能 | 根拠 | 影響 | 低減 | 検証 | 前提 | 難易度 | 優先度 | 推奨Phase | 判断理由（要約） |
| :--- | :--- | :---: | :---: | :---: | :---: | :---: | :---: | :--- | :--- |
| API保護（レート制限/鍵管理） | R2, R5 | 4 | 5 | 3 | 2 | 2 | 16 | 2.1 | **[実装済]** コスト暴騰/不正利用の最短封じ |
| テキスト主導 + タグUI | R2, R4 | 5 | 3 | 4 | 1 | 3 | 15 | 2.2 | 騒音/端末制約でも成立する中核体験 |
| JSON回復 + データモデル柔軟化 | R2 | 4 | 4 | 3 | 2 | 3 | 14 | 2.2 | 破損/未入力でセッション停止を防ぐ |
| 段階的負荷 + 選択式深掘り | R3, R4 | 5 | 2 | 4 | 1 | 3 | 14 | 2.4 | 反発低減と自己決定感の確保 |
| KPI/具体性スコア計測 | R4 | 4 | 2 | 5 | 1 | 2 | 14 | 2.5 | 成果検証のスピードが上がる |
| RAG（過去/昨日の危険） | R4 | 5 | 2 | 4 | 1 | 4 | 13 | 2.3 | “飽きる”問題の本質対策 |
| 4R + 深掘り質問 + ペルソナ | R3, R4 | 5 | 2 | 3 | 0 | 3 | 12 | 2.4 | KY品質の差別化に直結 |
| 組織管理/監査 | R1, R5 | 4 | 4 | 2 | 1 | 4 | 11 | 3.0 | 企業導入の前提条件 |
| AIプロバイダ抽象化 | R4 | 3 | 4 | 2 | 1 | 3 | 10 | 3.0 | 価格/停止リスクの回避策 |
| 質問テンプレローテ + 逆張り質問 | R3, R4 | 4 | 1 | 3 | 0 | 2 | 10 | 2.4 | マンネリ抑止と注意の分散 |
| 短い振り返り（メタ認知） | R3, R4 | 3 | 1 | 3 | 0 | 1 | 9 | 2.4 | 内省を定着させ質を底上げ |
| SSEストリーミング | R1 | 3 | 1 | 2 | 0 | 2 | 7 | 2.5 | 体感速度改善だが必須度は中 |
| 天候APIキャッシュ | R1 | 2 | 2 | 2 | 0 | 1 | 7 | 2.5 | 低コストで安定性を上げる |
| Realtime音声対話 | R1, R4 | 4 | 2 | 2 | 0 | 5 | 7 | 3.0 | 価値は高いが技術/運用リスク大 |
| 電子署名 + PDF強化 | R2, R4 | 3 | 2 | 2 | 1 | 4 | 7 | 3.0 | 法務/技術依存が大きく後回し |

---

## 6. 採用カタログID（05から反映）

- **2.2**: F-01, F-02, F-04, F-05, F-06, F-07, O-01, O-02  
- **2.3**: L-03, L-06, C-01, C-03  
- **2.4**: L-01, L-04, L-05, P-01, P-02, P-03, P-04, P-05  
- **2.5**: O-03, O-04, O-05  
- **2.10**: VAL-01, VAL-02, INF-01
- **3.0**: D-01, D-02, D-03  

※ 判定の詳細は `02_Feature_Expansion_Phase2x.md` を参照。

このロードマップは「何をなぜやるか」を明確化し、実装判断を短時間で行えるように整理したものです。
