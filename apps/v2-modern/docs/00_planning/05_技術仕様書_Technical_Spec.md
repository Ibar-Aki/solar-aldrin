# Voice KY Assistant v2 技術構成資料

**デファクトスタンダード採用による「低コスト」「高信頼性」「持続可能性」の実現**

本資料は、Voice KY Assistant v2 における技術選定の意図と構成詳細を記述します。
市場で広く検証された技術（枯れた技術とモダン標準のバランス）を採用することで、長期運用に耐えうる設計としています。

**※ 詳細なER図やAPI設計については、[06_システム設計書_System_Design.md](06_システム設計書_System_Design.md) を参照してください。**

---

## 💡 技術構成のポイント (Key Highlights)

### 1. 圧倒的なコストパフォーマンス

**「1回のKY活動あたり 5円以下」** を実現します。
サーバーレス構成と最新AIモデルの選定により、ランニングコストを極限まで圧縮しました。

* **APIコスト**: OpenAI `gpt-4o-mini` 採用。1セッション(約3往復+要約)で 約2,000トークン と概算しても **約0.3円** 程度。
* **インフラコスト**: Cloudflare Pages/Workers の無料枠(10万回/日)内であれば **0円**。枠を超えても従量課金は極めて安価。
* **スケーラビリティ**: アクセス増によるサーバー増強コストがかからない（オートスケール）。

### 2. 生成AIの実装戦略 (Gen-AI Strategy)

AIを「魔法」としてではなく「信頼できるエンジン」として組み込みました。

* **システムプロンプト (Context Injection)**: 建設現場特有のコンテキスト（5W1H）を抽出するプロンプトを固定化し、回答のブレを抑制。
* **クライアント側データ抽出 (Current)**: 現在はAIの自然言語応答から「キーワードマッチング」でデータを抽出する方式を採用（Phase 2.2で構造化出力へ移行予定だったが保留中）。
* **JSONモード (Planned)**: 将来的にはAIの出力を構造化データ(JSON)として受け取ることで、堅牢性を高める計画。
* **RAG (将来拡張)**: 過去の災害事例検索など、独自データを注入しやすい構成(Vector Store連携)を見据えたAPI設計。

### 3. デファクトスタンダードの採用 (De Facto Standard)

奇をてらわず、現在のWeb開発における「最適解」とされる技術スタックを採用しました。
これにより、技術者の確保が容易になり、将来的な機能拡張や保守開発がスムーズに行えます。
（例: React, TypeScript, Cloudflare Workers）

---

## 🏗️ 全体アーキテクチャ

**「サーバーレス・エッジコンピューティング」** を全面的に採用しました。ユーザーの近くで動作する高速なレスポンスと、運用コストの最小化（Infra-as-Code）を両立させています。

---

## 🔧 技術スタック詳細

### 1. フロントエンド (UI/UX)

**標準技術による高い保守性**

| 技術 | 選定理由 |
| :--- | :--- |
| **React 19** | 世界で最も普及しているUIライブラリ。エコシステムの広さと技術情報の多さから採用。 |
| **Vite** | 現代のフロントエンド開発におけるビルドツールのデファクト。高速な開発サイクルを実現。 |
| **TypeScript** | 静的型付けによる品質担保。大規模開発や長期運用における必須標準。 |
| **Tailwind CSS** | ユーティリティCSSの業界標準。デザインの一貫性とCSS保守コスト削減のため採用。 |
| **Zustand** | Reactの状態管理における「New Standard」。Reduxより軽量で扱いやすく、開発速度を優先して採用。 |

### 2. バックエンド & インフラ (Edge)

**「持たない経営」を支えるサーバーレス構成**

| 技術 | 選定理由 |
| :--- | :--- |
| **Cloudflare Pages** | 静的配信のグローバル標準。エッジネットワークによる爆速配信で、現場の通信環境をカバー。 |
| **Cloudflare Workers** | V8アイソレート技術による超高速FaaS。AWS Lambdaよりも起動が速く(0ms)、安価。 |
| **Hono** | エッジ向けフレームワークの決定版。Web標準API準拠で、Express/Fastify経験者が即戦力として扱える。 |
| **Security Support** | `hono/cors` によるOrigin制限、カスタムMiddlewareによるレート制限(30req/min)を実装済み。 |

### 3. AI & 機能 (Core Features)

**実用性とコストのベストバランス**

| 技術 | 選定理由 |
| :--- | :--- |
| **OpenAI GPT-4o mini** | コスト効率最強のモデル。現場KYに必要な言語能力（論理的整合性）と、大量リクエストに耐えうる安さが決め手。 |
| **Web Speech API** | ブラウザ標準API。追加コストゼロで音声認識を実現し、アプリインストール不要で動作させるため。 |
| **@react-pdf/renderer** | クライアントサイドPDF生成の標準ライブラリ。サーバー負荷をオフロードし、コスト削減に寄与。 |
| **Dexie.js** | IndexedDBラッパー。履歴永続化・オフライン対応。Phase 2.3 で導入。 |
| **Zod** | スキーマバリデーション。型安全なデータ検証とランタイムエラー防止。 |

### 3.1 ユーティリティモジュール (Phase 2.3追加)

| モジュール | 役割 |
| :--- | :--- |
| **db.ts** | IndexedDB操作（Dexie.js）。セッション保存/取得/削除。遅延初期化パターン採用。 |
| **dateUtils.ts** | 日付フォーマット共通化（formatDate, formatDateLong, formatDateForFilename）。 |
| **exportUtils.ts** | CSV/JSONエクスポート。BOM付きUTF-8でExcel対応。エラーハンドリング付き。 |
| **validation.ts** | Zodスキーマ定義。ProcessPhaseSchema, HealthConditionSchema, SoloKYSessionSchema。 |

### 5. UX/UI 仕様 (Detailed UX Specs)

**現場の心理的負担を軽減するマイクロインタラクション**

#### UX-01: 待機フィラー (Waiting Filler)

AIの応答待ち時間（Latency）を「心理的な安心感」に変える演出。

* **Trigger**: ユーザー送信完了から **350ms** 後
* **Action**: 音声合成で「了解。」と発話 (Rate: 1.3〜1.5相当)
* **Condition**:
  * 即時応答（キャッシュヒット等）の場合は再生しないキャンセル制御を入れる（将来実装）。
  * 初期実装では「350ms待ってから再生開始」とし、AI応答がそれより早ければキャンセルする仕組みとする。

### 4. 品質保証 (Testing)

**モダンなテストピラミッドの構築**

| 技術 | 選定理由 |
| :--- | :--- |
| **Playwright** | E2Eテストの新標準。Safari (iOS) を含むマルチブラウザ検証が安定して行えるため採用。 |
| **Vitest** | Viteプロジェクトとの親和性が高いテストランナー。Jest互換で書きやすく、実行が高速。 |

---

## 🎯 結論: この技術選定のビジネス価値

1. **圧倒的低コスト**: ランニングコストを「誤差レベル」に抑え、全社導入へのハードルを排除。
2. **陳腐化リスクの低減**: マイナー技術を避け、業界標準に乗ることで、少なくとも今後5年は戦える基盤を構築。
3. **現場ファースト**: 技術的優位性（エッジ配信、軽量化）はすべて「現場での使いやすさ（速度）」に還元されている。

### 6. 将来の拡張構想 (Future Roadmap)

**UX-07 改: High-Performance Speech Pipeline**
現場の騒音下でも確実な入力を実現するための、ハイエンド音声認識構成。

* **Technology**: **Groq API** (LPU Inference Engine)
* **Model**: `distil-whisper-large-v3-en` (or equivalent Japanese optimized model)
* **Performance**:
  * **Latency**: < 500ms (Real-time factor ~100x)
  * **Cost**: ~$0.11 / hour (OpenAIの約1/3)
* **Architecture**:
  * Client: 音声をBlobとして録音
  * Edge (Workers): Groq APIへプロキシ送信
  * Response: テキストを即時返却
* **Advantage**: 建機ノイズ、方言、専門用語に対する圧倒的な認識耐性を、ブラウザ標準並みの速度で提供可能。
