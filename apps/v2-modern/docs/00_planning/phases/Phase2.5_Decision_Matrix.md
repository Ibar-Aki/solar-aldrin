# Phase 2.5 機能判定シート (Decision Matrix)

**目的**: Phase 2.5 (体験速度・信頼性・可観測性) で実装する機能の詳細を整理し、要否判定の材料とする。

**作成日**: 2026-01-30

---

## 📍 Phase 2.5 の位置づけ

ロードマップ (`03_Phase2ロードマップ`) における Phase 2.5 の定義：

> **体験速度・信頼性・可観測性**
> SSEストリーミング表示、天候APIキャッシュ、Sentry/ログ/KPI収集により体感待ち時間を短縮し、障害/品質を定量的に追える状態にする。

**完了条件**:

- 体感待ち時間が短縮される
- 障害/品質が定量的に追える

---

## ⚡ Phase 2.5 機能候補

### OPS-01: SSEストリーミング表示

| 項目 | 内容 |
| :--- | :--- |
| **概要** | AIの応答をServer-Sent Events (SSE) でストリーミング表示し、1文字ずつ表示する |
| **目的** | 「待っている」感覚を軽減し、体感速度を向上させる |
| **技術案** | OpenAI API の `stream: true` オプション + Workers SSE対応 |
| **コスト** | 中（Workers側のストリーム処理 + フロント側の逐次表示） |
| **リスク** | SSE接続の安定性、モバイル環境でのタイムアウト |
| **推奨案** | ✅ **採用 / ⚠️ 条件付き**（UX改善に必須だが、実装難度高） |
| **代替案** | **Loading Skeleton**: ストリーミング不採用時は、リッチなローディングアニメーションで「思考中」を明示する（必須）。 |

---

### OPS-02: 天候APIキャッシュ

| 項目 | 内容 |
| :--- | :--- |
| **概要** | 天候API（OpenWeatherMap等）のレスポンスをキャッシュし、APIコスト削減と応答速度向上を図る |
| **技術案** | Cloudflare KV または Workers Cache API で1時間〜24時間キャッシュ |
| **コスト** | 低（KVストア設定 + キャッシュロジック追加） |
| **リスク** | キャッシュ期間中の天候変化を反映できない（許容範囲） |
| **推奨案** | ✅ **採用**（低コストで安定性向上） |

---

### OPS-03: エラー監視（Sentry導入）

| 項目 | 内容 |
| :--- | :--- |
| **概要** | フロントエンド/Workers のエラーを Sentry に集約し、障害を迅速に検知する |
| **目的** | 本番環境での問題を早期発見・対応する |
| **技術案** | `@sentry/browser` + `@sentry/cloudflare` の導入 |
| **コスト** | 低〜中（SDK導入 + DSN設定） |
| **リスク** | 無料枠の制限（月5000イベント） |
| **推奨案** | ✅ **採用**（運用必須） |

---

### OPS-04: 構造化ログ（Workers Logs）

| 項目 | 内容 |
| :--- | :--- |
| **概要** | Workers の `console.log` を構造化JSON形式にし、Cloudflare Logs で分析可能にする |
| **目的** | デバッグ・障害調査の効率化 |
| **実装案** | ログユーティリティ関数を作成し、リクエストID/ユーザー情報を付与 |
| **コスト** | 低（ユーティリティ関数の作成） |
| **リスク** | **個人情報(PII)漏洩**: 作業内容などをそのままログに残すとGDPR/個人情報保護法に抵触する恐れあり。**マスキング必須**。 |
| **推奨案** | ✅ **採用**（ただしPIIマスクを条件とする） |

---

### OPS-05: KPI収集（具体性スコア等）

| 項目 | 内容 |
| :--- | :--- |
| **概要** | KY活動の品質指標（入力文字数、具体性スコア、所要時間等）を収集・可視化する |
| **目的** | 改善効果を定量的に評価し、次の施策を判断する |
| **技術案** | Cloudflare Analytics Engine または外部BIツール連携 |
| **コスト** | 中（データ収集パイプライン + 可視化ダッシュボード） |
| **リスク** | KPI定義の曖昧さ、収集コスト |
| **推奨案** | ⏸ **段階的採用**（まず基本指標から開始） |

---

### OPS-06: パフォーマンス計測（Web Vitals）

| 項目 | 内容 |
| :--- | :--- |
| **概要** | LCP/FID/CLS などの Core Web Vitals を計測し、UX品質を監視する |
| **技術案** | `web-vitals` ライブラリ + Cloudflare Browser Insights |
| **コスト** | 低（ライブラリ追加のみ） |
| **リスク** | モバイル Safari での計測精度 |
| **推奨案** | ✅ **採用**（低コストで品質監視） |

---

### OPS-07: AI信頼性モニタリング (New)

| 項目 | 内容 |
| :--- | :--- |
| **概要** | AIの応答エラー率（JSONパース失敗率、型不整合率）を監視する |
| **目的** | 「サイレントな機能不全」を防ぎ、プロンプト改善のトリガーにする |
| **技術案** | Worker内の `safeParse` 失敗回数を指標として記録 (Sentry/Log) |
| **コスト** | 極低（既存のバリデーションロジックに計測追加のみ） |
| **推奨案** | ✅ **採用**（Phase 2dの成果を運用に乗せるために必須） |

---

## 📊 判定サマリ

| ID | 機能名 | コスト | 推奨 (A-C) | ユーザー判定 | 実装状況 | 備考 |
| :--- | :--- | :--- | :---: | :--- | :--- | :--- |
| **OPS-01** | SSEストリーミング | 中 | A | ❌ 不採用 | ❌ 未実装 | **代替案必須**: Loading Skeleton実装のこと |
| **OPS-02** | 天候APIキャッシュ | 低 | B | ❌ 不採用 | ❌ 未実装 | 自己申告で十分 |
| **OPS-03** | Sentry導入 | 低〜中 | A | ✅ 採用 | ❌ 未実装 | エラー監視必須 |
| **OPS-04** | 構造化ログ | 低 | B | ✅ 採用 | ❌ 未実装 | **PIIマスキング必須** |
| **OPS-05** | KPI収集 | 中 | B | ✅ 採用 | ⚠️ テストのみ | 実費テストで一部実施済 |
| **OPS-06** | Web Vitals | 低 | B | ✅ 採用 | ❌ 未実装 | |
| **OPS-07** | AI信頼性監視 | 極低 | A | ✅ 採用 | ❌ 未実装 | バリデーションエラー率の監視 |

---

## 📝 今後のアクション

- **OPS-03 (Sentry)**: 本番公開前に最優先で導入する。
- **OPS-07 (AI Reliability)**: Sentry導入時、Zodエラーをタグ付きで送信するように実装する（最優先）。
- **OPS-04**: PIIマスキング設計を行った上で導入する。
- **OPS-01**: ストリーミング不採用の代償として、リッチなローディング表示 (Skeleton UI) を実装する。
- **OPS-05**: 基本指標の計測から開始する。
