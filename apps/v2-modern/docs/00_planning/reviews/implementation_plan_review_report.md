# Phase 2.2 Refactoring 実施可否レポート

## 1. 目的
本レポートは、`implementation_plan.md` に記載された Phase 2.2（コード健全化）について、
「実施すべきかどうか」を判断できるように、メリット・デメリット・保留選択肢・実施条件を整理したものです。

対象スコープ：
- RF-01：構造化出力の導入（LLMレスポンスのJSON化）
- RF-02：Store分割（状態管理の責務分割）

## 2. 前提・背景
- Phase 2.2 は、機能追加に先立って「品質と保守性の底上げ」を目的とする。
- 既存のクライアント側抽出ロジックは脆く、保守性・安定性の課題がある。
- Store構造は肥大化傾向にあり、将来的な拡張コストが増大している。

## 3. 実施可否の観点
以下の軸で評価する：
- 安定性（障害・失敗率）
- 保守性（変更容易性・責務分離）
- ユーザー影響（既存データ・UX）
- 運用コスト（デバッグ・監視・移行）
- 将来拡張性（機能追加のしやすさ）

## 4. RF-01 構造化出力の導入
### 4.1 メリット
- 抽出の安定性向上：正規表現や自然言語解析の曖昧さを排除。
- サーバー側で一元管理でき、保守性・テスト性が向上。
- フロントのロジック簡素化により、バグ混入リスクが低下。

### 4.2 デメリット・リスク
- JSONパース失敗：モデル出力が仕様から逸脱すると会話が崩れる。
- モデル依存度が上がる：モデル更新で挙動が変わる可能性。
- エラー時のユーザー体験悪化：無応答に見えるリスク。

### 4.3 保留の選択肢
以下に該当する場合は保留が合理的：
- モデル/API仕様が安定していない。
- 失敗時のフォールバックが設計されていない。
- 直近でモデル変更が予定されており、不確実性が高い。

### 4.4 実施する場合の最低条件
- 失敗時フォールバック（従来抽出 or 返信のみで継続）。
- パース失敗率の計測（ログ・メトリクス）。
- JSONスキーマ検証（必須フィールド欠落時の制御）。

## 5. RF-02 Store分割
### 5.1 メリット
- 責務分離により保守性が向上。
- 変更範囲が局所化され、テスト容易性が向上。
- 将来の拡張（機能追加や画面分割）に耐えやすい構造になる。

### 5.2 デメリット・リスク
- localStorage互換性が切れ、既存状態がリセット。
- 永続化設定の不備でデータ欠落が起きる可能性。
- 移行時のテストコストが増加。

### 5.3 保留の選択肢
以下に該当する場合は保留が合理的：
- 既存ユーザーが存在し、状態リセットが許容できない。
- 直近でUXやフローの大幅変更が予定されている。
- まだストア構成が固まっておらず、再分割リスクが高い。

### 5.4 実施する場合の最低条件
- リセットの明示（ユーザー通知 or 開発フェーズ明記）。
- 分割後の persist 設計レビュー。
- 検証用のシナリオテスト（データ復元の確認）。

## 6. 実施判断の整理（まとめ）
### 推奨（開発フェーズ前提）
- RF-01：段階導入＋フォールバック付きで実施を推奨。
- RF-02：開発フェーズであれば実施を推奨。

### 保留が合理的な条件
- RF-01：モデル/APIの不確実性が高い場合。
- RF-02：運用ユーザーの状態保持が重要な場合。

## 7. 実施判断のためのチェックリスト
- [ ] JSONパース失敗時の挙動が定義されているか
- [ ] モデル出力の失敗率を測定できるか
- [ ] localStorageリセットが許容される状況か
- [ ] Store分割後のpersist設計は確認済みか
- [ ] 移行後の動作確認シナリオが用意されているか

## 8. 結論
Phase 2.2 の目的が「健全化」である以上、RF-01は前向きに実施する価値が高い。
RF-02は「土台作り」の側面が強く、開発フェーズであれば早期実施が有利。
ただし、どちらも「失敗時の影響」と「移行リスク」を抑える仕組みが必要であり、
それらが整わない場合は段階導入または保留が合理的である。

---

作成日: 2026-01-27
対象ファイル: implementation_plan.md
