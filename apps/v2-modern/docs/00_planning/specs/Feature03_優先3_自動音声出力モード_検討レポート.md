# 2: 自動音声出力モード + 通常モード切替 検討レポート（v2-modern）

- 作成日時: 2026-02-06 23:31:11 +09:00
- 作成者: Codex＋GPT-5
- 対象: AI応答受信後の自動読み上げと簡易モード切替
- 検討前提: 現状の手動読み上げ（`ChatBubble`）を拡張
- 本レポート作成見積: 1.5時間

## 1. 背景と現状

現状の音声機能は以下です。

- `useTTS` による読み上げ基盤あり
- `ChatBubble` でAIメッセージごとの手動読み上げボタンあり
- `MicButton` はTTS中に音声認識を停止する連携あり
- 自動読み上げモードは未実装

## 2. 解決したい課題

- 毎回読み上げボタンを押す操作負荷
- 現場状況で「自動/手動」をすぐ切り替えたい
- 連続応答時の重複再生や割り込みの制御が必要

## 3. 選択肢比較

| 案 | 内容 | UX | 実装難易度 | 備考 |
| --- | --- | --- | --- | --- |
| A | 全メッセージ自動読み上げ固定 | 中 | 低 | 使い勝手が限定的 |
| B | グローバル切替（自動/通常） + 手動再生併存 | 高 | 中 | 最も実用的 |
| C | 画面単位で自動ON/OFF | 中 | 中 | 学習コストが上がる |

## 4. 推奨案

**推奨: B（グローバル切替 + 手動併存）**

- セッション画面上部に1トグル配置
- `自動音声出力` ON時は「新規AI応答のみ」自動再生
- 既存の手動ボタンは維持（任意再生・再聴取用）

## 5. 変更仕様（UI/API/型/運用）

### 5.1 状態管理

- `src/stores/useTTSStore.ts`
  - `playbackMode: 'manual' | 'auto'`
  - `lastAutoSpokenMessageId: string | null`
  - `setPlaybackMode()` を追加

### 5.2 画面/UI

- `src/pages/KYSessionPage.tsx`
  - ヘッダーにモード切替スイッチを追加
  - 表示例: `音声: 通常 / 自動`

### 5.3 再生制御

- 新規AIメッセージ追加を監視し、条件一致で `useTTS().speak()` 実行
- 自動再生条件
  - `role === 'assistant'`
  - `playbackMode === 'auto'`
  - `message.id !== lastAutoSpokenMessageId`

### 5.4 競合制御

- 自動再生中に手動停止した場合はそのメッセージの再自動再生を抑止
- 連続応答時は最新優先（旧読み上げをキャンセル）

## 6. 実装工数概算

| 作業 | 工数（人日） | 内容 |
| --- | --- | --- |
| TTS Store拡張 | 0.8 | モード・状態追加 |
| KYSessionPage UI | 0.7 | 切替UI追加 |
| 自動再生制御 | 1.0 | 新規応答監視・重複防止 |
| テスト | 1.0 | unit + e2e |
| 合計 | **3.5人日** |  |

最小スコープ（UI簡易 + 基本挙動のみ）は **2.0〜2.5人日**。

## 7. テスト観点

- 自動ONでAI応答時に1回だけ再生される
- 自動OFFで従来どおり手動再生のみ
- ON/OFF切替が即時反映される
- TTS中の音声認識停止連携が維持される

## 8. リスクと対策

- リスク: 同一メッセージの重複再生
  - 対策: `lastAutoSpokenMessageId` による再生済み管理
- リスク: 読み上げ遅延で会話テンポ低下
  - 対策: 長文時の先頭要約読み上げオプションを将来拡張

## 9. 受け入れ基準

- トグル1操作で自動/通常を切替できる
- 自動モードで新規AI応答が自動再生される
- 通常モードで既存UX（手動再生）が維持される

## 10. 公式参照

- Text to Speechガイド: https://platform.openai.com/docs/guides/text-to-speech
- Realtime会話（将来拡張の参考）: https://platform.openai.com/docs/guides/realtime-conversations
