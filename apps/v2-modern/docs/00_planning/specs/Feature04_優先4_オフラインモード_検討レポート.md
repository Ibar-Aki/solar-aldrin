# 1: オフラインモード追加 検討レポート（v2-modern）

- 作成日時: 2026-02-06 23:31:11 +09:00
- 作成者: Codex＋GPT-5
- 更新日: 2026-02-07
- 対象: セッション中の入力継続とオンライン復帰時同期
- 検討前提: 現場利用（電波不安定）で入力停止を防ぐ
- 本レポート作成見積: 2.0時間

## 1. 背景と現状

現状は以下です。

- 会話生成は `POST /api/chat` 依存（オンライン必須）
- 完了セッション保存は IndexedDB（Dexie）でローカル保持済み
- オフライン時は送信失敗し、会話進行が停止

## 2. 解決したい課題

- 電波が切れた時にKY入力自体が止まる
- 再送制御がなく、復帰後の再開が手動依存
- オフライン中にどこまで記録できたかが利用者に見えにくい

## 3. 選択肢比較

| 案 | 内容 | UX | 実装難易度 | 備考 |
| --- | --- | --- | --- | --- |
| A | オフライン時は送信不可表示のみ | 低 | 低 | 最短だが改善効果が小さい |
| B | 送信キュー方式（Store-and-forward） | 高 | 中 | 現実的かつ効果が高い |
| C | 完全ローカルAI推論 | 最高 | 高 | 端末制約・運用負荷が大きい |
| D | ルール/テンプレ駆動の完全オフライン完結（必須項目をシステム補完） | 中〜高 | 中 | 常時オフラインでも開始〜完了可能 |
| E | D + ローカルAI補助（候補生成/言い換えのみ） | 高 | 高 | Cの要素を限定導入した折衷案 |

## 4. 推奨案

**推奨: D（完全オフライン完結 + システム補完）**

- 常時オフラインでも、開始から完了まで到達できるフローを採用
- AI会話の代替として、状態遷移とテンプレ質問で必須項目を順次収集
- 未入力項目は「候補提示 + 最終確認」でシステム的に補完
- オンライン時は任意でクラウドAI補強（品質向上）を追加可能

採用理由:

- 「ずっとオフラインでも完了できる」という要件に唯一確実に対応
- Cより工数・運用リスクを抑えつつ、業務ルール充足を担保できる
- 既存のIndexedDB/状態管理資産を活用できる

## 5. 変更仕様（UI/API/型/運用）

### 5.1 データ層

- `src/lib/db.ts`
  - Dexie schemaをバージョンアップ
  - `pendingRequests` テーブル追加
    - `id`, `sessionId`, `type`, `payload`, `createdAt`, `retryCount`, `status`

### 5.2 APIクライアント

- `src/lib/api.ts`
  - `navigator.onLine` と fetch例外を区別
  - D案では、オフライン時にAPI呼び出しを行わずローカル状態遷移を優先
  - オンライン復帰時のみ、任意で要約/添削APIを呼ぶ

### 5.3 チャット制御

- `src/hooks/useChat.ts`
  - D案: `nextAction` をローカル状態機械で進行（ask_work -> ... -> completed）
  - 必須項目未入力時は次質問へ進めないガードを実装
  - 補完ロジック:
    - 空欄時に定型候補を提示
    - 候補未選択時は「保留」タグで一時保存し、完了前に再確認
  - E案: ローカルAIが使える端末のみ、候補文の自動生成を併用（失敗時はD案へフォールバック）

### 5.4 UI

- `src/pages/KYSessionPage.tsx`
  - 接続状態バナー（オンライン/オフライン）
  - 未送信件数表示
  - 手動同期ボタン（必要時）

### 5.5 運用

- D案では再送を必須にしない（ローカル完結が正）
- 同期機能は「任意のバックアップ/共有」用途に限定
- 不足項目が残る場合は完了不可とし、補完画面へ遷移

## 6. 実装工数概算

| 作業 | 工数（人日） | 内容 |
| --- | --- | --- |
| D: ローカル状態機械実装 | 2.5 | 必須項目収集フロー |
| D: 補完UI/候補提示 | 2.0 | 補完導線・再確認 |
| D: 保存/完了ガード | 1.5 | 保留管理・完了条件 |
| D: テスト | 2.0 | unit/integration/e2e |
| D小計 | **8.0人日** | 常時オフライン完結ライン |
| E追加: ローカルAI補助 | +4.0〜8.0 | 端末差吸収・フォールバック込み |

E案込みの全体は **12.0〜16.0人日**。

## 7. テスト観点

- 常時オフラインで開始→完了まで到達できる
- 必須項目不足時に完了ブロックされる
- システム補完候補を選択/編集して完了できる
- E案時、ローカルAI失敗でもD案へ自動フォールバックする

## 8. リスクと対策

- リスク: テンプレ対話が単調化し入力品質が低下
  - 対策: 候補パターンを工程/天候/体調で分岐
- リスク: 自動補完が不適切
  - 対策: 自動確定は禁止し、必ず利用者確認を通す
- リスク: 利用者の混乱
  - 対策: 進捗バーと不足項目表示を固定表示

## 9. 受け入れ基準

- 端末が常時オフラインでも、開始から完了まで到達できる
- 必須項目（作業/危険/理由/対策/危険度/目標）が欠けたまま完了できない
- 補完候補は必ずユーザー確認後に確定される
- E案有効時も、ローカルAI停止で機能継続できる

## 10. 公式参照

- Realtime/会話状態設計の参考: https://platform.openai.com/docs/guides/realtime-conversations
- 最新モデル選定方針: https://platform.openai.com/docs/guides/latest-model

## 11. 補足（非採用前提）: 完全ローカルAI案

本案は「多分採用しない」前提で、将来の再検討用メモとして最小限整理する。

- 想定方式:
  - 端末内で小型LLMを実行し、`作業/危険/対策` 抽出をローカル完結
  - 推論は `WebGPU` またはネイティブラッパー（モバイルアプリ化）を前提
- 期待効果:
  - 完全オフラインで会話継続可能
  - 通信不能時でも応答レイテンシが一定
- 主な非採用理由:
  - 端末性能差が大きく、対象デバイスの下限保証が難しい
  - モデル配布サイズ・更新運用・安全性検証の負荷が高い
  - 現行のWebアプリ構成では実装/検証コストに対する費用対効果が低い
- 概算工数（参考）:
  - PoC: 15〜20人日
  - 実運用品質まで: 35〜50人日（端末互換試験を含む）
- 再検討条件:
  - 対象端末を限定できる（会社貸与端末など）
  - オフライン必須要件が業務上の必須条件に変わる
  - モデル更新を集中管理できる配布基盤が用意できる

## 12. D案/E案の実装要件（詳細）

- D案（システム補完型・完全オフライン）
  - 実装中核:
    - ルールベース状態機械（会話順序を固定）
    - 必須入力チェック（未入力は次へ進めない）
    - 候補テンプレ（作業種別/危険種別/対策種別）
  - 「埋める」の定義:
    - 空欄を機械的に確定するのではなく、候補提示して利用者が最終確定する
    - 完了前チェックで不足項目を明示し、再入力を必須化する

- E案（D + C要素の限定導入）
  - 追加要件:
    - 端末能力が十分な場合のみローカルAIで候補文を生成
    - 生成失敗/遅延時はD案のテンプレ候補へ即時フォールバック
  - 適用範囲:
    - 文章改善、候補提案、重複統合など補助機能のみ
    - 完了判定ロジックはD案のルールベースで固定
