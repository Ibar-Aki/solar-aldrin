# Phase 2.5 機能判定シート (Decision Matrix)

**目的**: Phase 2.5 (体験速度・信頼性・可観測性) で実装する機能の詳細を整理し、要否判定の材料とする。

**作成日**: 2026-01-30

---

## 📍 Phase 2.5 の位置づけ

ロードマップ (`03_Phase2ロードマップ`) における Phase 2.5 の定義：

> **体験速度・信頼性・可観測性**
> SSEストリーミング表示、天候APIキャッシュ、Sentry/ログ/KPI収集により体感待ち時間を短縮し、障害/品質を定量的に追える状態にする。

**完了条件**:

- 体感待ち時間が短縮される
- 障害/品質が定量的に追える

---

## ⚡ Phase 2.5 機能候補

### OPS-01: SSEストリーミング表示

| 項目 | 内容 |
| :--- | :--- |
| **概要** | AIの応答をServer-Sent Events (SSE) でストリーミング表示し、1文字ずつ表示する |
| **目的** | 「待っている」感覚を軽減し、体感速度を向上させる |
| **技術案** | OpenAI API の `stream: true` オプション + Workers SSE対応 |
| **コスト** | 中（Workers側のストリーム処理 + フロント側の逐次表示） |
| **リスク** | SSE接続の安定性、モバイル環境でのタイムアウト |
| **推奨案** | ✅ **採用**（体感速度改善の効果大） |

---

### OPS-02: 天候APIキャッシュ

| 項目 | 内容 |
| :--- | :--- |
| **概要** | 天候API（OpenWeatherMap等）のレスポンスをキャッシュし、APIコスト削減と応答速度向上を図る |
| **技術案** | Cloudflare KV または Workers Cache API で1時間〜24時間キャッシュ |
| **コスト** | 低（KVストア設定 + キャッシュロジック追加） |
| **リスク** | キャッシュ期間中の天候変化を反映できない（許容範囲） |
| **推奨案** | ✅ **採用**（低コストで安定性向上） |

---

### OPS-03: エラー監視（Sentry導入）

| 項目 | 内容 |
| :--- | :--- |
| **概要** | フロントエンド/Workers のエラーを Sentry に集約し、障害を迅速に検知する |
| **目的** | 本番環境での問題を早期発見・対応する |
| **技術案** | `@sentry/browser` + `@sentry/cloudflare` の導入 |
| **コスト** | 低〜中（SDK導入 + DSN設定） |
| **リスク** | 無料枠の制限（月5000イベント） |
| **推奨案** | ✅ **採用**（運用必須） |

---

### OPS-04: 構造化ログ（Workers Logs）

| 項目 | 内容 |
| :--- | :--- |
| **概要** | Workers の `console.log` を構造化JSON形式にし、Cloudflare Logs で分析可能にする |
| **目的** | デバッグ・障害調査の効率化 |
| **実装案** | ログユーティリティ関数を作成し、リクエストID/ユーザー情報を付与 |
| **コスト** | 低（ユーティリティ関数の作成） |
| **リスク** | ログ量増加による可読性低下 |
| **推奨案** | ✅ **採用**（低コストで運用改善） |

---

### OPS-05: KPI収集（具体性スコア等）

| 項目 | 内容 |
| :--- | :--- |
| **概要** | KY活動の品質指標（入力文字数、具体性スコア、所要時間等）を収集・可視化する |
| **目的** | 改善効果を定量的に評価し、次の施策を判断する |
| **技術案** | Cloudflare Analytics Engine または外部BIツール連携 |
| **コスト** | 中（データ収集パイプライン + 可視化ダッシュボード） |
| **リスク** | KPI定義の曖昧さ、収集コスト |
| **推奨案** | ⏸ **段階的採用**（まず基本指標から開始） |

---

### OPS-06: パフォーマンス計測（Web Vitals）

| 項目 | 内容 |
| :--- | :--- |
| **概要** | LCP/FID/CLS などの Core Web Vitals を計測し、UX品質を監視する |
| **技術案** | `web-vitals` ライブラリ + Cloudflare Browser Insights |
| **コスト** | 低（ライブラリ追加のみ） |
| **リスク** | モバイル Safari での計測精度 |
| **推奨案** | ✅ **採用**（低コストで品質監視） |

---

## 📊 判定サマリ

| ID | 機能名 | コスト | 推奨 (A-C) | ユーザー判定 | 実装状況 | 備考 |
| :--- | :--- | :--- | :---: | :--- | :--- | :--- |
| **OPS-01** | SSEストリーミング | 中 | A | ❌ 不採用 | ❌ 未実装 | リスク回避のため不採用 |
| **OPS-02** | 天候APIキャッシュ | 低 | B | ❌ 不採用 | ❌ 未実装 | 自己申告で十分 |
| **OPS-03** | Sentry導入 | 低〜中 | A | ✅ 採用 | ❌ 未実装 | エラー監視必須 |
| **OPS-04** | 構造化ログ | 低 | B | ✅ 採用 | ❌ 未実装 | |
| **OPS-05** | KPI収集 | 中 | B | ✅ 採用 | ❌ 未実装 | 基本指標のみ実施 |
| **OPS-06** | Web Vitals計測 | 低 | B | ✅ 採用 | ❌ 未実装 | |

---

## 📝 今後のアクション

- **OPS-03 (Sentry)**: 本番公開前に最優先で導入する。
- **OPS-04/06**: 低コストなため、Sentry導入と合わせて設定を行う。
- **OPS-05**: まずは「セッション完了率」「所要時間」の計測から開始する。
- OPS-01/02 は今回のフェーズでは見送り、将来的な課題とする。
