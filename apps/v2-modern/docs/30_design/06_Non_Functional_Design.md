# 非機能設計（v2-modern）

**目的**: 性能・可用性・セキュリティ・運用・コストの横断要件を現行実装に合わせて整理する  
**作成日**: 2026-02-03 23:15  
**作成者**: Codex＋GPT-5  
**更新日**: 2026-02-06  
**更新日**: 2026-02-11（APIトークンの取り扱いを更新: フロントはlocalStorage保存、バンドル埋め込みを避ける）

---

## 1. 性能設計

- 非ストリーミングJSON応答を前提とする
- 入力長は `USER_CONTENT_MAX_LENGTH` と `MAX_TOTAL_INPUT_LENGTH` で制限する
- 会話履歴は `MAX_HISTORY_TURNS` で切り詰める
- 出力トークンは `MAX_TOKENS` で上限管理する
- コンテキスト注入は 1200文字以内に制限する
- JSONパース失敗時はフォールバック応答で継続する

---

## 2. 可用性・回復設計

- OpenAI呼び出し失敗は retriable として UI に再試行導線を出す
- チャットは TIMEOUT を 504 で返却する
- フィードバックは TIMEOUT を 408 で返却する
- フィードバックは 204 を許容し UI 側で安全にスキップする
- JSON検証エラーは 502 を返し、再試行できる状態を維持する

---

## 3. セキュリティ設計

- Origin Allowlist で許可オリジン以外を拒否する
- 本番では `API_TOKEN` による Bearer 認証を必須化する（`REQUIRE_API_TOKEN` で明示切替可能）
- フロントエンドはトークンを **バンドルへ埋め込まない**（漏えい前提になるため）。端末のブラウザ localStorage に保存し、必要時に `Authorization` を付与する
- レート制限は 1分あたり30回で KV を用いる
- 本番で `RATE_LIMIT_KV` が未設定の場合はフェイルクローズする
- 禁止語リストで危険入力を遮断する
- フィードバック入力はメール・電話・長い数値をマスクする

---

## 4. 可観測性設計

- `/api/metrics` に KPI イベントを送信する（認証必須）
- Analytics Engine 未設定時はログにフォールバックする
- `reqId` を用いた構造化ログで追跡可能にする
- ログ出力時に PII / Secret マスキングを適用する
- エラー種別は `logError` / `logWarn` で分類する

---

## 5. コスト最適化

- モデルは `gpt-4o-mini` を標準とする
- トークン上限で応答量を抑制する
- コンテキスト注入の長さ制限で入力トークンを抑える
- フィードバックはキャッシュ（5分）で再計算を避ける
- セッション保存はクライアント内に留めサーバー保存を抑える

---

## 6. データ保持とプライバシー

- 完了セッションは IndexedDB に保存する
- 履歴は最大100件・90日でローテーションする
- サーバー側に会話履歴を永続化しない

---

## 7. 運用・変更管理

- 機能の有効化は環境変数で制御する
- `ENABLE_FEEDBACK` と `ENABLE_CONTEXT_INJECTION` を切り替え可能にする
- `VITE_REQUIRE_API_TOKEN` によりクライアント側の送信制御を行う（トークン本体は localStorage に保存）
- エラー時はフォールバック応答を優先し停止を回避する
