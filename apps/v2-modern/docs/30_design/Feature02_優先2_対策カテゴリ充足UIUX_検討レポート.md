# 4: 対策カテゴリ2つ以上を埋めるUIUX 検討レポート（v2-modern）

- 作成日時: 2026-02-06 23:31:11 +09:00
- 作成者: Codex＋GPT-5
- 更新日: 2026-02-11
- 対象: 「保護具」「行動」「設備・準備」の3分類中2分類以上を確実に充足
- 検討前提: 現行の `countermeasures: string[]` を拡張
- 本レポート作成見積: 2.0時間

※追記: 2026-02-11 時点の実装では、要件更新により「2カテゴリ以上」ではなく「対策は合計2件以上（同カテゴリ2件OK）」を採用しています。詳細は `docs/30_design/Feature06_KYボード_UIUX_会話フェーズ分離_実装レポート.md` を参照してください。

## 1. 背景と現状

現状は以下です。

- 対策は文字列配列として保存（カテゴリ情報なし）
- 完了判定はカテゴリ充足を見ていない
- 利用者は「何が不足か」を画面で把握しにくい

## 2. 解決したい課題

- 対策が特定カテゴリに偏りやすい
- 2カテゴリ以上充足の業務ルールをシステムで担保したい
- 強制し過ぎず、現場で使えるUIUXにしたい

## 3. 選択肢比較

| 案 | 内容 | 実効性 | UX負荷 | 実装難易度 |
| --- | --- | --- | --- | --- |
| A | 完了時のみ厳格ブロック | 高 | 中 | 中 |
| B | 常時ガイドのみ（ブロックなし） | 中 | 低 | 低 |
| C | 進行中はガイド、完了時は最小ブロック | 高 | 低〜中 | 中 |

## 4. 推奨案

**推奨: C（ソフト誘導 + 最終ガード）**

- 会話中: 欠けカテゴリを見える化し、追加提案を出す
- 完了時: 2カテゴリ未満なら不足カテゴリを明示して戻す

採用理由:

- 形骸化を防ぎつつ、入力ストレスを最小化
- 業務ルール（2カテゴリ以上）を確実に達成できる

## 5. 変更仕様（UI/API/型/運用）

### 5.1 型・スキーマ

- `src/types/ky.ts`
  - 変更案:
  - `countermeasures: { category: 'ppe' | 'behavior' | 'equipment'; text: string }[]`
- `src/lib/kySchemas.ts`, `src/lib/schema.ts`
  - カテゴリ列挙のZod追加
  - セッション完了時に「カテゴリ種類数 >= 2」を検証

### 5.2 AI抽出

- `workers/prompts/soloKY.ts`
  - 対策抽出時にカテゴリ分類を返す指示を追加
- `workers/routes/chat.ts`
  - カテゴリ未確定時のフォールバック分類ロジック追加

### 5.3 UIUX

- `KYSessionPage` にカテゴリ進捗インジケータ追加
  - 例: `保護具 ✅ / 行動 ✅ / 設備・準備 ❌`
- 不足カテゴリに対するワンタップ候補文を提示
- 完了時不足なら「不足カテゴリ」カードを表示し、入力へ戻す

### 5.4 PDF/履歴

- PDF出力にカテゴリ別対策セクションを追加
- 履歴詳細でカテゴリ偏りを可視化

## 6. 実装工数概算

| 作業 | 工数（人日） | 内容 |
| --- | --- | --- |
| 型・スキーマ改修 | 1.5 | Type/Zod更新 |
| AI抽出改修 | 1.5 | プロンプト/ルート処理 |
| UI追加 | 2.0 | 進捗表示・不足誘導 |
| 完了ガード追加 | 1.0 | 判定・遷移制御 |
| PDF/履歴反映 | 1.0 | 表示整合 |
| テスト | 1.5 | unit/integration/e2e |
| 合計 | **8.5人日** |  |

最小スコープ（UI最小 + 完了ガードのみ）は **5.0〜6.0人日**。

## 7. テスト観点

- 1カテゴリのみ入力では完了不可（不足カテゴリ表示）
- 2カテゴリ入力で完了可能
- 3カテゴリ入力でも正常完了
- AI分類失敗時の手動修正導線

## 8. リスクと対策

- リスク: AIのカテゴリ誤分類
  - 対策: 利用者がカテゴリを手動変更可能にする
- リスク: 入力項目増加による離脱
  - 対策: 候補文とワンタップ登録を用意
- リスク: 既存データとの互換
  - 対策: 旧データを `behavior` 仮分類する移行処理

## 9. 受け入れ基準

- 3カテゴリ中2カテゴリ以上の充足がシステムで担保される
- 不足カテゴリが利用者に明確に示される
- 既存セッション表示/出力との互換が維持される

## 10. 公式参照

- Latest model guidance: https://platform.openai.com/docs/guides/latest-model
- Realtime conversations（将来の音声誘導連携の参考）: https://platform.openai.com/docs/guides/realtime-conversations

## 11. 追記（2026-02-11）

- 実装は「カテゴリ2つ以上」ではなく「対策合計2件以上（同カテゴリ2件OK）」を採用（業務要件の更新に追従）。
- UIはカテゴリ表示（設備・環境 / 人配置・行動 / 保護具）を維持し、会話側でカテゴリ観点の聞き取りを行う。
- 実装レポート: `docs/30_design/Feature06_KYボード_UIUX_会話フェーズ分離_実装レポート.md`
