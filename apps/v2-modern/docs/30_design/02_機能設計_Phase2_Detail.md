# 機能設計（Phase 2.1-2.5 詳細）

**目的**: 各フェーズの機能要件/設計/完了条件を実装可能な粒度で整理する

---

## Phase 2.1 運用防御とコスト制御

### 目的
- 公開APIの濫用防止とコスト暴騰リスクの最小化

### 設計要点
- **レート制限**: KVでIP/Origin単位のしきい値を管理
- **Origin制限**: Allowlist + 正規表現（開発/本番）
- **入力検証**: 長さ/禁止語/role制限（server側必須）
- **コスト監視**: 1セッションあたりのトークン/リクエスト数を記録

### 完了条件
- 429/403の発生が再現できる
- 不正なrole注入が遮断される

---

## Phase 2.2 会話・データ安定化（テキスト主導）

### 目的
- 騒音/端末制約下でも成立する入力体験を保証
- JSON破損や未入力でセッションが破綻しない

### 設計要点
- **テキスト主導**: 音声は補助。常時リスニング前提から脱却
- **タグUI**: よくある危険の選択式
- **データモデル optional化**: 未確定項目は後で埋められる
- **JSON回復**: 破損時は再問い合わせ/部分採用

### 完了条件
- 必須未入力でもセッション完了できる
- 破損JSONを安全に回復できる

---

## Phase 2.3 コンテキスト注入/ナレッジ循環

### 目的
- 「毎回同じ助言」を防ぎ、現場のリアリティを反映

### 設計要点
- **RAG**: 過去ヒヤリハット/昨日の指摘を検索して注入
- **天候/曜日文脈**: Weather API + 曜日ルール
- **範囲制御**: 現場単位/期間制限でプライバシーを保護

### 完了条件
- 直近の危険がプロンプトに反映される
- コンテキストがない場合は安全にスキップ

---

## Phase 2.4 対話品質の向上（心理設計）

### 目的
- 具体性と自己決定感を両立し、形骸化を防止

### 設計要点
- **段階的負荷**: 具体性スコアに応じて質問深度を可変
- **選択式深掘り**: 深掘り対象をユーザーが選ぶ
- **テンプレローテ**: A/B/Cの週次切替
- **逆張り質問**: 週1回の「見落とし質問」
- **短い振り返り**: 1行の内省入力

### 完了条件
- 具体性スコアが改善
- 自己決定感評価が維持/向上

---

## Phase 2.5 体験速度・信頼性・可観測性

### 目的
- 体感速度と運用品質の改善

### 設計要点
- **SSE**: 逐次応答でTTFT短縮
- **天候キャッシュ**: KVで10分TTL
- **Sentry/KPI**: 具体性スコア・音声成功率・再送数などを記録

### 完了条件
- SSEで逐次表示が確認できる
- KPIがダッシュボードに集計される

---

## 依存関係と優先度

- **2.1 → 2.2/2.3/2.4**: 防御設計が前提
- **2.2 → 2.4**: データの安定化が対話品質の前提
- **2.3/2.4 → 2.5**: KPI設計に先行して要件確定
