# セキュリティチェックレポート（v2-modern）

- 作成日時: 2026-02-06 21:17:40 +09:00
- 作成者: Codex＋GPT-5
- 更新日: 2026-02-06
- 更新日: 2026-02-08（チェックリスト参照先を移動後のパスへ更新）
- 対象チェックリスト: `docs/project/security/detailed-security-checklist.md`（旧: `詳細セキュリティチェックリスト.md`）
- 対象コードベース: `apps/v2-modern`
- 実施方針: コード・設定・ドキュメント監査のみ（修正実装なし）

## 1. 総括

- 判定概要:
  - `要改善`: 8項目
  - `部分適合`: 8項目
  - `適合`: 2項目
  - `要運用確認`: 4項目
- 重大な懸念:
  - プロンプト注入耐性不足（クライアント由来文字列が system prompt に連結）
  - API 認証が任意運用（`API_TOKEN` 未設定時は無認証）
  - ローカル秘密情報ファイルに実キーが存在（Git管理外だが漏えいリスク）
  - `hono@4.11.5` に既知脆弱性あり（`npm audit` 検出）

## 2. 主要指摘（優先度順）

| 重要度 | 指摘 | 根拠 |
|---|---|---|
| High | プロンプト注入耐性不足 | `workers/routes/chat.ts:83`, `workers/routes/chat.ts:87`, `src/lib/schema.ts:49` |
| High | API認証が必須化されていない | `workers/index.ts:157`, `workers/index.ts:159`, `README.md:37` |
| High | ローカルに実キー形式の秘密情報が存在 | `.dev.vars:1`, `.gitignore:27` |
| Medium | CORS許可が広く最小化未達 | `workers/index.ts:73`, `workers/index.ts:74`, `workers/index.ts:75`, `workers/index.ts:79` |
| Medium | レート制限がフェイルオープン寄り | `workers/middleware/rateLimit.ts:66`, `workers/middleware/rateLimit.ts:91` |
| Medium | 依存脆弱性（Hono） | `package.json:34`, `npm audit --omit=dev --json` |

## 3. チェックリスト判定

### 3.1 ネットワーク・通信

| 項目 | 判定 | コメント |
|---|---|---|
| HTTPS/TLSの強制 | 要運用確認 | Cloudflare側設定はリポジトリ外のため監査不能。 |
| CORS設定の最小化 | 要改善 | 許可範囲が開発/トンネル系まで広い。 |
| レート制限の適用 | 部分適合 | 実装あり。KV未設定時/例外時の挙動が弱い。 |

### 3.2 認証・認可

| 項目 | 判定 | コメント |
|---|---|---|
| APIトークンの存在と運用 | 要改善 | `API_TOKEN` 未設定で無認証になる。 |
| IDaaS連携計画の整合 | 部分適合 | 設計資料に将来計画あり。 |
| 端末前提アクセス制御の補強 | 要改善 | 認証/利用者分離/遠隔ワイプ未実装。 |

### 3.3 秘密情報・設定管理

| 項目 | 判定 | コメント |
|---|---|---|
| APIキーの秘匿 | 部分適合 | `.dev.vars` はGit ignore。ローカル実キー保持はリスク。 |
| 環境変数の最小権限 | 部分適合 | 未使用想定変数が残存。定期棚卸し未確認。 |

### 3.4 入力検証・データ整合性

| 項目 | 判定 | コメント |
|---|---|---|
| Zodバリデーション | 適合 | `chat`/`feedback`/`metrics` で実施。 |
| 音声入力のサニタイズ | 部分適合 | 長さ/制御文字検査はあるが、より強い正規化方針は未整備。 |
| AI応答の構造化と安全性 | 適合 | JSONモード + パース失敗フォールバックあり。 |

### 3.5 データ保護・保存

| 項目 | 判定 | コメント |
|---|---|---|
| IndexedDB/Dexie保護 | 要改善 | 端末内保存に暗号化なし。 |
| PDF生成データの扱い | 要改善 | 共有時統制/注意喚起の仕組みは未確認。 |
| ログ・計測のPII混入防止 | 部分適合 | 一部マスキングあり。統一ルール/運用保証は不足。 |

### 3.6 AI/LLM利用

| 項目 | 判定 | コメント |
|---|---|---|
| OpenAIデータ取り扱い方針 | 要運用確認 | 設計記載はあるが、契約設定の証跡未確認。 |
| プロンプト注入対策 | 要改善 | system prompt 連結に外部入力が混入可能。 |

### 3.7 エラー処理・再試行

| 項目 | 判定 | コメント |
|---|---|---|
| エラー分類と通知 | 部分適合 | 主要分類はある。運用での一貫性確認が必要。 |
| 再試行ポリシー適正化 | 要改善 | 現状 `MAX_RETRIES=1`、バックオフなし。 |

### 3.8 依存関係・ビルド

| 項目 | 判定 | コメント |
|---|---|---|
| 依存関係の脆弱性管理 | 要改善 | `hono` で moderate 脆弱性検出。 |
| ビルド成果物の改ざん防止 | 要運用確認 | CI/CD権限・監査設定はリポジトリ外。 |

### 3.9 監視・運用

| 項目 | 判定 | コメント |
|---|---|---|
| 監視とアラート有効化 | 部分適合 | Sentry/metrics実装あり。通知設計の証跡未確認。 |
| 監査ログの保全 | 要改善 | token単位追跡・保存期間定義の実装証跡なし。 |

## 4. 追加エビデンス

- 依存脆弱性確認:
  - コマンド: `npm audit --omit=dev --json`
  - 結果: `hono` に moderate 脆弱性（複数 GHSA、`<4.11.7`）
- 利用バージョン確認:
  - コマンド: `npm ls hono`
  - 結果: `hono@4.11.5`
- 秘密情報ファイル確認:
  - `.dev.vars` は `.gitignore` で除外 (`.gitignore:27`)
  - ただしローカルに実キー形式値が存在

## 5. 改善優先度（実装は未着手）

1. 認証必須化（本番で `API_TOKEN` 未設定を拒否）
2. プロンプト注入対策（system prompt と外部入力の境界強化）
3. CORS allowlist の本番最小化（開発用許可の分離）
4. ローカル秘密情報の再発行・失効運用（既存キー無効化）
5. `hono` の安全版への更新と再監査
6. 再試行戦略（上限・バックオフ）を設計要件に整合
