# localhost:8787 エラー起因の「AI応答失敗・リトライ非表示」修正レポート

- 作成日時: 2026-02-07 01:44:40
- 作成者: Codex+gpt-5.3-codex (codex-cli 0.98.0)
- 更新日: 2026-02-07

## 更新履歴
- 2026-02-07: 事象修正の差分・検証結果を追記。全体レビュー観点（未対応）を追記。
- 2026-02-07: `tests/e2e/pdf-visual.spec.ts` のスナップショット比較が揺れやすいため、安定化（小さな待機 + 局所リトライ）を追加。

## 1. 背景 / 事象
- PCブラウザでチャット送信すると、すぐに「応答に失敗しました」が表示される。
- リトライボタンが表示されない。
- 調査の結果、`http://localhost:8787` 周辺でエラーが起きていた（環境変数/アクセス先の混線の可能性）。

## 2. 原因（一次原因）
`apps/v2-modern/.env` に `VITE_API_BASE_URL=http://localhost:8787` が設定されている場合、フロントエンドのAPIクライアントが以下を叩いてしまいます。

- 期待: `http://localhost:8787/api/chat`
- 実際: `http://localhost:8787/chat`

この場合、Workers側は `/api/chat` を提供しているため、404/不正レスポンス扱いとなり、結果として「応答に失敗しました」+ `canRetry=false` になりやすく、UI上でリトライが出ない状態になります。

同様にテレメトリも、`VITE_API_BASE_URL` が絶対URLの場合に `${base}/metrics` へ送ってしまう可能性がありました（期待は `${base}/api/metrics`）。

## 3. 対応（機能追加ではなく不具合修正）
### 3.1 APIベースURLの正規化（/api 自動補完）
- `src/lib/apiBase.ts` を追加し、`VITE_API_BASE_URL` の解釈を統一しました。
  - 未指定: `/api`（Vite proxy 想定）
  - 絶対URL（`http://`/`https://`）: 末尾に `/api` が無ければ補完
    - 例: `http://localhost:8787` -> `http://localhost:8787/api`
  - 相対パス: 原則そのまま（末尾スラッシュのみ除去）
- `src/lib/api.ts` と `src/lib/observability/telemetry.ts` に適用しました。

### 3.2 `.env` の誤コミット防止
- `apps/v2-modern/.gitignore` に `.env` 等を追加しました（`.env.example` は例外として残す）。

## 4. 検証（Iteration: 1/3）
### 自動テスト
- `npm test`: パス（56 tests）
- `npm run lint`: パス
- `npm run test:e2e`: パス（18 passed / 6 skipped）

### 実費テスト（本番直結）
- 実施回数: 0/5（今回はローカル設定不備起因のため、実費テストは不要と判断）

## 5. 手動確認の観点（再現・確認手順）
1. ローカル起動
   - フロント: `npm run dev`（`http://localhost:5173`）
   - Workers: `npm run dev:workers`（`http://localhost:8787`）
2. ブラウザは `http://localhost:5173` を開く（8787はAPIサーバー）。
3. Networkタブで `POST http://localhost:8787/api/chat` になっていることを確認する。
   - `.env` が `VITE_API_BASE_URL=http://localhost:8787` のままでも、今回の修正で `/api` が補完される想定。

## 6. 残存リスク / 次アクション候補
- Workers側で `OPENAI_API_KEY` 未設定の場合は、当然チャットは失敗します（今回の問題とは別軸）。
  - `.dev.vars` 等の設定を確認してください。
- E2EのビジュアルスナップショットはOS差分が出やすいため、環境差分が大きい場合は運用方針（スナップショット管理）を別途決める必要があります。

## 7. リポジトリ全体レビュー（重要度順 / 未対応・判断待ち）
今回の修正は「localhost:8787 設定時に `/api` へ到達できない」という一次原因の除去に限定しています。以下は別件として残っている論点で、修正要否は改めて判断が必要です。

### [高] コスト爆発/悪用リスク
- レート制限がKV未設定時にメモリへフォールバックするため、本番の分散環境で実質無効化に近くなるリスク（設定/運用で回避可能だが、フェイルクローズ前提なら設計の見直し余地あり）。
- 入力サイズ制限の範囲（履歴/付加コンテキストの合計、KV/ログ等）を継続監視する必要。

### [高] プロンプト注入/ロール検証
- クライアント入力がロール混入（`system` 等）できない保証を、フロント/バックのどこで担保するか（現状のスキーマ/バリデーション設計の最終確認が必要）。

### [中] PDF/フォント/ファイル名周りの実機リスク
- PDF生成時のフォント取り扱いと、ダウンロードファイル名の禁止文字など、端末依存で失敗しやすい領域の実機確認が必要。

### [中] テストのカバレッジと運用
- `playwright` のスナップショットはOS差分が出るため、CI/開発端末の想定を決めたうえで管理方針（どの環境のスナップショットを正とするか）が必要。
