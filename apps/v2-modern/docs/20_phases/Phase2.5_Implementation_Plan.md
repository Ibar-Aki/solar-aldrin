# Phase 2.5 実装計画（体験速度・信頼性・可観測性）

- 作成日: 2026-02-02
- 作成者: Codex + GPT-5
- 更新日: 2026-02-02
- 対象資料: Phase2.5_Decision_Matrix.md

---

## 1. 目的と完了条件

**目的**

- 体感待ち時間の短縮、障害/品質の定量把握、運用の迅速化を実現する。

**完了条件**

- 主要エラーが即時検知され、リリース単位で追跡できる。
- 主要KPI（セッション完了率/所要時間/入力文字数）が日次で可視化される。
- Web Vitals（LCP/INP/CLS）の分布が日次で可視化される。
- 主要な障害が構造化ログで追跡可能。

---

## 2. 対象範囲

**採用（実装対象）**

- OPS-03: Sentry導入
- OPS-04: 構造化ログ（Workers Logs）
- OPS-05: KPI収集（段階的）
- OPS-06: Web Vitals計測
- OPS-07: AI信頼性モニタリング (New)
- Alternative: Loading Skeleton (OPS-01代替)

**対象外（今回不採用）**

- OPS-01: SSEストリーミング表示
- OPS-02: 天候APIキャッシュ

---

## 3. 共通方針

- 本番優先。ステージングはサンプリング率を低めにする。
- **個人情報(PII)は絶対に残さない**。ログの`content`等はマスク処理を行う。
- 監視/計測は「必要最小限」から開始し、運用で拡張する。
- 環境変数で容易に無効化できる設計にする。

---

## 4. 実装計画（詳細）

### 4.1 事前準備

**タスク**

- Sentry組織/プロジェクト作成（dev/stg/prod）
- 環境変数（SENTRY_DSN, ENV, RELEASE 等）整理
- 収集対象のイベント仕様（KPI/Web Vitals/ログ）の草案作成

**成果物**

- 設定一覧（環境変数/タグ設計）
- イベント仕様書（簡易版）

---

### 4.2 OPS-03: Sentry導入（最優先）

**タスク**

1) フロントSDK導入

- `environment`, `release`, `sampleRate`, `ignoreErrors` を設定
- Source Map連携（可能なら）

1) Workers SDK導入

- `fetch` ハンドラで例外捕捉・送信
- リクエストID/ルート/レイテンシーをタグ付け

1) 通知設定

- 重大エラーの通知先設定
- リリース単位のエラー比較

**成果物**

- フロント/WorkersのSentry初期化コード
- Sentryプロジェクト設定

**受け入れ条件**

- 意図的な例外がSentryに即時反映される
- 環境/リリースでフィルタリング可能

---

### 4.3 OPS-04: 構造化ログ（Workers Logs）

**ログスキーマ（例）**

- `timestamp`, `level`, `reqId`, `route`, `status`, `latencyMs`, `userHash`, `errorCode`
- **注意**: `message` や `input` に生データを含める際は、個人情報フィルタを通すこと。

**タスク**

1) ログユーティリティ作成（info/warn/error）
2) **PIIマスキング処理の実装**（名前、作業場所、具体的な会話内容を隠す）
3) API入口/出口に導入
4) 失敗時に詳細ログを残す
5) 高頻度ログはサンプリング率導入

**成果物**

- ログユーティリティ（Masking機能付き）
- ログ仕様書（簡易）

**受け入れ条件**

- 障害時にログのみで原因特定が可能
- **個人情報が含まれていないことを確認**

---

### 4.4 OPS-05: KPI収集（段階的）

**段階1（最小セット）**

- セッション完了率
- 所要時間（開始→完了）
- 入力文字数

**段階2（拡張）**

- 具体性スコア
- 再訪率/再利用率

**タスク**

- KPI定義書作成（定義/計測タイミング/集計方法）
- Workers経由で送信（Analytics Engine など）
- ダッシュボード作成

**成果物**

- KPI定義書
- 集計・可視化基盤

**受け入れ条件**

- 日次でKPIが確認できる

---

### 4.5 OPS-06: Web Vitals計測

**計測対象**

- LCP / INP / CLS

**タスク**

- `web-vitals` 導入
- 指標をKPI基盤へ送信
- デバイス/回線別に集計

**成果物**

- Web Vitals送信コード
- UX品質ダッシュボード

**受け入れ条件**

- LCP/INP/CLSの分布が日次で見える

---

### 4.6 OPS-07: AI信頼性モニタリング (New)

**計測対象**

- JSONパース失敗率
- Zodバリデーションエラー率
- OpenAI APIエラー率 (5xx)

**タスク**

- `workers/routes/chat.ts` のエラーハンドリング部に計測ロジック追加
- Sentryのカスタムタグ/コンテキストとして送信 (`error_type: validation_error`)

**成果物**

- 計測コード追加

**受け入れ条件**

- AIの回答フォーマット異常が即座に検知できる

---

### 4.7 UI改善: Loading Skeleton (OPS-01代替)

**タスク**

- AI応答待ち中の `LoadingSpinner` を、より体感速度を短く感じさせる `Skeleton` アニメーションに変更
- 「AIが考え中...」「回答を生成中...」などのステータス表示を動的にする

**成果物**

- Skeletonコンポーネント

**受け入れ条件**

- ユーザーがフリーズと勘違いしない視覚フィードバックがある

---

## 5. ロールアウト計画

**ステップ**

1) ステージングで導入・検証
2) 本番へ反映（環境変数でON/OFF）

**検証シナリオ**

- Sentry: 意図的エラー送信
- Logs: reqIdで追跡できる & **PIIが含まれていない**
- KPI: 正常/途中離脱の計測
- Web Vitals: モバイル/低速回線で値取得

**ロールバック**

- 環境変数で無効化
- SDK初期化停止

---

## 6. 将来再検討条件（参考）

- OPS-01（SSE）: 体感速度がKPIで改善しない場合
- OPS-02（天候キャッシュ）: APIコスト増大時

---

## 7. 進捗管理（推奨）

- 週次でKPI/エラー/ログのレビューを実施
- KPIの改善が鈍化したタイミングで次フェーズを検討
