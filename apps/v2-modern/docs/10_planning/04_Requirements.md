# 要件定義書 (Requirements Definition)

**準拠**: ISO/IEC/IEEE 29148  
**対象**: Voice KY Assistant v2 (Phase 2.0 - 2.5)  
**版**: 2.0  
**作成日**: 2026-01-27

---

## 1. はじめに

### 1.1 目的

本ドキュメントは、**03_Phase2ロードマップ** で採用決定された機能群を、具体的な開発要件（仕様）として定義するものです。
現場作業員が「自分ごと」として安全を意識できる質の高いKY活動を実現し、労働災害ゼロを目指します。

### 1.2 範囲 (Scope)

* **対象フェーズ**: Phase 2.1 (Security), 2.2 (UX/Refactoring), 2.3 (Data), 2.4 (Logic), 2.5 (Connect)
* **主な機能群**:
  * 運用防御（レート制限、入力検証） **[Phase 2.1 完了]**
  * 現場UX改善（手袋モード、フィラー演出） **[Phase 2.2 予定]**
  * AIによる深掘り、コーチング評価
  * 管理機能/外部連携

### 1.3 参照資料

* [01_品質改善提案](01_Quality_Improvement.md): 企画背景
* [03_Phase2ロードマップ](03_Phase2_Roadmap.md): 決定事項（※ 正本）
* [05_技術仕様書](05_Technical_Spec.md): アーキテクチャ詳細

---

## 2. システム機能要件 (System Requirements)

### 2.1 運用・セキュリティ (Phase 2.1: Security & Ops) [実装済]

| ID | 要件名 | 詳細仕様 | 優先度 |
| :--- | :--- | :--- | :--- |
| **FR-SEC-001** | **レート制限** | API乱用を防ぐため、IPアドレス毎に 30回/分 のリクエスト制限を設けること。 | High |
| **FR-SEC-002** | **入力検証** | 不正なプロンプト注入やコスト増大を防ぐため、文字数制限(1000字)と禁止語チェックを行うこと。 | High |
| **FR-SEC-003** | **Origin制限** | 未許可のオリジンからのAPI利用をブロックすること。 | High |

### 2.2 現場体験改善 (Phase 2.2: Field UX)

| ID | 要件名 | 詳細仕様 | 優先度 | 状態 |
| :--- | :--- | :--- | :--- | :--- |
| **FR-UX-001** | **フィラー演出** | 音声送信後、AIの思考中（最大5秒）に「了解。」「確認しています...」等の音声を再生し、通信不安を解消すること。 | High | **採用** |
| **FR-UX-002** | **手袋モード** | 画面下部50%をタッチエリアとし、誤タップを防ぐUIを提供すること。スワイプ操作（Cancel/Send）を実装すること。 | Low | **不採用** |
| **FR-UX-003** | **ハイブリッド入力** | AIの質問に対し、動的に生成された「回答候補チップ」を表示し、タップ入力も可能にすること。 | Med | **保留** |
| **FR-UX-006** | **PDF出力** | 完了したKY活動記録をPDFファイルとして生成・ダウンロード可能にする。 | High | **採用** |
| **FR-UX-007** | **音声認識** | ブラウザ標準API (`Web Speech API`) を使用した音声入力。将来的にGroq (Whisper) へ移行可能にする。 | High | **採用** |

### 2.3 AIロジック強化 (Phase 2.4: Deep Logic)

| ID | 要件名 | 詳細仕様 | 優先度 |
| :--- | :--- | :--- | :--- |
| **FR-LGC-001** | **具体化深掘り** | ユーザーの回答が抽象的な場合（文字数判定等）、5W1Hが揃うまで最大3回まで聞き返すロジックを実装すること。 | High |
| **FR-LGC-002** | **AIコーチング** | KY完了時に、S/A/B/Cの4段階評価と、改善アドバイスを提示すること。 | High |
| **FR-LGC-003** | **マンネリ防止** | 過去3回の作業内容と重複する場合、「今日はいつもと違う点はありませんか？」と逆張り質問を行うこと。 | Med |

### 2.3 管理・データ (Phase 2.3: Data & Mgmt)

| ID | 要件名 | 詳細仕様 | 優先度 |
| :--- | :--- | :--- | :--- |
| **FR-DAT-001** | **実施履歴参照** | 過去のKY記録をカレンダー形式で一覧表示し、PDFを再取得できること。 | Med |
| **FR-DAT-002** | **傾向分析** | 蓄積されたKYテキストから、頻出する「危険タグ」を抽出し、ダッシュボードに表示すること。 | Low |

### 2.4 外部連携 (Phase 2.4: Connect)

| ID | 要件名 | 詳細仕様 | 優先度 |
| :--- | :--- | :--- | :--- |
| **FR-EXT-001** | **気象連動** | OpenWeatherMap APIから現在地の天候を取得し、雨天・強風時はプロンプトに警告文脈を注入すること。 | Med |

---

## 3. 非機能要件 (Non-Functional Requirements)

### 3.1 ユーザビリティ (Usability)

* **NFR-USAB-01**: 明るい屋外でも視認できるコントラスト比（4.5:1以上）を確保すること。
* **NFR-USAB-02**: 全ての主要操作が片手（親指範囲）で完結すること。

### 3.2 性能 (Performance)

* **NFR-PERF-01**: アプリ起動時間（FCP）は 1.5秒以内 であること。
* **NFR-PERF-02**: 音声認識からAI応答開始までの体感レイテンシを 3秒以内 に抑えること（ストリーミング推奨）。

### 3.3 信頼性 (Reliability)

* **NFR-REL-01**: オフライン時（電波圏外）でもアプリがホワイトアウトせず、「電波の良い場所に移動してください」と表示されること。

---

## 4. インターフェース要件 (Interface Requirements)

### 4.1 画面レイアウト

* **Header**: 現場名、現在時刻、天候アイコン
* **Main**: チャットタイムライン（バブルUI）
* **Footer**: マイクボタン（大）、回答候補チップ（可変）、テキスト入力切り替え

### 4.2 API設計方針

* **Protocol**: Hono RPC (Type-safe JSON)
* **Auth**: Bearer Token (Phase 1/2), Supabase Auth (Phase 3)
* **Validation**: Zodによる厳格な型チェック

---

## 5. トレーサビリティマトリクス

| ロードマップID | 要件ID | 機能名 | 実装フェーズ |
| :--- | :--- | :--- | :--- |
| **O-00** | FR-SEC-001 | レート制限 | 2.1 (Done) |
| **O-00** | FR-SEC-002 | 入力検証 | 2.1 (Done) |
| **F-01** | FR-UX-001 | フィラー演出 | 2.2 |
| **F-02** | FR-UX-002 | 手袋モード | 2.2 |
| **F-04** | FR-UX-003 | ハイブリッド入力 | 2.2 |
| **L-01** | FR-LGC-001 | 具体化深掘り | 2.4 |
| **L-02** | FR-LGC-002 | AIコーチング | 2.4 (Hold) |
| **C-01** | FR-EXT-001 | 気象連動 | 2.3 |

