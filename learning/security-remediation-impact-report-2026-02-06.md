# Security Remediation & UIUX Impact Report (v2-modern)

- 作成日時: 2026-02-06 21:23:29 +09:00
- 作成者: Codex＋GPT-5
- 更新日: 2026-02-06（#4 API認証が任意運用の詳細を追記）
- 対象チェック: `C:\Users\AKIHIRO\.gemini\antigravity\playground\solar-aldrin\詳細セキュリティチェックリスト.md`
- 監査結果参照: `apps/v2-modern/docs/20_reviews/Security_Check_Report_2026-02-06.md`
- 目的: 指摘済み課題に対して、実施すべき対応、実施影響（技術/運用/コスト）、UI/UX影響を意思決定できる粒度で整理する
- 注意: 本書は「対応方針レポート」であり、コード修正は未実施

## 1. 結論（先に読む版）

- 最優先（P0）:
  - `API_TOKEN` 必須化（本番で未設定起動を禁止）
  - プロンプト注入耐性の強化（`system` への生連結を廃止）
  - `.dev.vars` 実キーの失効/再発行
  - `hono` を `4.11.7+` に更新
- 次点（P1）:
  - CORS allowlist を本番専用に絞る
  - レート制限のフェイルオープンを本番で禁止
  - 監視/アラート/監査ログの運用定義
- 中期（P2）:
  - IndexedDB保護（暗号化または再認証ゲート）
  - PDF共有時の漏えい抑止UX
  - IDaaS移行（Auth0/Supabase Auth）

## 2. 課題別の対応方針・影響・UI/UX影響

| # | 課題 | 現状根拠 | 推奨対応 | 未対応時リスク | 実施影響（技術/運用） | UI/UX影響 | 優先度 |
|---|---|---|---|---|---|---|---|
| 1 | HTTPS/TLS強制の証跡不足 | `docs/00_planning/06_システム設計書_System_Design.md:9` | Cloudflare側で `Always Use HTTPS` と HSTS を有効化し、設定証跡を運用手順へ追記 | 通信盗聴・改ざん | 設定作業のみ。アプリ改修は不要 | 体感変化なし | P1 |
| 2 | CORS許可範囲が広い | `workers/index.ts:73`, `workers/index.ts:74`, `workers/index.ts:75` | 本番は固定ドメインのみ許可、`*.workers.dev`/`*.ngrok-free.dev` は開発環境だけに分離 | 不要オリジンからAPI呼び出し | 環境別設定管理が必要。誤設定時は正規アクセスが403 | 誤設定時に接続不可。正しく設定すればUX影響ほぼなし | P1 |
| 3 | レート制限がフェイルオープン寄り | `workers/middleware/rateLimit.ts:66`, `workers/middleware/rateLimit.ts:91` | 本番では `RATE_LIMIT_KV` 未設定時に起動失敗、例外時は503返却 + 監視通知 | 攻撃/誤操作時のAPI枯渇 | 可用性より防御寄りへ。運用監視の整備が必要 | 429/503表示が増える可能性。待機導線は必要 | P1 |
| 4 | API認証が任意運用 | `workers/index.ts:157`, `README.md:37` | 本番は `API_TOKEN` 未設定ならデプロイブロック。`/api/metrics` も保護対象を検討 | 無認証アクセス成立 | デプロイ手順に必須チェック追加 | 設定不備時は利用不可。管理者向けエラー案内が必要 | P0 |
| 5 | IDaaS移行の具体化不足 | `docs/00_planning/06_システム設計書_System_Design.md:112` | Bearer固定トークンからユーザー単位JWTへ段階移行（併用期間を設ける） | 共通トークン運用のまま責任追跡が困難 | APIミドルウェア・クレーム設計の見直し | ログイン導線追加で初期摩擦は増えるが、セキュリティ安心感は向上 | P2 |
| 6 | 端末前提アクセス制御のみ | `src/lib/db.ts:21` | 端末共有/紛失想定で「再認証で履歴表示」「遠隔削除方針」を導入 | 端末盗難時に履歴閲覧 | 認証基盤またはローカル鍵管理が必要 | 履歴表示時に認証ステップ追加 | P2 |
| 7 | ローカル秘密情報に実キー存在 | `.dev.vars:1`, `.gitignore:27` | 当該キーを即時失効し再発行。ローカル秘密情報スキャン（pre-commit/CI）導入 | キー悪用による課金・情報漏えい | 運用ルール追加。短時間で対応可能 | UX影響なし | P0 |
| 8 | 環境変数の棚卸し不足 | `workers/index.ts:13`, `workers/index.ts:14`, `workers/index.ts:15` | 未使用変数の削除、環境変数台帳化、四半期レビュー | 不要キー漏えいで横展開侵害 | 運用文書整備が中心 | UX影響なし | P2 |
| 9 | Zod入力検証の維持運用 | `src/lib/schema.ts:46`, `workers/routes/chat.ts:50` | 既存維持 + 新API追加時はZod必須をPRチェック化 | 仕様逸脱データ混入 | 開発フローにチェック追加 | UX影響なし（品質は安定） | P2 |
|10| 音声入力サニタイズの強化余地 | `src/lib/schema.ts:9`, `src/hooks/useChat.ts:297` | サーバー側で正規化（改行/制御文字/不可視文字）、表示時エスケープを統一 | ログ汚染・想定外表示 | 正規化関数の共通化が必要 | 一部入力が自動補正される可能性 | P1 |
|11| AI応答構造化の維持運用 | `workers/routes/chat.ts:108`, `workers/routes/chat.ts:130` | JSON応答 + Zod検証を維持。失敗率を監視指標化 | 形式崩れでUI破損 | 監視追加のみ | UX影響なし（障害時の安定度向上） | P2 |
|12| IndexedDB保護不足 | `src/lib/db.ts:16`, `src/lib/db.ts:21` | 端末内暗号化（WebCrypto）または履歴表示時PIN認証を導入 | 端末盗難時の情報漏えい | 実装難度中。鍵管理方針が必要 | 履歴アクセスでワンステップ増加 | P2 |
|13| PDF共有統制不足 | `src/hooks/usePDFGenerator.tsx:42` | ダウンロード前に機密注意モーダル、透かし、共有時注意文を追加 | PDF二次拡散 | 実装は軽量。運用教育も必要 | ダウンロード前の確認ステップが増える | P1 |
|14| ログ/計測のPII統制が不十分 | `workers/routes/metrics.ts:49`, `workers/observability/logger.ts:6` | ログ共通マスキング関数導入、禁止キー（name/site/phone等）を自動除去 | ログ経由の情報漏えい | ログ基盤の横断修正が必要 | UX影響なし | P1 |
|15| OpenAIデータ保持設定の証跡不足 | `docs/00_planning/06_システム設計書_System_Design.md:118` | OpenAI Data Controls画面の設定証跡を運用資料化。組織/プロジェクト単位で保持方針を固定 | コンプライアンス説明不能 | 文書/監査対応の整備が中心 | UX影響なし | P1 |
|16| プロンプト注入対策不足 | `workers/routes/chat.ts:83`, `workers/routes/chat.ts:88` | `system`を固定し、外部入力は `user` メッセージで境界分離。`sessionContext` は構造化してルール化 | 指示改ざん・情報漏えい誘発 | プロンプト設計見直しと評価テストが必要 | 文脈追従の挙動が少し変わる可能性 | P0 |
|17| エラー分類はあるが運用連携が弱い | `src/hooks/useChat.ts:65`, `workers/index.ts:116` | エラーコード一覧を運用Runbookに接続し、一次対応手順を固定化 | 障害時の対応遅延 | 文書整備中心 | ユーザー向け文言が一貫し、混乱減少 | P1 |
|18| 再試行ポリシーが弱い | `workers/lib/openai.ts:21` | `MAX_RETRIES=2~3` + 指数バックオフ + ジッター。クライアント再送と重複しない制御に統一 | 一時障害で失敗率上昇 or 無駄再送 | API待ち時間は微増、成功率は改善 | 待機時間表示が必要（体感はやや遅くなる） | P1 |
|19| 依存脆弱性（Hono） | `package-lock.json`, `npm audit --omit=dev --json` | `hono` を `4.11.7+` へ更新し回帰テスト実施 | 既知脆弱性が残留 | 小〜中規模の依存更新対応 | UX影響ほぼなし | P0 |
|20| デプロイ改ざん対策の証跡不足 | `docs/10_manuals/03_OPS_GUIDE.md` | Cloudflare権限最小化、2FA、デプロイ承認フロー、監査ログ保持期間を定義 | 不正デプロイ検知不能 | 運用設計の見直し | UX影響なし | P1 |
|21| 監視/アラート定義の不足 | `workers/routes/metrics.ts:48`, `docs/10_manuals/03_OPS_GUIDE.md:63` | しきい値（429率/5xx率/タイムアウト率）と通知先を定義 | 障害長期化 | 監視設定と当番運用が必要 | 障害復旧が早まりUX改善 | P1 |
|22| 監査ログ保全不足 | `workers/index.ts:97`, `workers/index.ts:118` | トークンID（ハッシュ）単位のアクセス追跡、保存期間・検索手順を規定 | 事故調査が困難 | ログ項目と保管ルール追加 | UX影響なし | P1 |

## 3. UI/UX影響を先回りして吸収する設計ポイント

1. 認証必須化の影響吸収
- 画面上で「設定不足（管理者対応が必要）」を明示し、再試行ボタンではなく設定手順への導線を出す。
- 対象箇所: `src/hooks/useChat.ts:240`, `src/pages/CompletionPage.tsx:109`

2. レート制限/再試行強化の影響吸収
- `Retry-After` を秒数カウントダウン表示し、連打抑止をUIで補助する。
- 対象箇所: `src/hooks/useChat.ts:100`, `src/lib/api.ts:78`

3. CORS厳格化の影響吸収
- 利用不可時に「許可されていないドメイン」を表示し、管理者へ渡す情報（Origin値）を出す。

4. PDF統制追加の影響吸収
- ダウンロード前確認モーダルは1タップで閉じられる設計にし、毎回の手間を最小化する。
- 対象箇所: `src/hooks/usePDFGenerator.tsx:42`

5. プロンプト注入対策の影響吸収
- 返答の自然さが落ちないかを会話テストで確認し、必要なら表示文言を調整する。

## 4. 実施順序（実装時の推奨ロードマップ）

### Phase P0（1〜3日）

- 秘密鍵失効・再発行（`.dev.vars` 由来）
- 本番 `API_TOKEN` 未設定ブロック
- `hono` 更新（`4.11.7+`）
- プロンプト注入の緊急ハードニング（system生連結の停止）

### Phase P1（3〜10日）

- CORS本番最小化
- レート制限のフェイルクローズ化
- 再試行戦略の標準化（サーバー/クライアント）
- 監視/アラート/監査ログ運用を整備
- ログPIIマスキングの横断適用
- PDF共有注意喚起のUI追加

### Phase P2（2〜6週）

- IDaaS導入（段階移行）
- IndexedDBの保護強化（暗号化 or 再認証）
- 端末紛失対応（遠隔ワイプ含む運用設計）

## 5. OpenAIデータ保持項目の最新確認（2026-02-06時点）

- 公式資料: `https://platform.openai.com/docs/guides/your-data`
- 重要点（本件への影響）:
  - APIデータは既定で学習に使われない（明示オプトイン時を除く）
  - Abuse monitoring logs は既定で最長30日保持
  - ZDR/Modified Abuse Monitoring は事前承認制
  - `/v1/chat/completions` と `/v1/responses` は ZDR 時 `store=false` 強制
- 対応方針:
  - 「設定したつもり」ではなく、組織/プロジェクトの Data Controls 設定画面の証跡を運用ドキュメント化する

## 6. 受け入れ基準（実装開始時のDefinition of Done）

- セキュリティ
  - 本番で `API_TOKEN` 未設定デプロイが不可能
  - `system` プロンプトへ外部入力の生連結がない
  - `hono` 脆弱性が `npm audit --omit=dev` で解消
- 運用
  - 429/5xx/timeout のしきい値アラートが定義済み
  - 監査ログの保存期間・検索手順が明文化
- UX
  - 認証エラー・レート制限時の案内文が一貫
  - PDF共有前注意喚起が導入され、誤操作率を計測可能

## 7. 詳細解説: #4 API認証が任意運用

### 7.1 現状の実装と何が起きているか

- `workers/index.ts:157` で `validToken = c.env.API_TOKEN` を読み取り、`workers/index.ts:159` で「`validToken` が存在する時だけ」照合している。
- このため `API_TOKEN` が未設定だと、`/api/chat` と `/api/feedback` は実質的に無認証で通る。
- `README.md:37` も `API_TOKEN` を「任意」と記載しており、運用上の設定漏れが起きやすい。
- フロント側には補助チェックがある（`src/hooks/useChat.ts:240`）が、クライアント制御は回避可能であり防御境界にはならない。

### 7.2 リスクの本質

- 無認証アクセス成立による API 乱用（課金増大、正規ユーザーの遅延/失敗）。
- 共通トークン運用のままだと利用者単位の追跡性が弱く、インシデント調査が難しい。
- 設定漏れを検知できない運用では「本番だけ開いていた」事故が起きる。

### 7.3 推奨対応（実装観点）

1. 本番のデプロイ前チェックで `API_TOKEN` 未設定をエラーにする。
2. ランタイムでも本番未設定なら `/api/*` を 503 で拒否し、起動成功扱いにしない。
3. `README.md` と運用手順を「本番必須」に改訂する（任意表現を廃止）。
4. `/api/metrics` の認証除外（`workers/index.ts:149`）は再設計する。
5. 中期的には固定トークンから IDaaS/JWT に移行し、ユーザー単位認証へ段階移行する。

### 7.4 実施影響（技術・運用・コスト）

- 技術影響:
  - ミドルウェア条件分岐とデプロイ前検証の追加が必要。
  - 監視項目に「認証設定不備」を追加する必要がある。
- 運用影響:
  - トークン配布、保管、ローテーション手順を標準化する必要がある。
  - 本番反映前チェックリストに `API_TOKEN` 確認を追加する必要がある。
- コスト影響:
  - 乱用トラフィック抑制により OpenAI 利用コストの予測精度が上がる。

### 7.5 UI/UX影響

- 正の影響:
  - 設定不備時の原因が明確になり、現場ユーザーが再送を繰り返す無駄が減る。
- 負の影響:
  - 設定漏れ時は即利用不可になるため、初期導入時に運用ハンドオフが必須。
- 吸収策:
  - `src/hooks/useChat.ts:240` と `src/pages/CompletionPage.tsx:109` の認証エラー文言を統一し、管理者向け対処手順への導線を表示する。

### 7.6 判断基準（この課題が解消したと言える状態）

- 本番で `API_TOKEN` が空の場合、デプロイが失敗する。
- 本番稼働中に `API_TOKEN` が無効化された場合、`/api/chat` と `/api/feedback` は拒否される。
- 運用ドキュメントに「必須設定」「ローテーション」「障害時手順」が明記される。

---

以上を「実装前提の判断資料」として利用してください。実装着手時は P0 から順に行うと、セキュリティ効果と現場UXのバランスが最も良くなります。
